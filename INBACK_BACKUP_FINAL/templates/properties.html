{% extends "base.html" %}

{% block title %}Кэшбек за новостройки в Краснодаре до 500 000 ₽ | inback{% endblock %}
{% block description %}Как получить кэшбек 2,5-10% за новостройку? Пошаговая инструкция работы сервиса Inback. Официальный возврат денег от застройщика при покупке квартиры в Краснодаре{% endblock %}
{% block keywords %}как получить кэшбек за квартиру, кэшбек за новостройку, возврат денег за квартиру, система кэшбека inback, оформление кэшбека, этапы получения кэшбека{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    /* Mobile-specific styles */
    @media (max-width: 640px) {
        .property-card {
            margin-bottom: 12px;
        }
        .property-card .carousel {
            height: 160px;
        }
        .property-card .carousel-item img {
            height: 160px;
            object-fit: contain;
            background: #f8f9fa;
        }
        .property-card .carousel-controls {
            display: none;
        }
    }

    /* Compact dropdown menu */
    .dropdown {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-btn {
        background: transparent;
        border: none;
        color: #141A24;
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .dropdown-btn:hover {
        background: rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-btn svg {
        width: 16px;
        height: 16px;
        transition: transform 0.2s;
    }
    
    .dropdown-btn.open svg {
        transform: rotate(180deg);
    }
    
    .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 0.5rem 0;
        min-width: 200px;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .dropdown-menu .dropdown-section {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .dropdown-menu .dropdown-section:last-child {
        border-bottom: none;
    }
    
    .dropdown-menu .dropdown-section h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 0.5rem;
    }
    
    .dropdown-menu .filter-option {
        display: flex;
        align-items: center;
        padding: 0.375rem 0;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .dropdown-menu .filter-option:hover {
        color: #0088CC;
    }
    
    .dropdown-menu .filter-option input[type="checkbox"] {
        margin-right: 0.5rem;
        width: 16px;
        height: 16px;
        accent-color: #0088CC;
    }
    
    .dropdown-menu .price-inputs {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
    }
    
    .dropdown-menu .price-inputs input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        outline: none;
    }
    
    .dropdown-menu .price-inputs input:focus {
        border-color: #0088CC;
        box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-menu .apply-price-btn {
        background: #0088CC;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        margin: 0.5rem 1rem 0;
        transition: opacity 0.2s;
    }
    
    .dropdown-menu .apply-price-btn:hover {
        opacity: 0.9;
    }
    
    /* Active filter chips */
    .active-filter-chip {
        display: inline-flex;
        align-items: center;
        background: #0088CC;
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        gap: 0.5rem;
        margin: 0.25rem;
    }
    
    .active-filter-chip .remove-btn {
        width: 18px;
        height: 18px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        transition: background 0.2s;
    }
    
    .active-filter-chip .remove-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* Beautiful Filter Button Styles */
    .filter-option-btn {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        position: relative;
    }

    .filter-option-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn.active {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #1d4ed8;
    }

    .filter-option-btn.active svg {
        color: #3b82f6;
    }

    /* Quick Filter Dropdown Styles */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 200px;
        padding: 0.5rem;
        margin-top: 0.25rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.15s;
        font-size: 0.875rem;
    }

    .dropdown-item:hover {
        background-color: #f3f4f6;
    }

    /* Filter counter badge */
    .filter-counter {
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.5rem;
    }
    
    /* Toggle switches */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #0088CC;
        background-color: #0088CC;
    }
    
    .toggle-checkbox:checked + .toggle-label {
        background-color: #0088CC;
    }
    
    .toggle-label {
        transition: background-color 0.2s;
    }
    
    /* Hide unsupported advanced filters based on user feedback */
    .filter-dropdown[data-filter="property_class"],
    .filter-dropdown[data-filter="wall_material"],
    .filter-dropdown[data-filter="floors_total"],
    .filter-dropdown[data-filter="window_view"],
    .filter-dropdown[data-filter="cardinal_direction"],
    .filter-dropdown[data-filter="apartment_category"],
    .filter-dropdown[data-filter="entrance_access"],
    .filter-dropdown[data-filter="panoramic"],
    .filter-dropdown[data-filter="developer_pv"],
    .filter-dropdown[data-filter="mortgage_types"],
    .filter-dropdown[data-filter="escrow"],
    .filter-dropdown[data-filter="property_rights_cost"],
    .filter-dropdown[data-filter="direction"],
    .filter-dropdown[data-filter="registration"],
    .filter-dropdown[data-filter="nearby_places"] {
        display: none !important;
    }
    
    /* Hide sections if they become empty */
    .space-y-3:has(.filter-dropdown:not([style*="display: none"]):only-child) {
        min-height: 100px;
    }
    
    /* Hide specific quick filter buttons by unique selectors */
    button[data-filter="distance"]:not(:only-child) {
        /* Keep "До центра" - it's supported */
    }
    
    /* More specific approach: manually hide unsupported buttons by finding parent containers */
    /* This will be handled by JavaScript after page load for better compatibility */
</style>
{% endblock %}

{% block breadcrumbs %}
<!-- Breadcrumbs -->
<div class="container mx-auto px-4 py-3 text-sm">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{{ url_for('index') }}" class="text-[#0088CC] hover:underline inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    Главная
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="text-gray-500 ml-1 md:ml-2">Поиск объектов</span>
                </div>
            </li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Advanced Search Form -->
<section id="properties" class="py-20 bg-white">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center mb-6">10 000+ квартир в базе</h2>
        <p class="text-xl text-gray-600 text-center mb-12">Подберите идеальную квартиру в Краснодаре с максимальным кэшбэком</p>
    </div>
</section>

<!-- Search Block -->
<section class="py-8 bg-gray-50">
    <div class="container mx-auto px-4">
        <!-- Enhanced Smart Search Bar -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 mb-4">
            <!-- Search Input Row -->
            <div class="flex flex-col lg:flex-row gap-3 items-center">
                <!-- Enhanced Search Input -->
                <div class="flex-1 relative">
                    <input type="text" 
                           id="property-search"
                           placeholder="Умный поиск: район, застройщик, ЖК, тип квартиры..." 
                           class="w-full pl-4 pr-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500 outline-none transition-all text-gray-700">
                    <!-- ✅ УДАЛЕНО: Enhanced Search Suggestions - SuperSearch создает свой dropdown -->
                    <!-- <div id="property-searchSuggestions" ...> ОТКЛЮЧЕН </div> -->
                </div>
                <!-- Search Results Info -->
                <div class="text-sm text-gray-500">
                    Поиск с подсказками
                </div>
            </div>
        </div>

        <!-- Quick Filters -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3">
            <div class="flex items-center gap-3 text-sm">
                <div class="text-gray-600 whitespace-nowrap font-medium">Быстрые фильтры</div>
                
                <!-- Quick Filter Buttons -->
                <div class="flex flex-wrap gap-2">
                    <!-- Room Type Filter -->
                    <div class="dropdown" data-filter="rooms">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="roomsFilterText">Комнат</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="студия" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> Студия
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="1-комн" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> 1-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2-комн" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> 2-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="3-комн" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> 3-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="4+-комн" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()"> 4-комнатная
                            </label>
                        </div>
                    </div>
                    
                    <!-- Price Filter -->
                    <div class="dropdown" data-filter="price">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="priceFilterText">Цена</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu" style="min-width: 280px;">
                            <div class="p-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">От, млн ₽</label>
                                        <input type="number" id="priceFrom" placeholder="1" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">До, млн ₽</label>
                                        <input type="number" id="priceTo" placeholder="20" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                </div>
                                <button onclick="applyPriceFilter()" class="w-full bg-[#0088CC] text-white py-2 rounded mt-3 text-sm hover:opacity-90">Применить</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Region Filter -->
                    <div class="dropdown" data-filter="regions">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="regionFilterText">Регион</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="Краснодарский край" data-filter-type="region" class="mr-2" onchange="handleRegionFilterChange()"> Краснодарский край (362)
                            </label>
                        </div>
                    </div>
                    
                    <!-- City Filter -->
                    <div class="dropdown" data-filter="cities">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="cityFilterText">Город</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="Сочи" data-filter-type="city" class="mr-2" onchange="handleCityFilterChange()"> Сочи (354)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Краснодар" data-filter-type="city" class="mr-2" onchange="handleCityFilterChange()"> Краснодар (8)
                            </label>
                        </div>
                    </div>
                    
                    <!-- Developer Filter -->
                    <div class="dropdown" data-filter="developers">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="developerFilterText">Застройщик</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="ГК Неометрия" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> ГК Неометрия (216)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="AVA" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> AVA (53)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="ЦЕНТРАЛЬНАЯ ИНВЕСТИЦИОННАЯ КОМПАНИЯ" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> ЦИК (32)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="СЗ КАСКАД" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> СЗ КАСКАД (15)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="ТОЧНО" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> ТОЧНО (18)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="СПЕЦИАЛИЗИРОВАННЫЙ ЗАСТРОЙЩИК КОРОНА" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> СЗ КОРОНА (16)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="ООО СЗ \"СТРОЙИНЖИНИРИНГ\"" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> СТРОЙИНЖИНИРИНГ (2)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="ГрадРиэлт" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> ГрадРиэлт (2)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Тестовый" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> Тестовый (1)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Тестовый 1" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> Тестовый 1 (1)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Тестовый 11" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> Тестовый 11 (1)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Тестовый 123" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> Тестовый 123 (1)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Тестовый 2" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> Тестовый 2 (1)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Тестовый 22" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> Тестовый 22 (1)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Тестовый 3" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> Тестовый 3 (1)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="Тестовый 33" data-filter-type="developer" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> Тестовый 33 (1)
                            </label>
                        </div>
                    </div>
                    
                    <!-- Completion Date Filter -->
                    <div class="dropdown" data-filter="completion">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1">
                            <span id="completionFilterText">Сдача</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="2024" data-filter-type="completion" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> 2024 (51)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2025" data-filter-type="completion" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> 2025 (317)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2026" data-filter-type="completion" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> 2026 (72)
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2028" data-filter-type="completion" class="mr-2" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();"> 2028 (22)
                            </label>
                        </div>
                    </div>
                    
                    <!-- Modern Advanced Filters -->
                    <button id="advancedFiltersToggle" class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-1 relative transition-all duration-200 hover:border-[#0088CC] group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-gray-500 group-hover:text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                        </svg>
                        <span class="font-medium">Еще</span>
                        <div id="advancedFiltersCounter" class="hidden absolute -top-1 -right-1 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">0</div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-1 transition-transform duration-200 group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="advancedFiltersArrow">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    
                    <!-- Search Button -->
                    <button id="applyFiltersBtn" onclick="applyFiltersFixed()" class="px-4 py-1.5 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white font-medium rounded hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-sm hover:shadow-md whitespace-nowrap text-sm">
                        <i class="fas fa-search mr-1"></i>
                        Найти
                    </button>

                    <!-- Save Search Button -->
                    <div class="relative">
                        <button id="saveSearchBtn" onclick="toggleSaveSearchDropdown()" class="px-3 py-1.5 border border-[#0088CC] text-[#0088CC] rounded hover:bg-[#0088CC] hover:text-white transition-all duration-300 whitespace-nowrap text-sm" title="Сохранить поиск">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        
                        <!-- Save Search Dropdown -->
                        <div id="saveSearchDropdown" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 min-w-72">
                            <div class="p-3">
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Название поиска</label>
                                    <input type="text" id="searchNameInput" placeholder="Название поиска" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-[#0088CC] focus:border-[#0088CC]">
                                </div>
                                
                                {% if current_user.is_authenticated and current_user.role == 'manager' %}
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email клиента (опционально)</label>
                                    <input type="email" id="clientEmailInput" placeholder="client@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-[#0088CC] focus:border-[#0088CC]">
                                    <p class="text-xs text-gray-500 mt-1">Если указан, поиск будет отправлен клиенту</p>
                                </div>
                                {% endif %}
                                
                                <div class="flex gap-2">
                                    <button onclick="saveSearchWithOptions()" class="flex-1 px-3 py-2 bg-[#0088CC] text-white rounded-md text-sm hover:bg-[#0077BB] transition">
                                        Сохранить
                                    </button>
                                    <button onclick="closeSaveSearchDropdown()" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50 transition">
                                        Отмена
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Counter -->
                    <div class="text-gray-600 px-3 py-1.5 whitespace-nowrap text-sm">
                        <span id="resultsCounter" class="font-medium">{{ pagination.total }} объектов</span>
                    </div>
                </div>
                

            </div>
            
            <!-- ✅ ИСПРАВЛЕН: Блок активных фильтров с правильными ID -->
            <div id="active-filters" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-200 p-3 mt-4">
                <div class="flex flex-wrap items-center gap-3">
                    <span class="text-sm font-medium text-gray-700 flex items-center">
                        <i class="fas fa-filter text-blue-600 mr-2"></i>
                        Активные фильтры:
                    </span>
                    <div id="active-filters-list" class="flex flex-wrap gap-2">
                        <!-- Active filters will be inserted here by JavaScript -->
                    </div>
                    <button id="clearAllFilters" class="text-sm bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-full transition-all font-medium" onclick="console.log('✅ ОЧИСТИТЬ ВСЕ - перенаправляем на /properties'); window.location.href='/properties'; return false;">
                        <i class="fas fa-times mr-1"></i>
                        Очистить все
                    </button>
                </div>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div id="advancedFiltersPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#0088CC] mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-800">Расширенные фильтры</h3>
                            <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Pro</span>
                        </div>
                        <button id="closeAdvancedFilters" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                        
                        <!-- Параметры недвижимости -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                                </svg>
                                Параметры
                            </h4>
                            
                            <!-- Площадь -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Площадь, м²</label>
                                <div class="flex gap-2">
                                    <input type="number" id="areaFrom" placeholder="от" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="areaTo" placeholder="до" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                            
                            <!-- Этаж -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Этаж</label>
                                <div class="flex gap-2">
                                    <input type="number" id="floorFrom" placeholder="от" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="floorTo" placeholder="до" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                            
                            <!-- Максимальный этаж -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Этажность дома</label>
                                <div class="flex gap-2">
                                    <input type="number" id="maxFloorFrom" placeholder="от" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="maxFloorTo" placeholder="до" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Характеристики -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Характеристики
                            </h4>
                            
                            <!-- Класс недвижимости -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Класс недвижимости</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="Бизнес" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">Бизнес</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="Комфорт" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">Комфорт</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="Премиум" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">Премиум</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Отделка -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Отделка</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="Без отделки" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">Без отделки</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="Чистовая" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">Чистовая</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Дополнительные условия -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                                </svg>
                                Условия
                            </h4>
                            
                            <!-- Ипотека и финансы -->
                            <div class="space-y-2">
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="accreditation" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Аккредитация банков</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="green_mortgage" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Льготная ипотека</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="government_program" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Господдержка</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="trade_in" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Trade-in</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Расположение и дата -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                </svg>
                                Расположение
                            </h4>
                            
                            <!-- Год сдачи -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Год сдачи</label>
                                <div class="flex gap-2">
                                    <input type="number" id="buildYearFrom" placeholder="от" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                    <input type="number" id="buildYearTo" placeholder="до" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                </div>
                            </div>
                            
                            <!-- Статус сдачи -->
                            <div class="space-y-2">
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="true" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Сданный дом</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="false" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">В строительстве</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <div class="flex gap-3 justify-end">
                            <button id="resetAdvancedFilters" onclick="resetAdvancedFilters(); filterProperties(); displayActiveFilters();" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200 font-medium">
                                Сбросить
                            </button>
                            <button id="applyAdvancedFilters" onclick="filterProperties(); displayActiveFilters(); updateAdvancedFiltersCounter();" class="px-8 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg hover:shadow-xl font-medium flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Применить фильтры
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    

<!-- Main Content Section -->
<section class="container mx-auto px-4 py-6">
    <div class="w-full mx-auto">
        <!-- Results Header -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">
                    {% if results_text %}
                        {{ results_text }}
                    {% else %}
                        Найдено <span id="results-count">{{ total_properties or 0 }}</span> 
                        {% set count = total_properties or 0 %}
                        {% if count % 100 in [11, 12, 13, 14] %}объектов
                        {% elif count % 10 == 1 %}объект
                        {% elif count % 10 in [2, 3, 4] %}объекта
                        {% else %}объектов{% endif %}
                    {% endif %}
                </h3>
                <div class="flex gap-2">
                    <select id="sort-select" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="sortProperties()">
                        <option value="" disabled selected>Сортировать</option>
                        <option value="price-desc">По цене ↓</option>
                        <option value="price-asc">По цене ↑</option>
                        <option value="area-desc">По площади ↓</option>
                        <option value="area-asc">По площади ↑</option>
                        <option value="date-desc">По дате</option>
                    </select>
                    
                    <!-- View Toggle -->
                    <div class="flex items-center bg-gray-100 rounded-lg p-1">
                        <button onclick="switchToListView()" data-view="list" class="flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                            </svg>
                            Список
                        </button>
                        <button onclick="switchToGridView()" data-view="grid" class="flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                            </svg>
                            Сетка
                        </button>
                    </div>
                    
                    <a href="{{ url_for('map_view') }}" class="text-[#0088CC] hover:text-[#0077BB] flex items-center px-3 py-2 border border-[#0088CC] rounded-lg text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        Поиск по карте
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- Properties Cards Section -->
<section class="py-8 bg-white">
    <div class="container mx-auto px-4">
        <div class="bg-gray-50 rounded-xl shadow-md border border-gray-200 p-6">

                <!-- Property Cards -->
                <div id="properties-container" class="space-y-6">
                    {% for property in properties[:20] %}
                    <!-- Property Card (Original Design) -->
                    <div class="property-card bg-white rounded-lg shadow-sm overflow-hidden w-full flex flex-col md:flex-row" 
                         data-type="{{ property.type }}" 
                         data-rooms="{{ property.rooms }}" 
                         data-price="{{ property.price }}" 
                         data-district="{{ property.district }}" 
                         data-developer="{{ property.developer }}"
                         data-complex="{{ property.residential_complex or 'Не указан' }}"
                         data-property-type="{{ property.property_type or property.type }}"
                         data-completion="{{ property.completion_date or '2024' }}"
                         data-area="{{ property.area }}"
                         data-floor="{{ property.floor }}"
                         data-mortgage="{{ property.mortgage_available|default('true') }}"
                         data-installment="{{ property.installment_available|default('false') }}"
                         data-maternal-capital="{{ property.maternal_capital|default('false') }}"
                         data-trade-in="{{ property.trade_in|default('false') }}"
                         data-cashback="{{ property.cashback_available|default('true') }}">
                        <!-- Image Carousel - WIDER -->
                        <div class="w-full md:w-96 h-64 relative group flex-shrink-0">
                            <div class="carousel-container w-full h-full relative overflow-hidden rounded-lg bg-gray-100" data-property-id="{{ property.id }}">
                                <!-- Image slides -->
                                {% if property.gallery and property.gallery|length > 0 %}

                                    {% for image in property.gallery[:4] %}
                                    <div class="carousel-slide absolute inset-0 {% if loop.index0 > 0 %}opacity-0{% endif %} transition-opacity duration-300" data-slide="{{ loop.index0 }}">
                                        <img src="{{ image }}" 
                                             alt="{% if property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комн{% endif %} {{ property.area }} м² - фото {{ loop.index }}" 
                                             class="w-full h-full object-cover bg-gray-200" 
                                             loading="lazy"
                                             onerror="console.warn('Image load failed:', this.src); this.style.display='block'; this.style.backgroundColor='#f3f4f6'; this.innerHTML='<div class=\'flex items-center justify-center h-full text-gray-500\'>Фото недоступно</div>';">
                                    </div>
                                    {% endfor %}
                                {% else %}

                                    <div class="carousel-slide absolute inset-0 transition-opacity duration-300" data-slide="0">
                                        <img src="{{ property.image or 'https://via.placeholder.com/400x300/f3f4f6/9ca3af?text=Фото+недоступно' }}" 
                                             alt="{% if property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комн{% endif %} {{ property.area }} м²" 
                                             class="w-full h-full object-cover bg-gray-200" 
                                             loading="lazy"
                                             onerror="console.warn('Main image load failed:', this.src); this.style.backgroundColor='#f3f4f6';">
                                    </div>
                                {% endif %}
                                
                                <!-- Navigation arrows -->
                                <button onclick="prevImageSlide(this)" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                    </svg>
                                </button>
                                <button onclick="nextImageSlide(this)" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </button>
                                
                                <!-- Dots indicator -->
                                <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    {% set gallery_length = property.gallery|length if property.gallery else 1 %}
                                    {% set max_slides = [gallery_length, 4]|min %}
                                    {% for i in range(max_slides) %}
                                    <button onclick="goToImageSlide(this, {{ i }});" class="w-2.5 h-2.5 rounded-full {% if i == 0 %}bg-white/80{% else %}bg-white/50{% endif %} hover:bg-white transition-colors"></button>
                                    {% endfor %}
                                </div>
                            </div>
                            <!-- Overlay elements -->
                            <div class="absolute top-3 right-3 z-20 flex gap-2">
                                <div class="favorite-heart" data-property-id="{{ property.id }}" title="Добавить в избранное" onclick="if(window.favoritesManager) { window.favoritesManager.toggleFavorite('{{ property.id }}', this); event.stopPropagation(); }">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="comparison-btn w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer transition-all" data-property-id="{{ property.id }}" title="Добавить к сравнению" onclick="toggleComparison('{{ property.id }}', this); event.stopPropagation();">
                                    <i class="fas fa-balance-scale text-gray-600 text-base"></i>
                                </div>
                                <a href="{{ url_for('property_pdf', property_id=property.id) }}" target="_blank" class="w-10 h-10 bg-orange-500 hover:bg-orange-600 rounded-full flex items-center justify-center shadow-md cursor-pointer transition-all" data-property-id="{{ property.id }}" title="Скачать PDF" onclick="event.stopPropagation();">
                                    <i class="fas fa-file-pdf text-white text-base"></i>
                                </a>
                            </div>
                            <div class="absolute top-3 left-3 bg-[#FF5722] text-white text-xs font-semibold px-2 py-1 rounded z-20">
                                Кэшбек 5%
                            </div>
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-1 p-6">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <a href="{{ url_for('property_detail', property_id=property.id) }}" class="text-xl font-semibold hover:text-[#0088CC] transition">
                                        {% if property.rooms == 0 %}Студия{% elif property.type == 'пентхаус' %}Пентхаус{% elif property.type == 'апартаменты' %}Апартаменты{% elif property.type == 'таунхаус' %}Таунхаус{% elif property.type == 'дом' %}Дом{% else %}{{ property.rooms }}-к. квартира{% endif %}, {{ property.area }} м², {{ property.floor }}/{{ property.total_floors }} эт.
                                    </a>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <div class="text-gray-600 text-sm space-y-1">
                                            <p class="flex items-center">
                                                <svg class="w-4 h-4 text-[#0088CC] mr-2" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                                </svg>
                                                <a href="#" class="hover:text-[#0088CC] hover:underline">{{ property.residential_complex or property.complex_name or 'Не указан' }}</a>
                                            </p>
                                            <p class="flex items-center">
                                                <svg class="w-4 h-4 text-[#0088CC] mr-2" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                                </svg>
                                                {{ property.address if property.address else '-' }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="flex flex-col items-end">
                                        {% if property.price and property.price > 0 %}
                                        <span class="text-sm text-gray-500 line-through">{{ "{:,.0f}".format(property.price + (property.price * 0.05)) }} ₽</span>
                                        <span class="property-price text-xl font-bold text-[#FF5722]">{{ "{:,.0f}".format(property.price) }} ₽</span>
                                        <span class="text-xs text-gray-500">(5% кэшбек {{ "{:,.0f}".format(property.price * 0.05) }} ₽)</span>
                                        {% else %}
                                        <span class="property-price text-xl font-bold text-gray-500">Цена по запросу</span>
                                        {% endif %}
                                    </div>
                                    {% if property.square_price %}
                                    <span class="text-sm text-gray-500">{{ "{:,.0f}".format(property.square_price) }} ₽/м²</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="grid ${isGridView ? 'grid-cols-1 gap-2 mb-3' : 'grid-cols-2 md:grid-cols-3 gap-3 mb-6'}">
                                <!-- Compact info row -->
                                <div class="${isGridView ? 'grid grid-cols-2 gap-2 mb-2 pb-2 border-b border-gray-200' : 'col-span-2 md:col-span-3 grid grid-cols-3 gap-3 mb-3 pb-2 border-b border-gray-200'}">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 bg-gray-200 rounded-full mr-2 flex items-center justify-center text-xs font-bold text-gray-600">
                                            {{ property.developer[:3].upper() }}
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">Застройщик</div>
                                            <div class="font-semibold text-sm">{{ property.developer }}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500 text-xs">Этажность</div>
                                        <div class="font-semibold text-sm">{{ property.floor }}/{{ property.total_floors }}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500 text-xs">Ипотека от</div>
                                        <div class="font-semibold text-sm">{{ property.mortgage_rate }}</div>
                                    </div>
                                </div>
                                
                                <!-- Project details row -->
                                <div class="flex items-center col-span-1">
                                    <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
                                    </svg>
                                    <div>
                                        <div class="text-gray-500 text-xs">Площадь</div>
                                        <div class="font-semibold text-sm">{{ property.area }} м²</div>
                                    </div>
                                </div>
                                <div class="flex items-center col-span-1">
                                    <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                    </svg>
                                    <div>
                                        <div class="text-gray-500 text-xs">Отделка</div>
                                        <div class="font-semibold text-sm">{{ property.renovation_display_name or 'Уточняется' }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center col-span-1">
                                    <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <div>
                                        <div class="text-gray-500 text-xs">Срок сдачи</div>
                                        <div class="font-semibold text-sm">{{ property.completion_date }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action buttons -->
                            {% if session.get('manager_id') %}
                            <div class="flex gap-2 pt-4 border-t border-gray-100">
                                <button class="flex-1 px-3 py-2 border border-[#0088CC] text-[#0088CC] rounded-lg hover:bg-[#0088CC] hover:text-white transition text-sm font-medium recommend-btn" data-property-id="{{ property.id }}" data-property-name="{{ property.residential_complex }}" data-complex-name="{{ property.residential_complex }}" title="Рекомендовать клиенту">
                                    <i class="fas fa-paper-plane mr-2"></i>РЕКОМЕНДОВАТЬ
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- JavaScript Pagination Container -->
                <div id="pagination-container"></div>

                <!-- Серверная пагинация удалена - используется только JavaScript пагинация для сохранения фильтров -->
            </div>
        </div>
    </div>
</section>

<!-- Call-to-Action Section -->
<section class="py-16 bg-gradient-to-r from-[#0088CC] to-[#006699]">
    <div class="container mx-auto px-4 text-center">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-6">
                Получите персональную подборку квартир
            </h2>
            <p class="text-xl text-blue-100 mb-8">
                Наши эксперты подберут для вас лучшие варианты с максимальным кэшбеком до 500 000 ₽
            </p>
            
            <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-2xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ваше имя</label>
                        <input type="text" placeholder="Введите ваше имя" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                        <input type="tel" placeholder="+7 (___) ___-__-__" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Бюджет</label>
                    <select class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none">
                        <option>До 3 млн ₽</option>
                        <option>3-5 млн ₽</option>
                        <option>5-8 млн ₽</option>
                        <option>8-12 млн ₽</option>
                        <option>Свыше 12 млн ₽</option>
                    </select>
                </div>
                
                <button onclick="openApplicationModal();" class="w-full px-8 py-4 bg-gradient-to-r from-[#FF5722] to-[#E64A19] text-white font-bold rounded-xl hover:from-[#E64A19] hover:to-[#D84315] transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-gift mr-2"></i>
                    Получить подборку + кэшбек
                </button>
                
                <p class="text-sm text-gray-500 mt-4">
                    Бесплатно • Персональные предложения • Максимальный кэшбек
                </p>
            </div>
        </div>
    </div>
</section>

<script>
console.log('🚨 ЭКСТРЕННЫЙ SCRIPT ЗАПУЩЕН!');

// ✅ ЭКСТРЕННАЯ КНОПКА СБРОСА ФИЛЬТРОВ
window.TOTAL_RESET = function() {
    console.log('🔥 TOTAL_RESET АКТИВИРОВАН - СБРОС ВСЕГО!');
    
    // Убираем все фильтры из URL
    const newUrl = '/properties';
    console.log('🔄 Перенаправляем на:', newUrl);
    window.location.href = newUrl;
};

// ✅ Экстренная кнопка больше не нужна - функциональность встроена в обычную кнопку
console.log('✅ Функция TOTAL_RESET готова для использования');

// Set authentication status immediately at the start
window.user_authenticated = {{ user_authenticated|tojson }};
window.manager_authenticated = {{ manager_authenticated|tojson }};
{% if current_manager %}
window.current_manager = {{ current_manager.to_dict()|tojson }};
{% endif %}

// Debug authentication status
console.log('Authentication status:', {
    user_authenticated: window.user_authenticated,
    manager_authenticated: window.manager_authenticated,
    current_manager: window.current_manager || null
});

let map;
let markers = [];
// Load all properties data for JavaScript filtering
let allProperties = {{ properties|tojson|safe }};
let filteredProperties = [];
let selectedRooms = new Set();
let currentSortBy = 'price-desc';
let currentPage = 1;
let itemsPerPage = 20; // ✅ ИСПРАВЛЕНО: Показываем по 20 объектов на страницу
let residentialComplexes = [];

// Completely remove old favorites system - now handled by FavoritesManager
// Clear localStorage to avoid conflicts
if (localStorage.getItem('favorites')) {
    localStorage.removeItem('favorites');
    console.log('Cleared old localStorage favorites');
}

// Favorites counter is now handled by FavoritesManager class
// function updateFavoritesCounter() - DEPRECATED

// Advanced Filters Object
let advancedFilters = {
    districts: [],
    developers: [],
    propertyTypes: [],
    priceMin: 0,
    priceMax: 0,
    roomTypes: [],
    distances: [],
    areas: [],
    directions: [],
    payments: [],
    areaFrom: 0,
    areaTo: 0
};

// Add galleries to properties for testing
allProperties.forEach((property, index) => {
    if (!property.gallery) {
        property.gallery = [
            property.image,
            `https://via.placeholder.com/400x300/FF5722/FFFFFF?text=Кухня`,
            `https://via.placeholder.com/400x300/4CAF50/FFFFFF?text=Спальня`,
            `https://via.placeholder.com/400x300/9C27B0/FFFFFF?text=Вид`
        ];
    }
});

// Initialize smart autocomplete search for properties catalog
function initializePropertiesSmartSearch() {
    const searchInput = document.getElementById('property-search');
    if (!searchInput) return;
    
    // Make the input container relative
    searchInput.parentElement.style.position = 'relative';
    
    // Initialize smart autocomplete
    const autocomplete = new SmartAutocomplete(searchInput, {
        placeholder: 'Поиск по адресу, ЖК, застройщику...',
        onSelect: function(suggestion) {
            handlePropertiesSearchSelection(suggestion);
        },
        onSearch: function(query, suggestion) {
            performPropertiesSmartSearch(query, suggestion);
        }
    });
    
    // Store reference globally
    window.propertiesAutocomplete = autocomplete;
}

// Handle search suggestion selection for properties
function handlePropertiesSearchSelection(suggestion) {
    console.log('Properties selected suggestion:', suggestion);
    
    // Clear any existing filters first
    resetAllFilters();
    
    switch(suggestion.type) {
        case 'address':
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
            break;
        case 'complex':
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
            break;
        case 'developer':
            // Try to find and select the developer filter
            const developerSelect = document.getElementById('developer-filter');
            if (developerSelect) {
                const option = Array.from(developerSelect.options).find(opt => 
                    opt.textContent.toLowerCase().includes(suggestion.text.toLowerCase())
                );
                if (option) {
                    developerSelect.value = option.value;
                }
            }
            applyFilters();
            break;
        case 'district':
            const districtSelect = document.getElementById('district-filter');
            if (districtSelect) {
                const option = Array.from(districtSelect.options).find(opt => 
                    opt.textContent.toLowerCase().includes(suggestion.text.toLowerCase())
                );
                if (option) {
                    districtSelect.value = option.value;
                }
            }
            applyFilters();
            break;
        case 'rooms':
            // Handle room type suggestions
            if (suggestion.text.includes('Студи')) {
                document.querySelector('input[value="0"]')?.click();
            } else if (suggestion.text.includes('1-комнат')) {
                document.querySelector('input[value="1"]')?.click();
            } else if (suggestion.text.includes('2-комнат')) {
                document.querySelector('input[value="2"]')?.click();
            } else if (suggestion.text.includes('3-комнат')) {
                document.querySelector('input[value="3"]')?.click();
            }
            break;
        default:
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
    }
}

// Smart search for properties catalog
function performPropertiesSmartSearch(query, suggestion) {
    console.log('Performing properties smart search:', query, suggestion);
    document.getElementById('property-search').value = query;
    applyFilters();
}

// Enhanced search functionality with comprehensive suggestions for ALL parameters
function initializeSearch() {
    // Legacy function - replaced with smart search
    initializePropertiesSmartSearch();
    
    const searchInput = document.getElementById('property-search');
    const suggestionsContainer = document.getElementById('property-searchSuggestions');
    
    // Create comprehensive search suggestions covering ALL filter types with REAL database data
    const suggestions = {
        districts: ['Краснодарский край'],
        rooms: ['Студия', '1-комнатная', '2-комнатная', '3-комнатная', '4-комнатная'],
        propertyClass: ['Эконом', 'Комфорт', 'Бизнес', 'Премиум'],
        wallMaterial: ['Кирпич', 'Монолит', 'Панель', 'Газобетон'],
        floorsTotal: ['до 5 этажей', '6-10 этажей', '11-20 этажей', 'более 20 этажей'],
        completion: ['2024', '2025', '2026', '2028'],
        developers: ['ГК Неометрия', 'AVA', 'ЦЕНТРАЛЬНАЯ ИНВЕСТИЦИОННАЯ КОМПАНИЯ', 'СЗ КАСКАД', 'ТОЧНО', 'СПЕЦИАЛИЗИРОВАННЫЙ ЗАСТРОЙЩИК КОРОНА'],
        complexes: ['ЖК Гостиничный комплекс "Нескучный сад"', 'ЖК Лестория', 'ЖК ФЛОРА', 'ЖК "Кислород"', 'ЖК "Чайные холмы"', 'ЖК Гостиничный комплекс "Гранд Каскад"'],
        properties: [],
        streets: []
    };
    
    // Add property and complex data
    allProperties.forEach(property => {
        const propertyTitle = property.rooms == 0 ? 'Студия' : property.rooms + '-комн';
        suggestions.properties.push(propertyTitle + ' ' + property.area + ' м²');
        suggestions.complexes.push(property.residential_complex);
        suggestions.developers.push(property.developer);
        suggestions.streets.push(property.location);
    });
    
    // Add ЖК suggestions
    residentialComplexes.forEach(complex => {
        suggestions.complexes.push(complex.name);
        suggestions.developers.push(complex.developer);
        suggestions.streets.push(complex.location);
    });
    
    // Remove duplicates from each category
    Object.keys(suggestions).forEach(key => {
        suggestions[key] = [...new Set(suggestions[key])].filter(Boolean);
    });
    
    const allSuggestions = Object.values(suggestions).flat();
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length < 2) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
            return;
        }
        
        // Filter both property and ЖК suggestions
        const propertySuggestions = uniqueSuggestions
            .filter(suggestion => suggestion.toLowerCase().includes(query))
            .slice(0, 5);
            
        const complexSuggestions = residentialComplexes
            .filter(complex => 
                complex.name.toLowerCase().includes(query) ||
                complex.developer.toLowerCase().includes(query) ||
                complex.location.toLowerCase().includes(query)
            )
            .slice(0, 3);
        
        let suggestionHTML = '';
        
        if (propertySuggestions.length > 0) {
            suggestionHTML += propertySuggestions
                .map(suggestion => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                    <i class="fas fa-search mr-2 text-gray-400"></i>${suggestion}
                </div>`)
                .join('');
        }
        
        if (complexSuggestions.length > 0) {
            if (propertySuggestions.length > 0) {
                suggestionHTML += '<div class="border-t border-gray-200 my-1"></div>';
            }
            suggestionHTML += complexSuggestions
                .map(complex => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectComplexSuggestion('${complex.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-building mr-2 text-[#0088CC]"></i><strong>${complex.name}</strong><br>
                    <small class="text-gray-500 ml-6">${complex.developer} • ${complex.apartments_count} квартир</small>
                </div>`)
                .join('');
        }
        
        if (suggestionHTML && suggestionsContainer) {
            suggestionsContainer.innerHTML = suggestionHTML;
            suggestionsContainer.classList.remove('hidden');
        } else if (suggestionsContainer) {
            suggestionsContainer.classList.add('hidden');
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
        }
    });
}

// New smart search function
function performSmartSearch() {
    const searchValue = document.getElementById('property-search').value.trim();
    if (!searchValue) {
        alert('Введите поисковый запрос');
        return;
    }
    
    // Clear all current filters first
    clearAllFilters();
    
    // Try to detect and apply filters based on search
    const searchLower = searchValue.toLowerCase();
    
    // Check districts
    const districts = ['центральный', 'западный', 'карасунский', 'прикубанский', 'фестивальный'];
    districts.forEach(district => {
        if (searchLower.includes(district)) {
            const checkbox = document.querySelector(`input[data-filter-type="district"][value*="${district}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check property class
    const propertyClasses = ['эконом', 'комфорт', 'бизнес', 'премиум'];
    propertyClasses.forEach(cls => {
        if (searchLower.includes(cls)) {
            const checkbox = document.querySelector(`input[data-filter="property_class"][value*="${cls}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check wall materials
    const materials = ['кирпич', 'монолит', 'панель', 'газобетон'];
    materials.forEach(material => {
        if (searchLower.includes(material)) {
            const checkbox = document.querySelector(`input[data-filter="wall_material"][value*="${material}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Apply filters and search
    filterProperties();
    displayActiveFilters();
}

function selectSuggestion(suggestion, category) {
    document.getElementById('property-search').value = suggestion;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    
    // Auto-apply the selected filter
    if (category === 'district') {
        const checkbox = document.querySelector(`input[data-filter-type="district"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            filterProperties();
            displayActiveFilters();
        }
    } else if (category === 'developer') {
        const checkbox = document.querySelector(`input[data-filter-type="developer"][value="${suggestion}"]`) ||
                        document.querySelector(`input[data-filter="developer"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            filterProperties();
            displayActiveFilters();
        }
    } else if (category === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    }
    
    console.log('Selected suggestion:', suggestion, 'Category:', category);
    
    // Apply search filter
    filterProperties();
    displayActiveFilters();
}

function selectComplexSuggestion(complexName) {
    document.getElementById('property-search').value = complexName;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    applyFilters();
}

// Room filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const roomButtons = document.querySelectorAll('.room-btn');
    
    roomButtons.forEach(button => {
        button.addEventListener('click', function() {
            const rooms = this.dataset.rooms;
            
            if (selectedRooms.has(rooms)) {
                selectedRooms.delete(rooms);
                this.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.add('border-gray-300', 'text-gray-700');
            } else {
                selectedRooms.add(rooms);
                this.classList.add('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.remove('border-gray-300', 'text-gray-700');
            }
            
            applyFilters();
        });
    });
});

// Apply all filters
function resetAllFilters() {
    // Reset all form elements
    document.getElementById('property-search').value = '';
    document.getElementById('district-filter').value = '';
    document.getElementById('developer-filter').value = '';
    document.getElementById('price-from').value = '';
    document.getElementById('price-to').value = '';
    document.getElementById('area-from').value = '';
    document.getElementById('area-to').value = '';
    document.getElementById('property-type-filter').value = '';
    document.getElementById('completion-date-filter').value = '';
    document.getElementById('mortgage-filter').value = '';
    document.getElementById('sort-select').value = 'price-asc';
    
    // Reset room buttons
    selectedRooms.clear();
    document.querySelectorAll('.room-btn').forEach(button => {
        button.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
        button.classList.add('border-gray-300', 'text-gray-700');
    });
    
    // Reset advanced filters
    if (typeof resetAdvancedFilters === 'function') {
        resetAdvancedFilters();
    }
    
    // Hide reset button
    document.getElementById('resetFiltersBtn').style.display = 'none';
    
    // Clear URL parameters and redirect to clean properties page
    window.location.href = '/properties';
}

function applyFilters() {
    let filtered = [...allProperties];
    
    // Search filter
    const searchQuery = document.getElementById('property-search').value.toLowerCase().trim();
    if (searchQuery) {
        filtered = filtered.filter(property => {
            return property.title.toLowerCase().includes(searchQuery) ||
                   property.district.toLowerCase().includes(searchQuery) ||
                   (property.address && property.address.toLowerCase().includes(searchQuery)) ||
                   property.developer.toLowerCase().includes(searchQuery) ||
                   (property.complex_name && property.complex_name.toLowerCase().includes(searchQuery));
        });
    }
    
    // District filter
    const district = document.getElementById('district-filter').value;
    if (district) {
        filtered = filtered.filter(property => property.district === district);
    }
    
    // Developer filter
    const developer = document.getElementById('developer-filter').value;
    if (developer) {
        filtered = filtered.filter(property => property.developer === developer);
    }
    
    // Price filter (unified with other filter function)
    const priceFromEl = document.getElementById('priceFrom') || document.getElementById('price-from');
    const priceToEl = document.getElementById('priceTo') || document.getElementById('price-to');
    const priceFromValue = priceFromEl ? parseFloat(priceFromEl.value || 0) : 0;
    const priceToValue = priceToEl ? parseFloat(priceToEl.value || 0) : 0;
    
    if (priceFromValue > 0 || priceToValue > 0) {
        filtered = filtered.filter(property => {
            const priceInMillions = parseFloat(property.price) / 1000000;
            if (priceFromValue > 0 && priceInMillions < priceFromValue) return false;
            if (priceToValue > 0 && priceInMillions > priceToValue) return false;
            return true;
        });
    }
    
    // Rooms filter
    if (selectedRooms.size > 0) {
        filtered = filtered.filter(property => {
            const rooms = property.rooms;
            for (let selectedRoom of selectedRooms) {
                if (selectedRoom === '4' && rooms >= 4) return true;
                if (selectedRoom === '0' && rooms === 0) return true;
                if (parseInt(selectedRoom) === rooms) return true;
            }
            return false;
        });
    }
    
    // Area filter
    const areaFrom = parseInt(document.getElementById('area-from').value) || 0;
    const areaTo = parseInt(document.getElementById('area-to').value) || Infinity;
    if (areaFrom > 0 || areaTo < Infinity) {
        filtered = filtered.filter(property => 
            property.area >= areaFrom && property.area <= areaTo
        );
    }
    
    // Property type filter
    const propertyType = document.getElementById('property-type-filter').value;
    if (propertyType) {
        filtered = filtered.filter(property => property.property_type === propertyType);
    }
    
    // Completion date filter
    const completionDate = document.getElementById('completion-date-filter').value;
    if (completionDate) {
        filtered = filtered.filter(property => property.completion_date === completionDate);
    }
    
    // Mortgage filter
    const mortgage = document.getElementById('mortgage-filter').value;
    if (mortgage) {
        filtered = filtered.filter(property => {
            switch (mortgage) {
                case 'available':
                    return property.mortgage_available === true;
                case 'preferential':
                    return property.preferential_mortgage === true;
                case 'family':
                    return property.family_mortgage === true;
                case 'it':
                    return property.it_mortgage === true;
                default:
                    return true;
            }
        });
    }
    
    // ========== ADVANCED FILTERS INTEGRATION ==========
    // Apply advanced filters if they exist
    if (window.advancedFilters && Object.keys(window.advancedFilters).length > 0) {
        const advFilters = window.advancedFilters;
        console.log('Applying advanced filters to', filtered.length, 'properties:', advFilters);
        
        // Area range filter
        if (advFilters.area_range) {
            const areaRange = advFilters.area_range;
            filtered = filtered.filter(property => {
                const area = parseFloat(property.object_area) || 0;
                if (areaRange.from && area < areaRange.from) return false;
                if (areaRange.to && area > areaRange.to) return false;
                return true;
            });
            console.log('After area filter:', filtered.length, 'properties');
        }
        
        // Floor range filter
        if (advFilters.floor_range) {
            const floorRange = advFilters.floor_range;
            filtered = filtered.filter(property => {
                const floor = parseInt(property.object_floor) || 0;
                if (floorRange.from && floor < floorRange.from) return false;
                if (floorRange.to && floor > floorRange.to) return false;
                return true;
            });
            console.log('After floor filter:', filtered.length, 'properties');
        }
        
        // Max floor range filter
        if (advFilters.max_floor_range) {
            const maxFloorRange = advFilters.max_floor_range;
            filtered = filtered.filter(property => {
                const maxFloor = parseInt(property.object_max_floor) || 0;
                if (maxFloorRange.from && maxFloor < maxFloorRange.from) return false;
                if (maxFloorRange.to && maxFloor > maxFloorRange.to) return false;
                return true;
            });
            console.log('After max floor filter:', filtered.length, 'properties');
        }
        
        // Build year range filter
        if (advFilters.build_year_range) {
            const yearRange = advFilters.build_year_range;
            filtered = filtered.filter(property => {
                // Extract year from completion_date (e.g., "2025 г., 1 кв.")
                const completionMatch = property.completion_date ? property.completion_date.match(/(\d{4})/) : null;
                const year = completionMatch ? parseInt(completionMatch[1]) : 0;
                if (yearRange.from && year < yearRange.from) return false;
                if (yearRange.to && year > yearRange.to) return false;
                return true;
            });
            console.log('After build year filter:', filtered.length, 'properties');
        }
        
        // Object class filter
        if (advFilters.object_class && advFilters.object_class.length > 0) {
            filtered = filtered.filter(property => {
                const propertyClass = property.complex_object_class_display_name || '';
                console.log('Checking property class:', propertyClass, 'against filters:', advFilters.object_class);
                return advFilters.object_class.some(selectedClass => {
                    const matches = propertyClass.toLowerCase().includes(selectedClass.toLowerCase()) ||
                                  propertyClass.includes(selectedClass);
                    console.log('Class match check:', selectedClass, 'vs', propertyClass, '=', matches);
                    return matches;
                });
            });
            console.log('After object class filter:', filtered.length, 'properties');
        }
        
        // Renovation filter
        if (advFilters.renovation && advFilters.renovation.length > 0) {
            filtered = filtered.filter(property => {
                const renovation = property.renovation_display_name || '';
                return advFilters.renovation.some(selectedRenovation => renovation.includes(selectedRenovation));
            });
            console.log('After renovation filter:', filtered.length, 'properties');
        }
        
        // Building released filter
        if (advFilters.building_released && advFilters.building_released.length > 0) {
            filtered = filtered.filter(property => {
                const isReleased = property.building_released === true || property.building_released === 'true';
                return advFilters.building_released.includes(String(isReleased));
            });
            console.log('After building released filter:', filtered.length, 'properties');
        }
        
        console.log('Advanced filters applied. Final result:', filtered.length, 'properties');
    }
    
    filteredProperties = filtered;
    currentPage = 1; // Reset to first page when filtering
    
    // ✅ КРИТИЧЕСКИ ВАЖНО: Передаем только объекты первой страницы, НЕ весь массив
    const pageSize = 20;
    const pageProperties = filtered.slice(0, pageSize);
    updatePropertiesList(pageProperties);
    updateResultsCount(filtered.length);
    
    // Показываем пагинацию если есть больше одной страницы
    if (filtered.length > pageSize) {
        const totalPages = Math.ceil(filtered.length / pageSize);
        updatePaginationControls(filtered.length, totalPages);
    } else {
        const paginationContainer = document.getElementById('pagination-container');
        if (paginationContainer) paginationContainer.innerHTML = '';
    }
    
    // Update advanced filter tags display
    if (window.advancedFilters) {
        updateAdvancedFilterTags();
    }
    
    // Show/hide reset button based on active filters
    checkActiveFilters();
}

function checkActiveFilters() {
    const hasActiveFilters = (
        document.getElementById('property-search').value.trim() !== '' ||
        document.getElementById('district-filter').value !== '' ||
        document.getElementById('developer-filter').value !== '' ||
        document.getElementById('price-from').value !== '' ||
        document.getElementById('price-to').value !== '' ||
        document.getElementById('area-from').value !== '' ||
        document.getElementById('area-to').value !== '' ||
        document.getElementById('property-type-filter').value !== '' ||
        document.getElementById('completion-date-filter').value !== '' ||
        document.getElementById('mortgage-filter').value !== '' ||
        selectedRooms.size > 0 ||
        (window.advancedFilters && Object.keys(window.advancedFilters).length > 0)
    );
    
    const resetBtn = document.getElementById('resetFiltersBtn');
    if (resetBtn) {
        resetBtn.style.display = hasActiveFilters ? 'block' : 'none';
    }
}

// Update properties list display with pagination
function updatePropertiesList(properties) {
    const listContainer = document.getElementById('properties-container');
    
    if (!listContainer) {
        console.warn('Properties container not found - display mode may not be available');
        return;
    }
    
    if (properties.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">🔍</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Квартиры не найдены</h3>
                <p class="text-gray-500">Попробуйте изменить параметры поиска</p>
            </div>
        `;
        // Скрываем пагинацию если нет объектов
        const paginationContainer = document.getElementById('pagination-container');
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }
    
    // ✅ ИСПРАВЛЕНО: НЕ ДЕЛАЕМ пагинацию здесь - properties уже отфильтрованы для текущей страницы
    console.log(`📊 Рендерим ${properties.length} объектов для страницы ${currentPage}`);
    const paginatedProperties = properties; // Просто используем переданные свойства без дополнительной пагинации
    
    // Get current view mode from data attribute
    const isGridView = listContainer.getAttribute('data-view-mode') === 'grid';
    
    if (isGridView) {
        listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    } else {
        listContainer.className = 'space-y-6';
    }
    
    console.log(`🔄 Рендеринг: режим ${isGridView ? 'сетка' : 'список'}, страница ${currentPage}, объектов: ${properties.length}`);
    // Render paginated properties
    listContainer.innerHTML = paginatedProperties.map(property => `
        <!-- Property Card (Original Design) -->
        <div class="property-card bg-white rounded-lg shadow-sm overflow-hidden w-full ${isGridView ? 'flex flex-col h-full' : 'flex flex-col md:flex-row'}" 
             data-type="${property.type}" 
             data-rooms="${property.rooms}" 
             data-price="${property.price}" 
             data-district="${property.district}" 
             data-developer="${property.developer}"
             data-complex="${property.complex_name || 'Не указан'}"
             data-property-type="${property.property_type || property.type}">
            
            <!-- Image Gallery -->
            <div class="relative ${isGridView ? 'w-full h-48 flex-shrink-0' : 'md:w-96 w-full h-64 md:h-auto'} overflow-hidden group">
                <div class="carousel-container w-full h-full relative" data-property-id="${property.id}">
                    ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).map((image, index) => `
                        <div class="carousel-slide absolute inset-0 transition-opacity duration-300 ${index === 0 ? '' : 'opacity-0'}" data-slide="${index}">
                            <img src="${image}" alt="${property.title} - фото ${index + 1}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                        </div>
                    `).join('')}
                    
                    ${(property.gallery && property.gallery.length > 1) ? `
                    <!-- Navigation arrows -->
                    <button class="carousel-prev absolute left-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center hover:bg-black/50 transition z-30 opacity-0 group-hover:opacity-100" onclick="prevImageSlide(this)">
                        <i class="fas fa-chevron-left text-sm"></i>
                    </button>
                    <button class="carousel-next absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center hover:bg-black/50 transition z-30 opacity-0 group-hover:opacity-100" onclick="nextImageSlide(this)">
                        <i class="fas fa-chevron-right text-sm"></i>
                    </button>
                    
                    <!-- Dots indicator -->
                    <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex gap-1 z-30 opacity-0 group-hover:opacity-100 transition">
                        ${property.gallery ? property.gallery.map((_, index) => `
                            <button class="w-2 h-2 rounded-full bg-white/50 hover:bg-white/80 transition ${index === 0 ? 'bg-white/80' : ''}" onclick="goToImageSlide(this, ${index})"></button>
                        `).join('') : ''}
                    </div>
                    ` : ''}
                </div>
                <div class="absolute top-3 left-3 bg-[#FF5722] text-white text-xs font-semibold px-2 py-1 rounded z-20">
                    Кэшбек 5%
                </div>
                <!-- Overlay elements -->
                <div class="absolute top-3 right-3 z-20 flex gap-2">
                    <div class="favorite-heart" data-property-id="${property.id}" title="Добавить в избранное">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="comparison-btn w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer transition-all" data-property-id="${property.id}" title="Добавить к сравнению" onclick="toggleComparison('${property.id}', this); event.stopPropagation();">
                        <i class="fas fa-balance-scale text-gray-600 text-base"></i>
                    </div>
                    <a href="/object/${property.id}/pdf" target="_blank" class="w-10 h-10 bg-orange-500 hover:bg-orange-600 rounded-full flex items-center justify-center shadow-md cursor-pointer transition-all" data-property-id="${property.id}" title="Скачать PDF" onclick="event.stopPropagation();">
                        <i class="fas fa-file-pdf text-white text-base"></i>
                    </a>
                </div>
            </div>
            
            <!-- Info -->
            <div class="flex-1 ${isGridView ? 'p-4' : 'p-6'}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <a href="/object/${property.id}" class="${isGridView ? 'text-base font-medium' : 'text-xl font-semibold'} hover:text-[#0088CC] transition">
                            ${property.rooms == 0 ? 'Студия' : property.type === 'пентхаус' ? 'Пентхаус' : property.type === 'апартаменты' ? 'Апартаменты' : property.type === 'таунхаус' ? 'Таунхаус' : property.type === 'дом' ? 'Дом' : `${property.rooms}-к. квартира`}, ${property.area} м², ${property.floor}/${property.total_floors} эт.
                        </a>
                        <div class="flex items-center space-x-2 mt-1">
                            <div class="text-gray-600 text-sm space-y-1">
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 text-[#0088CC] mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                    <a href="#" class="hover:text-[#0088CC] hover:underline">${property.residential_complex || property.complex_name || 'Не указан'}</a>
                                </p>
                                <p class="flex items-center">
                                    <svg class="w-4 h-4 text-[#0088CC] mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                    </svg>
                                    ${property.address ? property.address : '-'}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex flex-col items-end">
                            ${property.price && property.price > 0 ? `
                            <span class="text-sm text-gray-500 line-through">${(property.price + (property.price * 0.05)).toLocaleString('ru-RU')} ₽</span>
                            <span class="property-price text-xl font-bold text-[#FF5722]">${property.price.toLocaleString('ru-RU')} ₽</span>
                            <span class="text-xs text-gray-500">(5% кэшбек ${(property.price * 0.05).toLocaleString('ru-RU')} ₽)</span>
                            ` : `
                            <span class="property-price text-xl font-bold text-gray-500">Цена по запросу</span>
                            `}
                        </div>
                        ${property.square_price ? `<span class="text-sm text-gray-500">${property.square_price.toLocaleString('ru-RU')} ₽/м²</span>` : ''}
                    </div>
                </div>
                
                <div class="grid ${isGridView ? 'grid-cols-1 gap-2 mb-3' : 'grid-cols-2 md:grid-cols-3 gap-3 mb-6'}">
                    <!-- Compact info row -->
                    <div class="${isGridView ? 'grid grid-cols-2 gap-2 mb-2 pb-2 border-b border-gray-200' : 'col-span-2 md:col-span-3 grid grid-cols-3 gap-3 mb-3 pb-2 border-b border-gray-200'}">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-gray-200 rounded-full mr-2 flex items-center justify-center text-xs font-bold text-gray-600">
                                ${(property.developer_name || property.developer || 'ИБ').substring(0,3).toUpperCase()}
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Застройщик</div>
                                <div class="font-semibold text-sm">${property.developer_name || property.developer || 'Не указан'}</div>
                            </div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Этажность</div>
                            <div class="font-semibold text-sm">${property.floor}/${property.total_floors}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Ипотека от</div>
                            <div class="font-semibold text-sm">${property.mortgage_rate || '3.5%'}</div>
                        </div>
                    </div>
                    
                    <!-- Project details row -->
                    <div class="${isGridView ? 'flex items-center' : 'flex items-center col-span-1'}">
                        <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
                        </svg>
                        <div>
                            <div class="text-gray-500 text-xs">Площадь</div>
                            <div class="font-semibold text-sm">${property.area} м²</div>
                        </div>
                    </div>
                    <div class="${isGridView ? 'flex items-center' : 'flex items-center col-span-1'}">
                        <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                        </svg>
                        <div>
                            <div class="text-gray-500 text-xs">Отделка</div>
                            <div class="font-semibold text-sm">${property.renovation_display_name || 'Уточняется'}</div>
                        </div>
                    </div>
                    <div class="${isGridView ? 'flex items-center' : 'flex items-center col-span-1'}">
                        <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <div>
                            <div class="text-gray-500 text-xs">Срок сдачи</div>
                            <div class="font-semibold text-sm">${property.completion_date || 'Уточняется'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Action buttons -->
                ${window.manager_authenticated ? `
                <div class="${isGridView ? 'flex flex-col gap-2 pt-3 border-t border-gray-100' : 'flex gap-2 pt-4 border-t border-gray-100'}">
                    <button class="flex-1 px-3 py-2 border border-[#0088CC] text-[#0088CC] rounded-lg hover:bg-[#0088CC] hover:text-white transition text-sm font-medium recommend-btn" data-property-id="${property.id}" data-property-name="${property.name}" data-complex-name="${property.complex_name}" title="Рекомендовать клиенту">
                        <i class="fas fa-paper-plane mr-2"></i>РЕКОМЕНДОВАТЬ
                    </button>
                </div>
                ` : ''}
            </div>
        </div>
    `).join('');
    
    // ✅ УБРАЛИ: НЕ обновляем пагинацию здесь - это делается в filterProperties()
    // updatePaginationControls(totalItems, totalPages);
    
    // Initialize favorites and comparison buttons after rendering
    setTimeout(() => {
        initializeAllButtons();
        console.log('Property list updated, buttons initialized');
    }, 50);
}

// Advanced Filters System  
let activeFilters = {};
let originalProperties = [...allProperties];

function initializeClearAllButton() {
    // Clear all filters button - добавляем обработчик для правильной функции
    console.log('🔧 Инициализация кнопки "Очистить все"...');
    const clearAllBtn = document.getElementById('clearAllFilters');
    if (clearAllBtn) {
        console.log('✅ Кнопка clearAllFilters найдена, добавляем обработчик');
        clearAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('🎯 Кнопка "Очистить все" нажата - вызываем правильную функцию');
            try {
                clearAllActiveFilters();
            } catch (error) {
                console.error('❌ Ошибка при очистке фильтров:', error);
            }
        });
        console.log('✅ Обработчик кнопки clearAllFilters установлен');
    } else {
        console.warn('⚠️ Кнопка clearAllFilters не найдена в DOM');
        console.log('🔍 Поиск всех кнопок на странице:');
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach((btn, index) => {
            console.log(`Кнопка ${index}: id="${btn.id}", class="${btn.className}", text="${btn.textContent.trim()}"`);
        });
    }
}

// ✅ УДАЛЕНА: Первая дублирующая функция

// Initialize dropdown filters functionality
function initializeDropdownFilters() {
    // Remove existing listeners to prevent duplicates
    const existingListeners = document.querySelectorAll('[data-dropdown-initialized]');
    existingListeners.forEach(el => el.removeAttribute('data-dropdown-initialized'));
    
    // Get property filter buttons - include quick filters but exclude header dropdowns  
    const searchSection = document.querySelector('section.py-8.bg-gray-50');
    const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
    
    if (!searchSection && !propertySection) return;
    
    // Get quick filter buttons from search section and advanced filter buttons from property section
    let filterButtons = [];
    if (searchSection) {
        filterButtons = filterButtons.concat(Array.from(searchSection.querySelectorAll('.dropdown .dropdown-btn')));
    }
    if (propertySection) {
        filterButtons = filterButtons.concat(Array.from(propertySection.querySelectorAll('.filter-dropdown .filter-option-btn, #toggleAllFilters')));
    }
    
    // Also get buttons from advanced filters section
    const advancedSection = document.querySelector('#advancedFiltersSection');
    if (advancedSection) {
        filterButtons = filterButtons.concat(Array.from(advancedSection.querySelectorAll('.filter-dropdown .filter-option-btn')));
    }
    
    filterButtons.forEach(button => {
        // Skip if already initialized
        if (button.hasAttribute('data-dropdown-initialized')) return;
        button.setAttribute('data-dropdown-initialized', 'true');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (this.id === 'toggleAllFilters') {
                // Handle "Все фильтры" button specially
                toggleAdvancedFilters();
                return;
            }
            
            const dropdown = this.closest('.filter-dropdown') || this.closest('.dropdown');
            let menu = null;
            
            if (dropdown) {
                menu = dropdown.querySelector('.dropdown-menu');
            }
            
            if (!menu && dropdown) {
                // Also check for filter-dropdown-menu class for advanced filters
                menu = dropdown.querySelector('.filter-dropdown-menu');
            }
            
            if (menu) {
                // Check current menu state BEFORE closing others
                let isCurrentMenuOpen = false;
                if (menu.classList.contains('dropdown-menu')) {
                    isCurrentMenuOpen = menu.classList.contains('open');
                } else if (menu.classList.contains('filter-dropdown-menu')) {
                    isCurrentMenuOpen = !menu.classList.contains('hidden');
                }
                
                // Close all dropdowns including the current one
                document.querySelectorAll('.dropdown-menu.open, .filter-dropdown-menu:not(.hidden)').forEach(openMenu => {
                    openMenu.classList.remove('open');
                    openMenu.classList.add('hidden');
                });
                
                // If the clicked menu was closed, open it
                if (!isCurrentMenuOpen) {
                    if (menu.classList.contains('dropdown-menu')) {
                        menu.classList.add('open');
                        menu.classList.remove('hidden');
                    } else if (menu.classList.contains('filter-dropdown-menu')) {
                        menu.classList.remove('hidden');
                    }
                    console.log('Dropdown opened');
                } else {
                    console.log('Dropdown closed');
                }
            }
        });
    });
    
    // Remove existing document click listener and add fresh one
    if (window.dropdownDocumentListener) {
        document.removeEventListener('click', window.dropdownDocumentListener);
    }
    
    window.dropdownDocumentListener = function(e) {
        // Only close property filter dropdowns, never touch header
        const searchSection = document.querySelector('section.py-8.bg-gray-50');
        const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
        
        if (!e.target.closest('.filter-dropdown') && !e.target.closest('.dropdown') && !e.target.closest('#allFiltersPanel') && !e.target.closest('header') && !e.target.closest('nav')) {
            // Close dropdowns within search section (quick filters)
            if (searchSection) {
                searchSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
            
            // Close dropdowns within property section (advanced filters)
            if (propertySection) {
                propertySection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                propertySection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
                propertySection.querySelectorAll('#allFiltersPanel').forEach(panel => {
                    panel.classList.add('hidden');
                });
            }
            
            // Close dropdowns within advanced filters section
            const advancedSection = document.querySelector('#advancedFiltersSection');
            if (advancedSection) {
                advancedSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                advancedSection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        }
    };
    
    document.addEventListener('click', window.dropdownDocumentListener);
}

// Handle room filter changes
function handleRoomFilterChange() {
    // Add small delay to prevent rapid fire events
    if (window.roomFilterTimeout) {
        clearTimeout(window.roomFilterTimeout);
    }
    
    window.roomFilterTimeout = setTimeout(() => {
        const checkedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        console.log('Room filters changed:', checkedRooms);
        
        // Update button text
        const buttonText = document.getElementById('roomsFilterText');
        if (buttonText) {
            if (checkedRooms.length === 0) {
                buttonText.textContent = 'Тип квартиры';
            } else if (checkedRooms.length === 1) {
                buttonText.textContent = checkedRooms[0];
            } else {
                buttonText.textContent = `${checkedRooms.length} типов`;
            }
        }
        
        // Apply filter immediately
        filterProperties();
        displayActiveFilters();
    }, 100);
}

// Handle region filter changes
function handleRegionFilterChange() {
    if (window.regionFilterTimeout) {
        clearTimeout(window.regionFilterTimeout);
    }
    
    window.regionFilterTimeout = setTimeout(() => {
        const checkedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
        console.log('Region filters changed:', checkedRegions);
        
        // Update button text
        const buttonText = document.getElementById('regionFilterText');
        if (buttonText) {
            if (checkedRegions.length === 0) {
                buttonText.textContent = 'Регион';
            } else if (checkedRegions.length === 1) {
                buttonText.textContent = checkedRegions[0];
            } else {
                buttonText.textContent = `${checkedRegions.length} регионов`;
            }
        }
        
        // Apply filter immediately
        filterProperties();
        displayActiveFilters();
    }, 100);
}

// Handle city filter changes
function handleCityFilterChange() {
    if (window.cityFilterTimeout) {
        clearTimeout(window.cityFilterTimeout);
    }
    
    window.cityFilterTimeout = setTimeout(() => {
        const checkedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
        console.log('City filters changed:', checkedCities);
        
        // Update button text
        const buttonText = document.getElementById('cityFilterText');
        if (buttonText) {
            if (checkedCities.length === 0) {
                buttonText.textContent = 'Город';
            } else if (checkedCities.length === 1) {
                buttonText.textContent = checkedCities[0];
            } else {
                buttonText.textContent = `${checkedCities.length} городов`;
            }
        }
        
        // Apply filter immediately
        filterProperties();
        displayActiveFilters();
    }, 100);
}

// Apply filters with proper function name
function applyFiltersFixed() {
    console.log('Applying filters...');
    filterProperties();
}

// Apply price filter
function applyPriceFilter() {
    const priceFrom = document.getElementById('priceFrom').value;
    const priceTo = document.getElementById('priceTo').value;
    
    console.log('Price filter:', priceFrom, 'to', priceTo);
    
    // Update button text
    const buttonText = document.getElementById('priceFilterText');
    if (priceFrom || priceTo) {
        let text = 'Цена ';
        if (priceFrom) text += `от ${priceFrom}млн `;
        if (priceTo) text += `до ${priceTo}млн`;
        buttonText.textContent = text.trim() + ' ₽';
    } else {
        buttonText.textContent = 'Цена от-до, ₽';
    }
    
    // Apply filter
    filterProperties();
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="price"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Apply advanced filters from "Еще" section
function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    const advancedFilters = {};
    
    // Area range
    const areaFrom = document.getElementById('areaFrom').value;
    const areaTo = document.getElementById('areaTo').value;
    if (areaFrom) advancedFilters.areaFrom = parseInt(areaFrom);
    if (areaTo) advancedFilters.areaTo = parseInt(areaTo);
    
    // Floor range
    const floorFrom = document.getElementById('floorFrom').value;
    const floorTo = document.getElementById('floorTo').value;
    if (floorFrom) advancedFilters.floorFrom = parseInt(floorFrom);
    if (floorTo) advancedFilters.floorTo = parseInt(floorTo);
    
    // Building type (этажность дома)
    const buildingTypes = Array.from(document.querySelectorAll('input[data-filter-type="building_type"]:checked')).map(cb => cb.value);
    if (buildingTypes.length > 0) advancedFilters.buildingTypes = buildingTypes;
    
    // Building status (статус сдачи) - ИСПРАВЛЕНО  
    const buildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
    if (buildingReleased.length > 0) advancedFilters.buildingReleased = buildingReleased;
    
    // Build year range (диапазон года сдачи)
    const buildYearFrom = document.getElementById('buildYearFrom')?.value;
    const buildYearTo = document.getElementById('buildYearTo')?.value;
    if (buildYearFrom || buildYearTo) {
        advancedFilters.buildYearRange = {
            from: buildYearFrom ? parseInt(buildYearFrom) : null,
            to: buildYearTo ? parseInt(buildYearTo) : null
        };
    }
    
    // Features (особенности)
    const features = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
    if (features.length > 0) advancedFilters.features = features;
    
    // Object class (класс жилья)
    const objectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_class"]:checked')).map(cb => cb.value);
    if (objectClasses.length > 0) advancedFilters.objectClasses = objectClasses;
    
    // Update activeFilters with advanced filters
    Object.assign(activeFilters, advancedFilters);
    
    console.log('Advanced filters applied:', advancedFilters);
    
    // Update filters counter
    const totalFilters = Object.keys(advancedFilters).length;
    const counter = document.getElementById('allFiltersCounter');
    if (counter) {
        if (totalFilters > 0) {
            counter.textContent = totalFilters;
            counter.classList.remove('hidden');
        } else {
            counter.classList.add('hidden');
        }
    }
    
    // Apply filters
    filterProperties();
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="advanced"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Toggle advanced filters section
function toggleAdvancedFilters() {
    const section = document.getElementById('advancedFiltersSection');
    if (section) {
        section.classList.toggle('hidden');
        console.log('Advanced filters toggled:', !section.classList.contains('hidden'));
    }
}

// Enhanced filter properties function with room filtering
function filterProperties() {
    // Prevent concurrent filtering operations
    if (window.isFiltering) return;
    window.isFiltering = true;
    
    try {
        if (!allProperties || allProperties.length === 0) {
            console.log('No properties to filter');
            return;
        }
        
        // Get room filters
        const selectedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        
        // Get price filters  
        const priceFromEl = document.getElementById('priceFrom');
        const priceToEl = document.getElementById('priceTo');
        const priceFrom = priceFromEl ? parseFloat(priceFromEl.value || 0) : 0;
        const priceTo = priceToEl ? parseFloat(priceToEl.value || 0) : 0;
        
        // Get completion date filters
        const selectedCompletionDates = Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value);
        
        // Get ADVANCED filters from "Еще" section
        const areaFromEl = document.getElementById('areaFrom');
        const areaToEl = document.getElementById('areaTo');
        const areaFrom = areaFromEl ? parseFloat(areaFromEl.value || 0) : 0;
        const areaTo = areaToEl ? parseFloat(areaToEl.value || 0) : 0;
        
        const floorFromEl = document.getElementById('floorFrom');
        const floorToEl = document.getElementById('floorTo');
        const floorFrom = floorFromEl ? parseInt(floorFromEl.value || 0) : 0;
        const floorTo = floorToEl ? parseInt(floorToEl.value || 0) : 0;
        
        // Building floors range (этажность дома) - используем числовые поля maxFloorFrom/maxFloorTo
        const maxFloorFromEl = document.getElementById('maxFloorFrom');
        const maxFloorToEl = document.getElementById('maxFloorTo');
        const maxFloorFrom = maxFloorFromEl ? parseInt(maxFloorFromEl.value || 0) : 0;
        const maxFloorTo = maxFloorToEl ? parseInt(maxFloorToEl.value || 0) : 0;
        
        // Building types - используем числовые поля вместо чекбоксов (чекбоксов нет в HTML)
        const selectedBuildingTypes = []; // Пустой массив - фильтр отключен
        const selectedBuildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
        const selectedFeatures = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
        const selectedRenovationTypes = Array.from(document.querySelectorAll('input[data-filter-type="renovation"]:checked')).map(cb => cb.value);
        const selectedObjectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_class"]:checked')).map(cb => cb.value);
        const selectedDevelopers = Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(cb => cb.value);
        const selectedDistricts = Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(cb => cb.value);
        
        // Get regional filters
        const selectedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
        const selectedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
        
        console.log('Filtering with:', {
            rooms: selectedRooms,
            priceFrom: priceFrom,
            priceTo: priceTo,
            completion: selectedCompletionDates,
            area: {from: areaFrom, to: areaTo},
            floor: {from: floorFrom, to: floorTo},
            buildingTypes: selectedBuildingTypes,
            buildingFloors: {from: maxFloorFrom, to: maxFloorTo},
            buildingReleased: selectedBuildingReleased,
            features: selectedFeatures,
            renovation: selectedRenovationTypes,
            objectClasses: selectedObjectClasses,
            developers: selectedDevelopers,
            districts: selectedDistricts,
            regions: selectedRegions,
            cities: selectedCities,
            complex: activeFilters.complex || null  // ✅ Добавлен фильтр по ЖК
        });
        
        // Debug: Show filter details
        if (floorFrom > 0 || floorTo > 0) {
            console.log(`Floor filter active: from ${floorFrom} to ${floorTo}`);
        }
        if (selectedDevelopers.length > 0) {
            console.log(`Developer filter active:`, selectedDevelopers);
        }
        
        // Debug: show some sample property data
        if (allProperties.length > 0) {
            console.log('Sample property for debugging:', {
                price: allProperties[0].price,
                priceInMillions: allProperties[0].price / 1000000,
                completion_date: allProperties[0].completion_date,
                rooms: allProperties[0].rooms,
                developer_name: allProperties[0].developer_name,
                complex_object_class_display_name: allProperties[0].complex_object_class_display_name,
                renovation_display_name: allProperties[0].renovation_display_name,
                object_min_floor: allProperties[0].object_min_floor,
                object_max_floor: allProperties[0].object_max_floor,
                object_area: allProperties[0].object_area
            });
        }
        
        filteredProperties = allProperties.filter(property => {
            // Room filter (merge quick and advanced filters)
            const allSelectedRooms = [...selectedRooms];
            if (advancedFilters.roomTypes && advancedFilters.roomTypes.length > 0) {
                allSelectedRooms.push(...advancedFilters.roomTypes);
            }
            
            if (allSelectedRooms.length > 0) {
                const match = allSelectedRooms.some(room => {
                    // ✅ ИСПРАВЛЕНО: поддержка всех форматов комнат
                    const normalizedRoom = room.toLowerCase();
                    
                    if (normalizedRoom === 'студия' || normalizedRoom === 'studio') {
                        return property.rooms === 0;  // Студия = 0 комнат
                    }
                    if (normalizedRoom === '1-комн' || normalizedRoom === '1-комнатная' || normalizedRoom === '1 комнатная') {
                        return property.rooms === 1;  // 1-комнатная
                    }
                    if (normalizedRoom === '2-комн' || normalizedRoom === '2-комнатная' || normalizedRoom === '2 комнатная') {
                        return property.rooms === 2;  // 2-комнатная
                    }
                    if (normalizedRoom === '3-комн' || normalizedRoom === '3-комнатная' || normalizedRoom === '3 комнатная') {
                        return property.rooms === 3;  // 3-комнатная
                    }
                    if (normalizedRoom === '4+-комн' || normalizedRoom === '4-комнатная' || normalizedRoom === '4 комнатная' || normalizedRoom.includes('4+')) {
                        return property.rooms >= 4;   // 4+ комнатная
                    }
                    return false;
                });
                if (!match) return false;
            }
            
            // ✅ ИСПРАВЛЕНО: PRICE FILTER (цена) - добавлена отладка и правильная фильтрация
            if (priceFrom > 0 || priceTo > 0) {
                const priceInMillions = parseFloat(property.price) / 1000000;
                
                if (priceFrom > 0 && priceInMillions < priceFrom) {
                    return false;
                }
                if (priceTo > 0 && priceInMillions > priceTo) {
                    return false;
                }
            }
            
            // ✅ ИСПРАВЛЕНО: Completion date filter (фильтр по дате сдачи)
            if (selectedCompletionDates.length > 0) {
                console.log(`Completion filter active:`, selectedCompletionDates);
                console.log(`Property completion_date: "${property.completion_date}"`);
                
                const match = selectedCompletionDates.some(date => {
                    // Сданные объекты
                    if (date === 'Сдан') {
                        return property.completion_date === 'Сдан' || 
                               property.status === 'ready' || 
                               property.completion_date === 'Готов' ||
                               property.completion_date === 'Сдано';
                    }
                    
                    // Годы сдачи (2024, 2025, 2026, 2028)
                    if (date.match(/^\d{4}$/)) {
                        // Проверяем что completion_date содержит год
                        const hasYear = property.completion_date && property.completion_date.includes(date);
                        console.log(`Year ${date} check: "${property.completion_date}" includes "${date}"? ${hasYear}`);
                        return hasYear;
                    }
                    
                    // Точное совпадение
                    return property.completion_date === date;
                });
                
                if (!match) {
                    console.log(`❌ Completion date filter: no match for "${property.completion_date}"`);
                    return false;
                }
                console.log(`✅ Completion date filter: match found!`);
            }
            
            // ADVANCED FILTERS from "Еще" section
            
            // Area filter (площадь)
            if (areaFrom > 0 || areaTo > 0) {
                const area = parseFloat(property.area || 0);
                if (areaFrom > 0 && area < areaFrom) return false;
                if (areaTo > 0 && area > areaTo) return false;
            }
            
            // Floor filter (этаж) - фильтр по этажу КВАРТИРЫ
            if (floorFrom > 0 || floorTo > 0) {
                const minFloor = parseInt(property.object_min_floor || property.floor || 0);
                const maxFloor = parseInt(property.object_max_floor || property.total_floors || minFloor);
                
                // ВАЖНО: фильтруем по этажу КВАРТИРЫ, не здания
                // Если указано "до 3 этажа" - показываем квартиры на 1-3 этажах
                if (floorFrom > 0 && minFloor < floorFrom) return false;
                if (floorTo > 0 && minFloor > floorTo) return false;
            }
            
            // Building floors filter (этажность дома) - по максимальной этажности здания
            if (maxFloorFrom > 0 || maxFloorTo > 0) {
                const buildingMaxFloors = parseInt(property.object_max_floor || property.total_floors || 0);
                if (maxFloorFrom > 0 && buildingMaxFloors < maxFloorFrom) return false;
                if (maxFloorTo > 0 && buildingMaxFloors > maxFloorTo) return false;
            }
            
            // Building floors filter (этажность дома) - используем числовые поля
            if (maxFloorFrom > 0 || maxFloorTo > 0) {
                const buildingFloors = parseInt(property.object_max_floor || property.total_floors || 0);
                if (maxFloorFrom > 0 && buildingFloors < maxFloorFrom) return false;
                if (maxFloorTo > 0 && buildingFloors > maxFloorTo) return false;
            }
            
            // Building status filter (статус сданности) - ИСПРАВЛЕНО: используем правильное поле
            if (selectedBuildingReleased.length > 0) {
                const match = selectedBuildingReleased.some(status => {
                    const buildingReleased = property.complex_building_released; // ПРАВИЛЬНОЕ ПОЛЕ!
                    
                    if (status === 'true') {
                        // Сданный дом - проверяем complex_building_released = True
                        return buildingReleased === true || buildingReleased === 'True' || buildingReleased === 'true';
                    }
                    
                    if (status === 'false') {
                        // В строительстве - проверяем complex_building_released = False
                        return buildingReleased === false || buildingReleased === 'False' || buildingReleased === 'false';
                    }
                    
                    return false;
                });
                if (!match) return false;
            }
            
            // Build year range filter (диапазон года сдачи) - ИСПРАВЛЕНО: используем правильное поле
            const buildYearFrom = document.getElementById('buildYearFrom')?.value;
            const buildYearTo = document.getElementById('buildYearTo')?.value;
            if (buildYearFrom || buildYearTo) {
                const buildingYear = parseInt(property.complex_building_end_build_year || 0); // ПРАВИЛЬНОЕ ПОЛЕ!
                
                if (buildYearFrom && buildingYear < parseInt(buildYearFrom)) return false;
                if (buildYearTo && buildingYear > parseInt(buildYearTo)) return false;
            }
            
            // Developer filter (застройщик) - используем правильное поле из Excel
            if (selectedDevelopers.length > 0) {
                const match = selectedDevelopers.some(developer => {
                    return property.developer_name === developer || 
                           property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Complex filter (жилой комплекс) - новый фильтр для параметра complex=
            // ✅ ИСПРАВЛЕНО: Проверяем что фильтр активен И не null/не пустой
            if (activeFilters.complex && activeFilters.complex !== null && activeFilters.complex !== '' && activeFilters.complex !== 'null') {
                const complexName = activeFilters.complex;
                
                // Debug: показываем что ищем и что сравниваем
                console.log(`🏠 Complex filter: looking for "${complexName}"`);
                console.log(`🔍 Property complex_name: "${property.complex_name}"`);
                
                // Более гибкое сравнение - учитываем разные варианты
                const match = property.complex_name === complexName || 
                             property.residential_complex === complexName ||
                             property.complex === complexName ||
                             // Дополнительные проверки для обработки кавычек
                             (property.complex_name && property.complex_name.includes(complexName.replace(/"/g, ''))) ||
                             (complexName.includes(property.complex_name));
                             
                if (!match) {
                    console.log(`❌ Complex filter: "${complexName}" not found in "${property.complex_name}"`);
                    return false;
                }
                console.log(`✅ Complex filter: match found!`);
            } else if (activeFilters.complex === null || activeFilters.complex === 'null') {
                // ✅ ДОБАВЛЕНО: Логирование когда фильтр сброшен
                console.log('🔄 Complex filter is NULL/cleared - showing all properties');
            }
            
            // District filter (район)
            if (selectedDistricts.length > 0) {
                const match = selectedDistricts.some(district => {
                    return property.district === district || 
                           property.address_locality_name === district;
                });
                if (!match) return false;
            }
            
            // Region filter (регион)
            if (selectedRegions.length > 0) {
                const match = selectedRegions.some(region => {
                    return property.parsed_region === region || 
                           property.region_name === region || 
                           property.region === region;
                });
                if (!match) return false;
            }
            
            // City filter (город) - ищем в полном адресе
            if (selectedCities.length > 0) {
                const match = selectedCities.some(city => {
                    const fullAddress = (property.address || property.address_display_name || '').toLowerCase();
                    return fullAddress.includes(city.toLowerCase());
                });
                if (!match) return false;
            }
            
            // Features filter (особенности)
            if (selectedFeatures.length > 0) {
                // Словарь сопоставления английских и русских названий особенностей
                const featureMapping = {
                    'accreditation': 'Аккредитация',
                    'green_mortgage': 'Зеленая ипотека',
                    'ready': 'Сдан',
                    'under_construction': 'В строительстве',
                    'no_finish': 'Без отделки',
                    'with_finish': 'С отделкой'
                };
                
                const match = selectedFeatures.some(feature => {
                    const russianFeature = featureMapping[feature] || feature;
                    
                    // Проверяем различные поля с особенностями
                    return (property.features && property.features.includes(russianFeature)) ||
                           (property.amenities && property.amenities.includes(russianFeature)) ||
                           (property.description && property.description.includes(russianFeature)) ||
                           // Дополнительные проверки для зеленой ипотеки
                           (feature === 'green_mortgage' && (property.has_green_mortgage || property.green_mortgage)) ||
                           // Проверки для аккредитации
                           (feature === 'accreditation' && property.building_accreditation);
                });
                if (!match) return false;
            }
            
            // Renovation filter (отделка)
            if (selectedRenovationTypes.length > 0) {
                const match = selectedRenovationTypes.some(renovationType => {
                    const propertyRenovation = property.renovation_display_name || property.renovation_type || property.renovation || '';
                    return propertyRenovation.toLowerCase().includes(renovationType.toLowerCase()) ||
                           propertyRenovation === renovationType;
                });
                if (!match) return false;
            }
            
            // Object class filter (класс жилья)
            if (selectedObjectClasses.length > 0) {
                console.log('Object class filter active with:', selectedObjectClasses);
                const propertyClass = property.complex_object_class_display_name || property.object_class || property.property_class || property.class || '';
                console.log(`Property class field: "${propertyClass}" (property id: ${property.id})`);
                
                const match = selectedObjectClasses.some(objClass => {
                    const matches = propertyClass.toLowerCase().includes(objClass.toLowerCase()) || 
                                  propertyClass === objClass ||
                                  property.object_class === objClass || 
                                  property.property_class === objClass ||
                                  property.class === objClass;
                    return matches;
                });
                
                if (match) {
                    console.log(`✅ Object class MATCH for property ${property.id}: "${propertyClass}"`);
                } else {
                    console.log(`❌ Object class NO MATCH for property ${property.id}: "${propertyClass}" vs [${selectedObjectClasses.join(', ')}]`);
                }
                
                if (!match) return false;
            }
            
            // Advanced filters integration
            // District filter (from advanced filters)
            if (advancedFilters.districts && advancedFilters.districts.length > 0) {
                const match = advancedFilters.districts.some(district => {
                    return property.district === district;
                });
                if (!match) return false;
            }
            
            // Developer filter (from advanced filters)
            if (advancedFilters.developers && advancedFilters.developers.length > 0) {
                const match = advancedFilters.developers.some(developer => {
                    return property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Property type filter (from advanced filters)
            if (advancedFilters.propertyTypes && advancedFilters.propertyTypes.length > 0) {
                const match = advancedFilters.propertyTypes.some(type => {
                    return property.type === type || property.property_type === type;
                });
                if (!match) return false;
            }
            
            // Area filter (from advanced filters)
            if (advancedFilters.areas && advancedFilters.areas.length > 0) {
                const match = advancedFilters.areas.some(areaRange => {
                    const area = parseFloat(property.area);
                    if (areaRange === '30-50') return area >= 30 && area <= 50;
                    if (areaRange === '50-70') return area >= 50 && area <= 70;
                    if (areaRange === '70-100') return area >= 70 && area <= 100;
                    if (areaRange === '100+') return area > 100;
                    return false;
                });
                if (!match) return false;
            }
            
            // Area range filter (from advanced filters)
            if (advancedFilters.areaFrom > 0 || advancedFilters.areaTo > 0) {
                const area = parseFloat(property.area);
                if (advancedFilters.areaFrom > 0 && area < advancedFilters.areaFrom) return false;
                if (advancedFilters.areaTo > 0 && area > advancedFilters.areaTo) return false;
            }
            
            // Distance filter (from advanced filters)
            if (advancedFilters.distances && advancedFilters.distances.length > 0) {
                const match = advancedFilters.distances.some(distanceRange => {
                    // Mock distance calculation - in real app would be calculated from coordinates
                    const mockDistance = Math.random() * 20; // 0-20 km
                    if (distanceRange === '0-5') return mockDistance <= 5;
                    if (distanceRange === '5-10') return mockDistance > 5 && mockDistance <= 10;
                    if (distanceRange === '10-15') return mockDistance > 10 && mockDistance <= 15;
                    if (distanceRange === '15+') return mockDistance > 15;
                    return false;
                });
                if (!match) return false;
            }
            
            // Payment methods filter (from advanced filters)
            if (advancedFilters.payments && advancedFilters.payments.length > 0) {
                // Mock payment methods - in real app would check property payment options
                const match = advancedFilters.payments.some(payment => {
                    return true; // All properties support all payment methods for now
                });
                if (!match) return false;
            }
            
            // Direction filter (from advanced filters)
            if (advancedFilters.directions && advancedFilters.directions.length > 0) {
                // Mock direction - in real app would check property orientation
                const directions = ['север', 'юг', 'восток', 'запад', 'юго-восток', 'юго-запад', 'северо-восток', 'северо-запад'];
                const propertyDirection = directions[property.id % directions.length];
                const match = advancedFilters.directions.includes(propertyDirection);
                if (!match) return false;
            }
            

            
            return true;
        });
        
        console.log(`🎯 FILTERING RESULT: ${filteredProperties.length} properties from ${allProperties.length} total`);
        
        // Store globally for other functions
        window.filteredProperties = filteredProperties;
        
        // ✅ КРИТИЧЕСКИ ВАЖНО: Обновляем счетчик СРАЗУ после фильтрации
        console.log(`🔄 Calling updateResultsCount with: ${filteredProperties.length}`);
        updateResultsCount(filteredProperties.length);
        
        // ✅ НЕ ВЫЗЫВАЕМ updatePropertiesList здесь - это делается ниже с пагинацией
        currentPage = 1; // Reset to first page when filtering
        
        // ✅ КРИТИЧЕСКИ ИСПРАВЛЕНО: Пагинация - показываем ТОЛЬКО текущую страницу
        window.itemsPerPage = 20;
        const totalPages = Math.ceil(filteredProperties.length / window.itemsPerPage);
        
        // ВАЖНО: Показываем только объекты текущей страницы
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const endIndex = startIndex + window.itemsPerPage;
        const pageProperties = filteredProperties.slice(startIndex, endIndex);
        
        console.log(`📄 Пагинация: страница ${currentPage}/${totalPages}, показываем ${pageProperties.length} объектов (${startIndex+1}-${Math.min(endIndex, filteredProperties.length)} из ${filteredProperties.length})`);
        
        // КРИТИЧНО: Передаем только объекты текущей страницы, НЕ все filtered
        updatePropertiesList(pageProperties);
        
        // Показываем пагинацию только если больше 1 страницы
        if (totalPages > 1) {
            updatePaginationControls(filteredProperties.length, totalPages);
        } else {
            // Скрываем пагинацию если только 1 страница
            const paginationContainer = document.getElementById('pagination-container');
            if (paginationContainer) paginationContainer.innerHTML = '';
        }
        
        // ✅ ДОБАВЛЕНО: Update active filters display
        displayActiveFilters();
        
        // Initialize buttons after filtering
        setTimeout(() => {
            initializeAllButtons();
            console.log('Buttons reinitialized after filtering');
        }, 50);
        
    } finally {
        window.isFiltering = false;
    }
}

// ✅ КРИТИЧЕСКИ ИСПРАВЛЕНО: Update results counter - НАХОДИМ ЛЮБОЙ H3 с "Найдено"
function updateResultsCount(count) {
    console.log(`🔄 updateResultsCount called with count: ${count}`);
    
    // Функция склонения слова "объект"  
    function getObjectWord(count) {
        if (count % 100 >= 11 && count % 100 <= 14) return "объектов";
        switch (count % 10) {
            case 1: return "объект";
            case 2: case 3: case 4: return "объекта";
            default: return "объектов";
        }
    }
    
    // СТРАТЕГИЯ 1: Ищем любой H3 который содержит текст "Найдено"
    const h3Elements = document.querySelectorAll('h3');
    let targetH3 = null;
    
    for (let h3 of h3Elements) {
        if (h3.textContent && h3.textContent.includes('Найдено')) {
            targetH3 = h3;
            break;
        }
    }
    
    if (targetH3) {
        // Полностью перезаписываем содержимое H3
        targetH3.innerHTML = `Найдено <span id="results-count">${count}</span> ${getObjectWord(count)}`;
        console.log(`✅ Обновлен H3 с "Найдено": ${count} ${getObjectWord(count)}`);
        return;
    }
    
    // СТРАТЕГИЯ 2: Если H3 не найден, ищем span results-count
    const resultsCount = document.getElementById('results-count');
    if (resultsCount) {
        resultsCount.textContent = count;
        console.log(`✅ Обновлен span results-count: ${count}`);
        return;
    }
    
    // СТРАТЕГИЯ 3: Если ничего не найдено, создаем новый элемент
    console.error(`❌ НЕ НАЙДЕН элемент для обновления счетчика! Создаем новый...`);
    
    // Ищем контейнер результатов
    const resultsSection = document.querySelector('.bg-white.rounded-xl.shadow-sm.border.border-gray-200.p-4');
    if (resultsSection) {
        const newH3 = document.createElement('h3');
        newH3.className = 'text-xl font-bold text-gray-900';
        newH3.innerHTML = `Найдено <span id="results-count">${count}</span> ${getObjectWord(count)}`;
        resultsSection.insertBefore(newH3, resultsSection.firstChild);
        console.log(`✅ Создан новый H3: ${count} ${getObjectWord(count)}`);
        return;
    }
    
    console.error('❌ Критическая ошибка: не удалось найти или создать элемент счетчика!');
}

// ✅ ИСПРАВЛЕНО: Update pagination controls - РАБОТАЮЩАЯ пагинация
function updatePaginationControls(totalItems, totalPages) {
    const paginationContainer = document.getElementById('pagination-container');
    if (!paginationContainer) {
        console.log('❌ pagination-container not found');
        return;
    }
    
    console.log(`🔄 Updating pagination: ${totalItems} items, ${totalPages} pages, current page: ${currentPage}`);
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        console.log('✅ Pagination hidden - only 1 page');
        return;
    }
    
    const startIndex = (currentPage - 1) * window.itemsPerPage + 1;
    const endIndex = Math.min(currentPage * window.itemsPerPage, totalItems);
    
    let paginationHTML = `
        <div class="flex justify-between items-center bg-white rounded-lg shadow-sm border border-gray-200 p-4 mt-6">
            <div class="text-sm text-gray-600">
                Показано <span class="font-semibold">${startIndex}-${endIndex}</span> из <span class="font-semibold">${totalItems}</span> объектов
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="goToPage(${currentPage - 1})" class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                    Предыдущая
                </button>
    `;
    
    // Page numbers
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    if (startPage > 1) {
        paginationHTML += `<button onclick="goToPage(1)" class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="px-2">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button onclick="goToPage(${i})" class="px-3 py-2 border rounded-lg transition ${i === currentPage ? 'bg-[#0088CC] text-white' : 'hover:bg-gray-50'}">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="px-2">...</span>`;
        }
        paginationHTML += `<button onclick="goToPage(${totalPages})" class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">${totalPages}</button>`;
    }
    
    paginationHTML += `
                <button onclick="goToPage(${currentPage + 1})" class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === totalPages ? 'disabled' : ''}>
                    Следующая
                </button>
            </div>
        </div>
    `;
    
    paginationContainer.innerHTML = paginationHTML;
}

// ✅ ИСПРАВЛЕНО: Go to specific page - правильная пагинация
function goToPage(page) {
    const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
    const totalPages = Math.ceil(dataToUse.length / window.itemsPerPage);
    
    if (page < 1 || page > totalPages) {
        console.log(`❌ Неверная страница: ${page}, доступно: 1-${totalPages}`);
        return;
    }
    
    console.log(`📄 Переход на страницу ${page} из ${totalPages}`);
    
    currentPage = page;
    
    // Показываем только объекты текущей страницы
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const endIndex = startIndex + window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, endIndex);
    
    console.log(`📄 Показываем объекты ${startIndex+1}-${Math.min(endIndex, dataToUse.length)} из ${dataToUse.length}`);
    
    // Обновляем список с объектами ТОЛЬКО текущей страницы
    updatePropertiesList(pageProperties);
    
    // Обновляем пагинацию для выделения текущей страницы
    updatePaginationControls(dataToUse.length, totalPages);
    
    // Прокрутка к началу списка объектов
    const propertiesContainer = document.getElementById('properties-container');
    if (propertiesContainer) {
        propertiesContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Advanced Filters Functions
// advancedFilters already declared above

function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    advancedFilters.districts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.roomTypes = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
    
    // Update the quick filters to match advanced filters
    if (advancedFilters.districts.length > 0) {
        // Update district dropdown if exists
        const districtSelect = document.querySelector('select[name="district"]');
        if (districtSelect) {
            districtSelect.value = advancedFilters.districts[0];
        }
    }
    
    // Apply the unified filter logic
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
    
    // Hide advanced filters panel
    toggleAdvancedFilters();
}

function clearAllAdvancedFilters() {
    console.log('Clearing all advanced filters...');
    
    // Clear all checkboxes in advanced filters
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset advanced filters object
    advancedFilters = {
        districts: [],
        developers: [],
        propertyTypes: [],
        priceMin: 0,
        priceMax: 0,
        roomTypes: [],
        distances: [],
        areas: [],
        directions: [],
        payments: [],
        areaFrom: 0,
        areaTo: 0
    };
    
    // Clear main filter checkboxes too
    document.querySelectorAll('input[data-filter-type="rooms"]:checked').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Update results display
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
}

function updateAdvancedFiltersResultsCount() {
    const resultCountElement = document.getElementById('advancedResultsCount');
    if (resultCountElement) {
        const count = filteredProperties.length || allProperties.length;
        resultCountElement.textContent = `${count} квартир найдено`;
    }
}

// Save current filters function
function saveCurrentFilters() {
    console.log('Saving current filters state...');
    toggleAdvancedFilters(); // Just close the panel for now
}

// Initialize advanced filters dropdowns
function initializeAdvancedFilters() {
    // Handle dropdown toggle for advanced filters
    document.querySelectorAll('#advancedFiltersSection .filter-option-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropdown = this.closest('.filter-dropdown');
            if (!dropdown) return;
            
            const menu = dropdown.querySelector('.dropdown-menu');
            if (!menu) return;
            
            // Close other dropdowns
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(otherMenu => {
                if (otherMenu !== menu) {
                    otherMenu.classList.add('hidden');
                }
            });
            
            // Toggle current dropdown
            menu.classList.toggle('hidden');
            console.log('Advanced dropdown toggled');
        });
    });
    
    // Handle checkbox changes in advanced filters
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            console.log('Advanced filter checkbox changed:', this.value, this.checked);
            
            // Collect current advanced filter values including new filters
            advancedFilters.districts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
            advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
            advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
            advancedFilters.propertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
            advancedFilters.wallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
            advancedFilters.floorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
            advancedFilters.propertyType = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
            advancedFilters.salesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
            advancedFilters.parking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
            advancedFilters.elevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
            advancedFilters.registration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
            advancedFilters.nearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
            advancedFilters.windowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
            advancedFilters.specialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
            advancedFilters.worldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
            
            // Update global activeFilters object with all new filters
            activeFilters.propertyClass = advancedFilters.propertyClass;
            activeFilters.wallMaterial = advancedFilters.wallMaterial;
            activeFilters.floorsTotal = advancedFilters.floorsTotal;
            activeFilters.propertyType = advancedFilters.propertyType;
            activeFilters.salesStart = advancedFilters.salesStart;
            activeFilters.parking = advancedFilters.parking;
            activeFilters.elevator = advancedFilters.elevator;
            activeFilters.registration = advancedFilters.registration;
            activeFilters.nearbyPlaces = advancedFilters.nearbyPlaces;
            activeFilters.windowView = advancedFilters.windowView;
            activeFilters.specialApartments = advancedFilters.specialApartments;
            activeFilters.worldSides = advancedFilters.worldSides;
            advancedFilters.roomTypes = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
            advancedFilters.distances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
            advancedFilters.areas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
            advancedFilters.directions = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
            advancedFilters.payments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
            
            // Get area range inputs
            const areaFrom = document.getElementById('areaFrom')?.value;
            const areaTo = document.getElementById('areaTo')?.value;
            if (areaFrom || areaTo) {
                advancedFilters.areaFrom = parseFloat(areaFrom) || 0;
                advancedFilters.areaTo = parseFloat(areaTo) || 0;
            }
            
            // Real-time filtering
            filterProperties();
            
            // Update active filters display
            displayActiveFilters();
            
            // Real-time update of filter count
            updateAdvancedFiltersResultsCount();
            
            // Initialize buttons after filtering
            setTimeout(() => {
                initializeAllButtons();
                console.log('Buttons reinitialized after advanced filtering');
            }, 50);
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#advancedFiltersSection .filter-dropdown')) {
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });
}

// Display active filters
function displayActiveFilters() {
    const activeFiltersList = document.getElementById('activeFiltersList');
    const clearButton = document.getElementById('clearAllFiltersBtn');
    
    if (!activeFiltersList) return;
    
    // Get active room filters
    const selectedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
    
    // Get price filters
    const priceFrom = document.getElementById('priceFrom')?.value;
    const priceTo = document.getElementById('priceTo')?.value;
    
    // Get completion filters
    const selectedCompletionDates = Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value);
    
    // Get advanced filters
    const selectedDistances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
    const selectedAreas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
    const selectedDirections = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
    const selectedPayments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
    
    // Get new advanced filters
    const selectedPropertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
    const selectedWallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
    const selectedBuildingFloors = Array.from(document.querySelectorAll('input[data-filter="building_floors"]:checked')).map(cb => cb.value);
    const selectedFloorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
    const selectedPropertyTypes = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
    const selectedSalesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
    const selectedParking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
    const selectedElevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
    const selectedRegistration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
    const selectedNearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
    const selectedWindowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
    const selectedSpecialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
    const selectedWorldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
    
    // Get apartment filters from screenshot
    const selectedFinishing = Array.from(document.querySelectorAll('input[data-filter="finishing"]:checked')).map(cb => cb.value);
    
    // Get area range inputs for apartment
    const areaReducedFrom = document.querySelector('input[data-filter="area_reduced_from"]')?.value;
    const areaReducedTo = document.querySelector('input[data-filter="area_reduced_to"]')?.value;
    const kitchenAreaFrom = document.querySelector('input[data-filter="kitchen_area_from"]')?.value;
    const kitchenAreaTo = document.querySelector('input[data-filter="kitchen_area_to"]')?.value;
    const selectedDistricts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
    const selectedDevelopers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    const selectedOldPropertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    const selectedAdvancedRooms = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
    
    // Get regional filters
    const selectedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
    const selectedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
    
    // Get area range inputs
    const areaFromInput = document.getElementById('areaFrom')?.value;
    const areaToInput = document.getElementById('areaTo')?.value;
    
    // Clear existing filters
    activeFiltersList.innerHTML = '';
    
    let hasFilters = false;
    
    // Add room filters
    selectedRooms.forEach(room => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            ${room}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('rooms', '${room}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add price filter
    if (priceFrom || priceTo) {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        let priceText = 'Цена ';
        if (priceFrom) priceText += `от ${priceFrom}млн `;
        if (priceTo) priceText += `до ${priceTo}млн`;
        chip.innerHTML = `
            ${priceText.trim()}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('price', '')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    }
    
    // Add dropdown developer filter (from top filter bar)
    const selectedDropdownDeveloper = document.getElementById('developer-filter')?.value;
    if (selectedDropdownDeveloper) {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Застройщик: ${selectedDropdownDeveloper}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('dropdownDeveloper', '${selectedDropdownDeveloper}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    }

    // Add dropdown district filter (from top filter bar)
    const selectedDropdownDistrict = document.getElementById('district-filter')?.value;
    if (selectedDropdownDistrict) {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Район: ${selectedDropdownDistrict}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('dropdownDistrict', '${selectedDropdownDistrict}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    }

    // Add completion filters
    selectedCompletionDates.forEach(date => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            ${date}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('completion', '${date}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add region filters
    selectedRegions.forEach(region => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Регион: ${region}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('region', '${region}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add city filters
    selectedCities.forEach(city => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Город: ${city}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('city', '${city}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add distance filters
    selectedDistances.forEach(distance => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            До центра: ${distance} км
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('distance', '${distance}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add area filters
    selectedAreas.forEach(area => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Площадь: ${area}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('area', '${area}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add area range filter
    if (areaFromInput || areaToInput) {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        let areaText = 'Площадь ';
        if (areaFromInput) areaText += `от ${areaFromInput}м² `;
        if (areaToInput) areaText += `до ${areaToInput}м²`;
        chip.innerHTML = `
            ${areaText.trim()}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('areaRange', '')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    }
    
    // Add direction filters
    selectedDirections.forEach(direction => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Сторона: ${direction}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('direction', '${direction}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add payment filters
    selectedPayments.forEach(payment => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Оплата: ${payment}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('payment', '${payment}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add district filters
    selectedDistricts.forEach(district => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Район: ${district}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('district', '${district}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add developer filters
    selectedDevelopers.forEach(developer => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Застройщик: ${developer}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('developer', '${developer}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add property type filters
    selectedPropertyTypes.forEach(type => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Тип: ${type}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('propertyType', '${type}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add advanced room filters
    selectedAdvancedRooms.forEach(room => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            ${room}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('advancedRooms', '${room}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add property class filters (NEW)
    selectedPropertyClass.forEach(cls => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Класс: ${cls}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('propertyClass', '${cls}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add wall material filters (NEW)
    selectedWallMaterial.forEach(material => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Материал: ${material}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('wallMaterial', '${material}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add floors total filters (NEW)
    selectedFloorsTotal.forEach(floors => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Этажей: ${floors}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('floorsTotal', '${floors}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add property type filters (NEW)
    selectedPropertyTypes.forEach(type => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Тип: ${type}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('propertyType2', '${type}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add sales start filters (NEW)
    selectedSalesStart.forEach(start => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Продажи: ${start}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('salesStart', '${start}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add property class filters
    selectedPropertyClass.forEach(cls => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Класс: ${cls}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('propertyClass', '${cls}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add wall material filters
    selectedWallMaterial.forEach(material => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Материал: ${material}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('wallMaterial', '${material}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add building floors filters
    selectedBuildingFloors.forEach(floors => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Этажей: ${floors}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('buildingFloors', '${floors}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add finishing filters
    selectedFinishing.forEach(finish => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Отделка: ${finish}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('finishing', '${finish}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add area range filters
    if (areaReducedFrom || areaReducedTo) {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        const rangeText = `${areaReducedFrom || 0} - ${areaReducedTo || '∞'} м²`;
        chip.innerHTML = `
            Пл. прив.: ${rangeText}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('areaReduced', 'range')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    }
    
    // Add kitchen area range filters
    if (kitchenAreaFrom || kitchenAreaTo) {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        const rangeText = `${kitchenAreaFrom || 0} - ${kitchenAreaTo || '∞'} м²`;
        chip.innerHTML = `
            Кухня: ${rangeText}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('kitchenArea', 'range')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    };
    
    // Add parking filters (NEW)
    selectedParking.forEach(parking => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Паркинг: ${parking}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('parking', '${parking}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add elevator filters (NEW)
    selectedElevator.forEach(elevator => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Лифт: ${elevator}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('elevator', '${elevator}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add registration filters (NEW)
    selectedRegistration.forEach(reg => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Прописка: ${reg}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('registration', '${reg}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add nearby places filters (NEW)
    selectedNearbyPlaces.forEach(place => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Рядом: ${place}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('nearbyPlaces', '${place}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add window view filters (NEW)
    selectedWindowView.forEach(view => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Вид: ${view}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('windowView', '${view}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add special apartments filters (NEW)
    selectedSpecialApartments.forEach(special => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Особая: ${special}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('specialApartments', '${special}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Add world sides filters (NEW)
    selectedWorldSides.forEach(side => {
        hasFilters = true;
        const chip = document.createElement('div');
        chip.className = 'active-filter-chip bg-[#0088CC] text-white px-3 py-1 rounded-full text-sm flex items-center gap-2';
        chip.innerHTML = `
            Сторона: ${side}
            <button class="remove-btn w-4 h-4 bg-white/20 rounded-full flex items-center justify-center text-xs" onclick="removeFilter('worldSides', '${side}')">×</button>
        `;
        activeFiltersList.appendChild(chip);
    });
    
    // Show/hide clear button
    if (clearButton) {
        clearButton.classList.toggle('hidden', !hasFilters);
    }
}

// Remove individual filter
function removeFilter(type, value) {
    if (type === 'rooms') {
        const checkbox = document.querySelector(`input[data-filter-type="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRoomFilterChange();
    } else if (type === 'price') {
        document.getElementById('priceFrom').value = '';
        document.getElementById('priceTo').value = '';
        document.getElementById('priceFilterText').textContent = 'Цена от-до, ₽';
    } else if (type === 'completion') {
        const checkbox = document.querySelector(`input[data-filter-type="completion"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'distance') {
        const checkbox = document.querySelector(`input[data-filter="distance"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'area') {
        const checkbox = document.querySelector(`input[data-filter="area"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'areaRange') {
        const areaFrom = document.getElementById('areaFrom');
        const areaTo = document.getElementById('areaTo');
        if (areaFrom) areaFrom.value = '';
        if (areaTo) areaTo.value = '';
    } else if (type === 'direction') {
        const checkbox = document.querySelector(`input[data-filter="direction"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'payment') {
        const checkbox = document.querySelector(`input[data-filter="payment"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'district') {
        const checkbox = document.querySelector(`input[data-filter="district"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'developer') {
        const checkbox = document.querySelector(`input[data-filter="developer"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType') {
        const checkbox = document.querySelector(`input[data-filter="propertyType"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'advancedRooms') {
        const checkbox = document.querySelector(`#advancedFiltersSection input[data-filter="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType2') {
        const checkbox = document.querySelector(`input[data-filter="property_type"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'salesStart') {
        const checkbox = document.querySelector(`input[data-filter="sales_start"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'parking') {
        const checkbox = document.querySelector(`input[data-filter="parking"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'elevator') {
        const checkbox = document.querySelector(`input[data-filter="elevator"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'registration') {
        const checkbox = document.querySelector(`input[data-filter="registration"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'nearbyPlaces') {
        const checkbox = document.querySelector(`input[data-filter="nearby_places"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'windowView') {
        const checkbox = document.querySelector(`input[data-filter="window_view"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'specialApartments') {
        const checkbox = document.querySelector(`input[data-filter="special_apartments"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'dropdownDeveloper') {
        const dropdown = document.getElementById('developer-filter');
        if (dropdown) dropdown.value = '';
    } else if (type === 'dropdownDistrict') {
        const dropdown = document.getElementById('district-filter');
        if (dropdown) dropdown.value = '';
    } else if (type === 'worldSides') {
        const checkbox = document.querySelector(`input[data-filter="world_sides"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'region') {
        const checkbox = document.querySelector(`input[data-filter-type="region"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRegionFilterChange();
    } else if (type === 'city') {
        const checkbox = document.querySelector(`input[data-filter-type="city"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleCityFilterChange();
    }
    
    // Update advanced filters object (excluding duplicates from quick filters)
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.distances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
    advancedFilters.areas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
    advancedFilters.directions = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
    
    // New advanced filters - add to activeFilters too
    advancedFilters.propertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
    advancedFilters.wallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
    advancedFilters.floorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
    advancedFilters.propertyType = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
    advancedFilters.salesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
    advancedFilters.parking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
    advancedFilters.elevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
    advancedFilters.registration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
    advancedFilters.nearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
    advancedFilters.windowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
    advancedFilters.specialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
    advancedFilters.worldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
    
    // Update activeFilters with all new advanced filters
    activeFilters.propertyClass = advancedFilters.propertyClass;
    activeFilters.wallMaterial = advancedFilters.wallMaterial;
    activeFilters.floorsTotal = advancedFilters.floorsTotal;
    activeFilters.propertyType = advancedFilters.propertyType;
    activeFilters.salesStart = advancedFilters.salesStart;
    activeFilters.parking = advancedFilters.parking;
    activeFilters.elevator = advancedFilters.elevator;
    activeFilters.registration = advancedFilters.registration;
    activeFilters.nearbyPlaces = advancedFilters.nearbyPlaces;
    activeFilters.windowView = advancedFilters.windowView;
    activeFilters.specialApartments = advancedFilters.specialApartments;
    activeFilters.worldSides = advancedFilters.worldSides;
    advancedFilters.payments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
    
    // Update area range
    const areaFromValue = document.getElementById('areaFrom')?.value;
    const areaToValue = document.getElementById('areaTo')?.value;
    advancedFilters.areaFrom = parseFloat(areaFromValue) || 0;
    advancedFilters.areaTo = parseFloat(areaToValue) || 0;
    
    filterProperties();
    displayActiveFilters();
}

// View switching functions
function switchToListView() {
    document.getElementById('listViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('gridViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'space-y-6';
        // ✅ ИСПРАВЛЕНО: Используем текущие отфильтрованные данные с пагинацией
        const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
        const pageSize = 20;
        const startIndex = (currentPage - 1) * pageSize;
        const pageProperties = dataToUse.slice(startIndex, startIndex + pageSize);
        updatePropertiesList(pageProperties);
    }
}

function switchToGridView() {
    document.getElementById('gridViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('listViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
        // ✅ ИСПРАВЛЕНО: Используем текущие отфильтрованные данные с пагинацией
        const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
        const pageSize = 20;
        const startIndex = (currentPage - 1) * pageSize;
        const pageProperties = dataToUse.slice(startIndex, startIndex + pageSize);
        updatePropertiesList(pageProperties);
    }
}

function switchToMapView() {
    alert('Карта в разработке');
}

// ✅ УДАЛЕНА: Вторая дублирующая функция

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', function() {
    // ✅ ИСПРАВЛЕНО: Вызываем мою переименованную функцию
    initializeClearAllButton();
    initializeAdvancedFilters();
    initializeDropdownFilters();
    
    // Add event listeners for main filter dropdowns to show active filters
    const developerFilter = document.getElementById('developer-filter');
    if (developerFilter) {
        developerFilter.addEventListener('change', function() {
            filterProperties();
            displayActiveFilters();
        });
    }
    
    const districtFilter = document.getElementById('district-filter');
    if (districtFilter) {
        districtFilter.addEventListener('change', function() {
            filterProperties();
            displayActiveFilters();
        });
    }
    
    // Initialize NEW filter dropdowns (registration, nearby places, etc.)
    const filterDropdowns = document.querySelectorAll('.filter-dropdown');
    console.log('Found filter dropdowns:', filterDropdowns.length, filterDropdowns);
    filterDropdowns.forEach(dropdown => {
        const btn = dropdown.querySelector('.dropdown-btn');
        const menu = dropdown.querySelector('.dropdown-menu');
        const arrow = dropdown.querySelector('.dropdown-arrow');
        
        if (btn && menu) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close other filter dropdowns
                filterDropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                        const otherArrow = otherDropdown.querySelector('.dropdown-arrow');
                        if (otherMenu) otherMenu.classList.add('hidden');
                        if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
                    }
                });
                
                // Toggle current dropdown
                const isOpen = !menu.classList.contains('hidden');
                if (isOpen) {
                    menu.classList.add('hidden');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                } else {
                    menu.classList.remove('hidden');
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                }
                
                console.log('Filter dropdown toggled:', dropdown);
                
                // Show dropdown options when opened  
                if (!isOpen) {
                    console.log('Dropdown opened');
                    // Determine filter type from existing checkboxes or button text
                    let filterType = menu.querySelector('input[data-filter]')?.getAttribute('data-filter');
                    
                    if (!filterType) {
                        // If no existing checkboxes, determine from button text
                        const buttonText = btn.textContent.trim();
                        if (buttonText.includes('Прописка')) filterType = 'registration';
                        else if (buttonText.includes('Места рядом')) filterType = 'nearby_places';
                        else if (buttonText.includes('Вид из окон')) filterType = 'window_view';
                        else if (buttonText.includes('Видовые квартиры')) filterType = 'special_apartments';
                        else if (buttonText.includes('Стороны света')) filterType = 'world_sides';
                    }
                    
                    if (filterType) {
                        console.log('Filter type detected:', filterType);
                        showDropdownOptions(menu, filterType);
                    }
                } else {
                    console.log('Dropdown closed');
                }
            });
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-dropdown')) {
            filterDropdowns.forEach(dropdown => {
                const menu = dropdown.querySelector('.dropdown-menu');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                if (menu) menu.classList.add('hidden');
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            });
        }
    });
    
    // Initialize favorite and comparison buttons
    setTimeout(() => {
        initializeAllButtons();
        // Favorites counter now handled by FavoritesManager
        console.log('Initial page setup complete with favorites and comparison');
    }, 100);
    
    // Add click handler for "Еще" dropdown button - make it work like other dropdowns
    const advancedDropdown = document.querySelector('[data-filter="advanced"]');
    if (advancedDropdown) {
        const button = advancedDropdown.querySelector('.dropdown-btn');
        const menu = advancedDropdown.querySelector('.dropdown-menu');
        
        if (button && menu) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close all other dropdowns first
                document.querySelectorAll('.dropdown-menu.open').forEach(otherMenu => {
                    if (otherMenu !== menu) {
                        otherMenu.classList.remove('open');
                    }
                });
                
                // Toggle this dropdown
                menu.classList.toggle('open');
                console.log('Advanced filters toggled:', menu.classList.contains('open'));
            });
        }
    }
    
    // Initialize view mode to list by default
    const container = document.getElementById('properties-container');
    if (container && !container.getAttribute('data-view-mode')) {
        container.setAttribute('data-view-mode', 'list');
    }
    
    console.log('Dropdown filters initialized, including', filterDropdowns.length, 'new filter dropdowns');
    
    // Function to show dropdown options for new filters
    function showDropdownOptions(menu, filterType) {
        console.log('Showing options for filter:', filterType);
        const existingOptions = menu.querySelectorAll('input[type="checkbox"]');
        
        // If options already exist, don't duplicate
        if (existingOptions.length > 0) {
            console.log('Options already exist for', filterType);
            return;
        }
        
        let options = [];
        
        // Define options for each filter type
        switch(filterType) {
            case 'registration':
                options = ['Возможна', 'Невозможна', 'Временная'];
                break;
            case 'nearby_places':
                options = ['Школа', 'Детский сад', 'Больница', 'Супермаркет', 'Транспорт', 'Парк'];
                break;
            case 'window_view':
                options = ['На двор', 'На улицу', 'На море', 'На горы'];
                break;
            case 'special_apartments':
                options = ['Угловая', 'Пентхаус', 'Двухуровневая', 'С террасой'];
                break;
            case 'world_sides':
                options = ['Север', 'Юг', 'Восток', 'Запад'];
                break;
            default:
                console.log('Unknown filter type:', filterType);
                return;
        }
        
        // Create container for options if it doesn't exist
        let container = menu.querySelector('.p-3.space-y-2');
        if (!container) {
            container = document.createElement('div');
            container.className = 'p-3 space-y-2';
            menu.appendChild(container);
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        // Add options
        options.forEach(option => {
            const label = document.createElement('label');
            label.className = 'flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer';
            label.innerHTML = `
                <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="${filterType}" value="${option}" onchange="updateAdvancedFilters()"> ${option}
            `;
            container.appendChild(label);
        });
        
        console.log('Added', options.length, 'options for', filterType);
    }
});

// Check if a specific filter has active values
function checkIfFilterIsActive(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Check if any room checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        case 'price':
            // Check if price inputs have values
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            return (priceFrom && priceFrom.value) || (priceTo && priceTo.value);
            
        case 'completion':
            // Check if any completion checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        default:
            // Generic check for any input with value
            const inputs = dropdown.querySelectorAll('input');
            return Array.from(inputs).some(input => {
                if (input.type === 'checkbox') return input.checked;
                if (input.type === 'text' || input.type === 'number') return input.value;
                return false;
            });
    }
}

// Clear specific filter values via double-click (add separate function)
function clearFilterByDoubleClick(button) {
    const dropdown = button.closest('.filter-dropdown') || button.closest('.dropdown');
    if (!dropdown) return;
    
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = 'Тип квартиры';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            button.textContent = 'Цена от-до, ₽';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = 'Срок сдачи';
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
    console.log('Filter cleared by double-click:', filterType);
}

// Clear specific filter values
function clearSpecificFilter(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const roomsBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (roomsBtn) roomsBtn.textContent = 'Тип квартиры';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            // Update button text
            const priceBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (priceBtn) priceBtn.textContent = 'Цена от-до, ₽';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const completionBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (completionBtn) completionBtn.textContent = 'Срок сдачи';
            break;
            
        default:
            // Generic clear for all inputs
            dropdown.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else input.value = '';
            });
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
}

// Legacy function for backward compatibility 
function initializeFavoriteButtons() {
    initializeAllButtons();
}

// handleFavoriteClick function removed - now handled by FavoritesManager

// Initialize comparison and recommendation buttons only
function initializeAllButtons() {
    // Favorites are now handled by FavoritesManager class
    
    // Clear previous initialization for comparison and recommendation buttons
    document.querySelectorAll('.compare-btn').forEach(btn => {
        if (btn.hasAttribute('data-compare-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-compare-initialized');
        }
    });
    document.querySelectorAll('.recommend-btn').forEach(btn => {
        if (btn.hasAttribute('data-recommend-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-recommend-initialized');
        }
    });
    
    // Favorite buttons are now initialized by FavoritesManager
    // Removed duplicate initialization to prevent conflicts
    
    // Initialize comparison buttons with NEW unified system
    document.querySelectorAll('.compare-btn').forEach(btn => {
        const propertyId = parseInt(btn.getAttribute('data-property-id'));
        
        // Update button state using new system
        if (window.ComparisonManager) {
            window.ComparisonManager.updateButton(propertyId);
        }
        
        // Add event listener if not already added
        if (!btn.hasAttribute('data-compare-initialized')) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                addToCompare(propertyId);
            });
            btn.setAttribute('data-compare-initialized', 'true');
        }
    });
    
    // Initialize recommendation buttons for managers using the new function
    if (window.manager_authenticated) {
        initializeRecommendButtons();
    }
    
    // Clean up old comparison systems and initialize new one
    localStorage.removeItem('propertyComparison'); // Remove old system
    localStorage.removeItem('complexComparison'); // Remove old system
    
    // Initialize comparison counter on page load
    if (window.ComparisonManager) {
        window.ComparisonManager.updateCounters();
    }
    
    console.log('Initialized buttons for', document.querySelectorAll('.property-card').length, 'properties');
}

// Legacy function for backward compatibility
function initializeComparisonButtons() {
    initializeAllButtons();
}

// Legacy toggleFavorite function - now delegates to FavoritesManager
function toggleFavorite(propertyId) {
    if (window.favoritesManager) {
        const heartElement = document.querySelector(`.favorite-heart[data-property-id="${propertyId}"]`);
        window.favoritesManager.toggleFavorite(propertyId, heartElement);
    } else {
        console.error('FavoritesManager not initialized');
    }
}

// NEW UNIFIED COMPARISON SYSTEM
window.ComparisonManager = {
    // Get current comparison data
    getData: function() {
        return JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
    },
    
    // Save comparison data
    saveData: function(data) {
        localStorage.setItem('comparison-data', JSON.stringify(data));
        this.updateCounters();
    },
    
    // Add property to comparison
    addProperty: function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (!data.properties.includes(idStr)) {
            if (data.properties.length >= 3) {
                this.showMessage('Можно сравнивать максимум 3 квартиры', 'warning');
                return false;
            }
            data.properties.push(idStr);
            this.saveData(data);
            this.showMessage('Квартира добавлена в сравнение', 'success');
            console.log('Property added to comparison:', propertyId);
            return true;
        }
        return false;
    },
    
    // Remove property from comparison
    removeProperty: function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (data.properties.includes(idStr)) {
            data.properties = data.properties.filter(id => id !== idStr);
            this.saveData(data);
            this.showMessage('Квартира удалена из сравнения', 'info');
            console.log('Property removed from comparison:', propertyId);
            return true;
        }
        return false;
    },
    
    // Check if property is in comparison
    hasProperty: function(propertyId) {
        const data = this.getData();
        return data.properties.includes(propertyId.toString());
    },
    
    // Update all counters
    updateCounters: function() {
        const data = this.getData();
        const totalCount = data.properties.length + data.complexes.length;
        
        // Update global comparison counter in header
        const globalCounter = document.getElementById('comparison-count');
        if (globalCounter) {
            globalCounter.textContent = totalCount;
            globalCounter.style.display = totalCount > 0 ? 'flex' : 'none';
        }
        
        // Update dashboard counters if available
        const propertiesCount = document.getElementById('properties-tab-count');
        if (propertiesCount) {
            propertiesCount.textContent = data.properties.length;
        }
        
        const complexesCount = document.getElementById('complexes-tab-count');
        if (complexesCount) {
            complexesCount.textContent = data.complexes.length;
        }
    },
    
    // Show notification message
    showMessage: function(message, type = 'info') {
        if (typeof showNotification === 'function') {
            showNotification(message, type);
        } else {
            console.log(`[${type}] ${message}`);
        }
    },
    
    // Update button state
    updateButton: function(propertyId) {
        const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
        if (!button) return;
        
        const isInComparison = this.hasProperty(propertyId);
        
        if (isInComparison) {
            button.classList.add('added', 'bg-[#0088CC]', 'text-white');
            button.classList.remove('border-gray-300', 'hover:bg-gray-50', 'text-gray-700');
            button.innerHTML = '<i class="fas fa-check mr-1"></i><span class="compare-text">В сравнении</span>';
        } else {
            button.classList.remove('added', 'bg-[#0088CC]', 'text-white');
            button.classList.add('border-gray-300', 'hover:bg-gray-50', 'text-gray-700');
            button.innerHTML = '<i class="fas fa-balance-scale mr-1"></i><span class="compare-text">Сравнить</span>';
        }
    }
};

// Main comparison function
function addToCompare(propertyId) {
    // Prevent rapid clicks
    const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
    if (button && button.disabled) return;
    
    // Temporarily disable button
    if (button) {
        button.disabled = true;
        setTimeout(() => button.disabled = false, 500);
    }
    
    // Toggle comparison state
    if (window.ComparisonManager.hasProperty(propertyId)) {
        window.ComparisonManager.removeProperty(propertyId);
    } else {
        window.ComparisonManager.addProperty(propertyId);
    }
    
    // Update button appearance
    window.ComparisonManager.updateButton(propertyId);
}



// Sort Properties Function
function sortProperties() {
    const sortBy = document.getElementById('sort-select').value;
    currentSortBy = sortBy;
    
    // ✅ Если выбран placeholder "Сортировать", сбрасываем сортировку
    if (!sortBy || sortBy === '') {
        console.log('🔄 Сброс сортировки - возврат к исходному порядку');
        
        // Восстанавливаем исходный порядок из allProperties
        filteredProperties = allProperties.slice();
        
        // Применяем текущие фильтры заново
        if (typeof filterProperties === 'function') {
            filterProperties();
        } else {
            // Простой сброс на первую страницу
            currentPage = 1;
            const totalPages = Math.ceil(filteredProperties.length / 20);
            updatePaginationControls(filteredProperties.length, totalPages);
            
            const pageProperties = filteredProperties.slice(0, 20);
            updatePropertiesList(pageProperties);
            updateResultsCount(filteredProperties.length);
            
            console.log('✅ Сортировка сброшена, показано объектов:', pageProperties.length);
        }
        return;
    }
    
    // ✅ ИСПРАВЛЕНО: Если filteredProperties пустой, используем allProperties
    if (!filteredProperties || filteredProperties.length === 0) {
        filteredProperties = allProperties.slice(); // Копируем массив
        console.log('📦 Используем все объекты для сортировки:', filteredProperties.length);
    }
    
    console.log('🔄 Сортировка по:', sortBy);
    console.log('📊 Количество объектов для сортировки:', filteredProperties.length);
    
    if (filteredProperties.length === 0) {
        console.log('❌ Нет объектов для сортировки');
        return;
    }
    
    filteredProperties.sort((a, b) => {
        switch(sortBy) {
            case 'price-asc':
                return a.price - b.price;
            case 'price-desc':
                return b.price - a.price;
            case 'area-asc':
                return parseFloat(a.object_area || 0) - parseFloat(b.object_area || 0);
            case 'area-desc':
                return parseFloat(b.object_area || 0) - parseFloat(a.object_area || 0);
            case 'date-desc':
                // Сортировка по дате сдачи (completion_date)
                const dateA = a.completion_date || '2030';
                const dateB = b.completion_date || '2030'; 
                return dateB.localeCompare(dateA);
            default:
                return b.price - a.price;
        }
    });
    
    // ✅ ИСПРАВЛЕНО: Сбрасываем на первую страницу после сортировки
    currentPage = 1;
    
    // ✅ ИСПРАВЛЕНО: Используем существующую функцию пагинации
    const totalPages = Math.ceil(filteredProperties.length / 20);
    updatePaginationControls(filteredProperties.length, totalPages);
    
    // Передаем только объекты первой страницы после сортировки
    const pageSize = 20;
    const pageProperties = filteredProperties.slice(0, pageSize);
    updatePropertiesList(pageProperties);
    
    // ✅ ДОБАВЛЕНО: Обновляем счетчик объектов после сортировки
    updateResultsCount(filteredProperties.length);
    
    console.log('✅ Объекты отсортированы по:', sortBy);
    console.log('📄 Показана страница 1, объектов:', pageProperties.length);
}

// View Mode Toggle Functions
function switchToListView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - list view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'list');
    
    // Update button styles
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // ✅ ИСПРАВЛЕНО: Re-render properties with list view - только текущая страница
    const dataToUse = filteredProperties.length > 0 ? filteredProperties : allProperties;
    const pageSize = 20;
    const startIndex = (currentPage - 1) * pageSize;
    const pageProperties = dataToUse.slice(startIndex, startIndex + pageSize);
    updatePropertiesList(pageProperties);
    console.log('Switched to list view');
}

function switchToGridView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - grid view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'grid');
    
    // Update button styles
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // ✅ ИСПРАВЛЕНО: Re-render properties with grid view - только текущая страница  
    const dataToUse = filteredProperties.length > 0 ? filteredProperties : allProperties;
    const pageSize = 20;
    const startIndex = (currentPage - 1) * pageSize;
    const pageProperties = dataToUse.slice(startIndex, startIndex + pageSize);
    updatePropertiesList(pageProperties);
    console.log('Switched to grid view');
}

// Save search dropdown functions
function toggleSaveSearchDropdown() {
    const dropdown = document.getElementById('saveSearchDropdown');
    const isHidden = dropdown.classList.contains('hidden');
    
    if (isHidden) {
        // Close other dropdowns
        document.querySelectorAll('.dropdown-menu.open, .filter-dropdown-menu:not(.hidden)').forEach(menu => {
            menu.classList.add('hidden');
            menu.classList.remove('open');
        });
        
        dropdown.classList.remove('hidden');
        
        // Auto-generate search name
        const searchName = generateSearchName();
        document.getElementById('searchNameInput').value = searchName;
    } else {
        dropdown.classList.add('hidden');
    }
}

function closeSaveSearchDropdown() {
    document.getElementById('saveSearchDropdown').classList.add('hidden');
}

function generateSearchName() {
    const searchData = getCurrentSearchData();
    let searchName = 'Поиск ';
    
    if (searchData.rooms.length > 0) {
        searchName += searchData.rooms.join(', ') + ' ';
    }
    if (searchData.districts.length > 0) {
        searchName += 'в ' + searchData.districts.slice(0, 2).join(', ');
        if (searchData.districts.length > 2) {
            searchName += ` и ещё ${searchData.districts.length - 2}`;
        }
    }
    if (searchData.propertyClass && searchData.propertyClass.length > 0) {
        searchName += `, ${searchData.propertyClass.join(', ')}`;
    }
    if (searchData.wallMaterial && searchData.wallMaterial.length > 0) {
        searchName += `, ${searchData.wallMaterial.join(', ')}`;
    }
    if (searchData.floorsTotal && searchData.floorsTotal.length > 0) {
        searchName += `, ${searchData.floorsTotal.join(', ')}`;
    }
    if (searchData.priceFrom || searchData.priceTo) {
        searchName += `, ${searchData.priceFrom || '0'}-${searchData.priceTo || '∞'} млн`;
    }
    
    return searchName.trim() || `Поиск ${new Date().toLocaleDateString()}`;
}

function getCurrentSearchData() {
    // Get current active filters from the global activeFilters object if available
    if (typeof activeFilters !== 'undefined' && Object.keys(activeFilters).length > 0) {
        const data = {
            districts: activeFilters.districts || [],
            developers: activeFilters.developers || [],
            rooms: activeFilters.rooms || [],
            completion: activeFilters.completion || [],
            propertyClass: activeFilters.propertyClass || [],
            wallMaterial: activeFilters.wallMaterial || [],
            floorsTotal: activeFilters.floorsTotal || [],
            priceFrom: activeFilters.priceFrom || '',
            priceTo: activeFilters.priceTo || '',
            areaFrom: activeFilters.areaFrom || '',
            areaTo: activeFilters.areaTo || ''
        };
        console.log('Using activeFilters for search data:', data);
        return data;
    }
    
    // Collect from quick filters and advanced filters (no duplicates)
    const data = {
        districts: [
            // Only quick filters (removed from advanced to avoid duplication)
            ...Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(el => el.value)
        ],
        developers: [
            // Quick filters (data-filter-type)  
            ...Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(el => el.value),
            // Advanced filters (data-filter)
            ...Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(el => el.value)
        ],
        rooms: [
            // Only quick filters (removed from advanced to avoid duplication)
            ...Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(el => el.value)
        ],
        completion: [
            // Quick filters (data-filter-type)
            ...Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(el => el.value)
        ],
        // New advanced-only filters
        propertyClass: Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(el => el.value),
        wallMaterial: Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(el => el.value),
        floorsTotal: Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(el => el.value),
        priceFrom: document.getElementById('priceFrom')?.value || '',
        priceTo: document.getElementById('priceTo')?.value || '',
        areaFrom: document.getElementById('areaFrom')?.value || '',
        areaTo: document.getElementById('areaTo')?.value || ''
    };
    console.log('Using DOM queries for search data:', data);
    return data;
}

// Enhanced save search function
async function saveSearchWithOptions() {
    const userId = {{ current_user.id if current_user.is_authenticated else 'null' }};
    const managerId = {{ session.get('manager_id', 'null') }};
    const userRole = '{{ current_user.role if current_user.is_authenticated else "" }}';
    const managerRole = {{ 'true' if session.get('is_manager') else 'false' }};
    
    if (!userId && !managerId) {
        alert('Для сохранения поиска необходимо войти в систему');
        return;
    }
    
    const searchName = document.getElementById('searchNameInput').value.trim();
    const clientEmail = document.getElementById('clientEmailInput')?.value.trim() || '';
    
    if (!searchName) {
        alert('Введите название поиска');
        return;
    }
    
    const searchData = getCurrentSearchData();
    
    // Check if any filters are selected (including new advanced filters)
    const hasFilters = searchData.districts.length > 0 || 
                      searchData.developers.length > 0 || 
                      searchData.rooms.length > 0 || 
                      searchData.completion.length > 0 ||
                      (searchData.propertyClass && searchData.propertyClass.length > 0) ||
                      (searchData.wallMaterial && searchData.wallMaterial.length > 0) ||
                      (searchData.floorsTotal && searchData.floorsTotal.length > 0) ||
                      searchData.priceFrom || searchData.priceTo ||
                      searchData.areaFrom || searchData.areaTo;
    
    if (!hasFilters) {
        alert('Выберите хотя бы один фильтр для сохранения поиска');
        return;
    }
    
    try {
        console.log('Saving search with data:', searchData);
        
        const requestData = {
            name: searchName,
            filters: searchData
        };
        
        // Add client email for managers
        if (managerRole && clientEmail) {
            requestData.client_email = clientEmail;
        }
        
        console.log('Request data:', requestData);
        
        // Choose endpoint based on user type
        const endpoint = managerRole ? '/api/manager/saved-searches' : '/api/searches';
        
        console.log('Manager detection debug:', {
            managerRole: managerRole,
            managerId: managerId, 
            endpoint: endpoint
        });
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            closeSaveSearchDropdown();
            
            if (clientEmail && managerRole) {
                alert(`Поиск успешно сохранён и отправлен клиенту на ${clientEmail}!`);
            } else {
                alert('Поиск успешно сохранён!');
            }
        } else {
            const error = await response.json();
            alert('Ошибка при сохранении поиска: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error saving search:', error);
        alert('Ошибка при сохранении поиска. Попробуйте позже.');
    }
}

// Legacy function for backward compatibility
async function saveCurrentSearch() {
    toggleSaveSearchDropdown();
    
    // Use the unified getCurrentSearchData function
    const searchData = getCurrentSearchData();
    
    // Check if any filters are selected (including new advanced filters)  
    const hasFilters = searchData.districts.length > 0 || 
                      searchData.developers.length > 0 || 
                      searchData.rooms.length > 0 || 
                      searchData.completion.length > 0 ||
                      (searchData.propertyClass && searchData.propertyClass.length > 0) ||
                      (searchData.wallMaterial && searchData.wallMaterial.length > 0) ||
                      (searchData.floorsTotal && searchData.floorsTotal.length > 0) ||
                      searchData.priceFrom || searchData.priceTo ||
                      searchData.areaFrom || searchData.areaTo;
    
    if (!hasFilters) {
        alert('Выберите хотя бы один фильтр для сохранения поиска');
        return;
    }
    
    // Generate search name using the unified function
    const searchName = generateSearchName();
    
    try {
        const response = await fetch('/api/searches', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: searchName.trim(),
                filters: searchData
            })
        });
        
        if (response.ok) {
            alert('Поиск успешно сохранён!');
        } else {
            const error = await response.json();
            alert('Ошибка при сохранении поиска: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error saving search:', error);
        alert('Ошибка при сохранении поиска. Попробуйте позже.');
    }
}

// Legacy function compatibility
function updateComparisonCounter() {
    if (window.ComparisonManager) {
        window.ComparisonManager.updateCounters();
    }
}

// Legacy function compatibility
window.removeFromComparison = function(propertyId) {
    if (window.ComparisonManager) {
        window.ComparisonManager.removeProperty(propertyId);
        window.ComparisonManager.updateButton(propertyId);
    }
}

// Update active filters display
function updateActiveFiltersDisplay(filters) {
    const filtersToShow = filters || activeFilters;
    console.log('Updating active filters display:', filtersToShow);
    
    // Get URL parameters for price display
    const urlParams = new URLSearchParams(window.location.search);
    const priceMin = urlParams.get('price_min');
    const priceMax = urlParams.get('price_max');
    const district = urlParams.get('district');
    
    // Update active filters with URL parameters if available
    if (priceMin || priceMax) {
        filtersToShow.priceFrom = priceMin ? (parseInt(priceMin) / 1000000) : 0;
        filtersToShow.priceTo = priceMax ? (parseInt(priceMax) / 1000000) : 0;
    }
    
    if (district && !filtersToShow.districts.includes(district)) {
        filtersToShow.districts = [district];
    }
    
    console.log('Updated filters with URL params:', filtersToShow);
}

// Apply URL filters function for saved searches
function applyFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.toString() === '') return; // No URL parameters
    
    console.log('Applying filters from URL:', urlParams.toString());
    
    // Reset all filters first
    activeFilters = {
        rooms: [],
        districts: [],
        developers: [],
        completion: [],
        propertyClass: [],
        wallMaterial: [],
        floorsTotal: [],
        priceFrom: 0,
        priceTo: 0
    };
    
    // Clear all checkboxes and inputs
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => input.value = '');
    
    // Check for simple array parameters first (rooms[], districts[], etc.)
    urlParams.forEach((value, key) => {
        if (key.endsWith('[]')) {
            const filterKey = key.slice(0, -2);
            if (!activeFilters[filterKey]) {
                activeFilters[filterKey] = [];
            }
            activeFilters[filterKey].push(value);
            
            // Check corresponding checkbox
            const checkbox = document.querySelector(`input[data-filter-type="${filterKey}"][value="${value}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        } else if (['rooms', 'districts', 'developers', 'completion'].includes(key)) {
            // Handle single values for filter types (from saved searches)
            if (!activeFilters[key]) {
                activeFilters[key] = [];
            }
            // Split multiple values by comma if they exist
            let values = value.split(',').map(v => v.trim()).filter(v => v);
            
            // Transform room type values to match server expectations
            if (key === 'rooms') {
                values = values.map(val => {
                    if (val.includes('комнат')) {
                        // Extract number from "1-комнатная", "2-комнатная", etc.
                        const match = val.match(/(\d+)/);
                        return match ? match[1] : val;
                    }
                    return val;
                });
            }
            
            activeFilters[key] = activeFilters[key].concat(values);
            
            // Check corresponding checkboxes
            values.forEach(val => {
                const checkbox = document.querySelector(`input[data-filter-type="${key}"][value="${val}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    console.log(`Checked ${key} checkbox for value: ${val}`);
                }
            });
        } else if (['priceFrom', 'priceTo', 'areaFrom', 'areaTo'].includes(key)) {
            activeFilters[key] = parseFloat(value) || 0;
            const input = document.getElementById(key);
            if (input) {
                input.value = value;
            }
        } else if (key === 'price_min' || key === 'price_max') {
            // Handle price parameters from saved searches
            const priceInMillions = parseFloat(value) / 1000000;
            if (key === 'price_min') {
                activeFilters.priceFrom = priceInMillions;
                const input = document.getElementById('priceFrom');
                if (input) input.value = priceInMillions;
            } else {
                activeFilters.priceTo = priceInMillions;
                const input = document.getElementById('priceTo');
                if (input) input.value = priceInMillions;
            }
        } else if (key === 'district') {
            // Handle single district parameter
            if (!activeFilters.districts.includes(value)) {
                activeFilters.districts.push(value);
            }
            const checkbox = document.querySelector(`input[data-filter-type="districts"][value="${value}"]`);
            if (checkbox) {
                checkbox.checked = true;
                console.log(`Checked district checkbox for value: ${value}`);
            }
        } else if (key === 'complex' || key === 'residential_complex') {
            // Handle complex parameter (ЖК name) - filter properties by residential complex
            activeFilters.complex = decodeURIComponent(value); // ✅ Декодируем URL параметр
            console.log(`🎯 Applied complex filter from "${key}": "${activeFilters.complex}"`);
            console.log(`🔗 Original URL value: "${value}"`);
            
            // ✅ ИСПРАВЛЕНО: Убеждаемся что window.activeFilters тоже установлен
            window.activeFilters = window.activeFilters || {};
            window.activeFilters.complex = activeFilters.complex;
            
            // Also set it as search to show in search input
            const searchInput = document.getElementById('property-search');
            if (searchInput) {
                searchInput.value = activeFilters.complex;
            }
            
            // ✅ ВАЖНО: Применяем фильтр НЕМЕДЛЕННО после установки
            console.log('🔄 Running filterProperties() for complex filter...');
            filterProperties();
            
            // ✅ ИСПРАВЛЕНО: Вызываем displayActiveFilters() для показа активного фильтра ЖК
            setTimeout(() => {
                displayActiveFilters();
                console.log('🎯 Called displayActiveFilters() for complex filter');
            }, 100);
        } else if (key === 'developer') {
            // Handle developer parameter
            if (!activeFilters.developers.includes(value)) {
                activeFilters.developers.push(value);
            }
            const checkbox = document.querySelector(`input[data-filter-type="developer"][value="${value}"]`);
            if (checkbox) {
                checkbox.checked = true;
                console.log(`Checked developer checkbox for value: ${value}`);
            }
        }
    });
    
    // Check for complex additional_filters parameter (from dashboard)
    const additionalFilters = urlParams.get('additional_filters');
    if (additionalFilters) {
        try {
            const parsedFilters = JSON.parse(decodeURIComponent(additionalFilters));
            console.log('Parsed additional filters:', parsedFilters);
            
            // Apply rooms filter - check BOTH quick and advanced filters
            if (parsedFilters.rooms && parsedFilters.rooms.length > 0) {
                activeFilters.rooms = parsedFilters.rooms;
                parsedFilters.rooms.forEach(room => {
                    // Check quick filters (data-filter-type)
                    const quickCheckbox = document.querySelector(`input[data-filter-type="rooms"][value="${room}"]`);
                    if (quickCheckbox) {
                        quickCheckbox.checked = true;
                        console.log(`Checked quick rooms checkbox for value: ${room}`);
                    }
                    
                    // Check advanced filters (data-filter)
                    const advancedCheckbox = document.querySelector(`input[data-filter="rooms"][value="${room}"]`);
                    if (advancedCheckbox) {
                        advancedCheckbox.checked = true;
                        console.log(`Checked advanced rooms checkbox for value: ${room}`);
                    }
                });
            }
            
            // Apply other array filters - check BOTH quick and advanced filters
            ['districts', 'developers', 'completion', 'propertyClass', 'wallMaterial', 'floorsTotal'].forEach(filterType => {
                if (parsedFilters[filterType] && parsedFilters[filterType].length > 0) {
                    activeFilters[filterType] = parsedFilters[filterType];
                    parsedFilters[filterType].forEach(value => {
                        // For districts and rooms - only check quick filters (no duplication)
                        if (filterType === 'districts') {
                            const quickCheckbox = document.querySelector(`input[data-filter-type="district"][value="${value}"]`);
                            if (quickCheckbox) {
                                quickCheckbox.checked = true;
                                console.log(`Checked quick district checkbox for value: ${value}`);
                            }
                        }
                        // For developers - check both quick and advanced
                        else if (filterType === 'developers') {
                            const quickCheckbox = document.querySelector(`input[data-filter-type="developer"][value="${value}"]`);
                            if (quickCheckbox) {
                                quickCheckbox.checked = true;
                                console.log(`Checked quick developer checkbox for value: ${value}`);
                            }
                            const advancedCheckbox = document.querySelector(`input[data-filter="developer"][value="${value}"]`);
                            if (advancedCheckbox) {
                                advancedCheckbox.checked = true;
                                console.log(`Checked advanced developer checkbox for value: ${value}`);
                            }
                        }
                        // For completion - only quick filters
                        else if (filterType === 'completion') {
                            const quickCheckbox = document.querySelector(`input[data-filter-type="completion"][value="${value}"]`);
                            if (quickCheckbox) {
                                quickCheckbox.checked = true;
                                console.log(`Checked quick completion checkbox for value: ${value}`);
                            }
                        }
                        // For new advanced-only filters
                        else if (['propertyClass', 'wallMaterial', 'floorsTotal'].includes(filterType)) {
                            const filterName = filterType.replace(/([A-Z])/g, '_$1').toLowerCase();
                            const advancedCheckbox = document.querySelector(`input[data-filter="${filterName}"][value="${value}"]`);
                            if (advancedCheckbox) {
                                advancedCheckbox.checked = true;
                                console.log(`Checked advanced ${filterName} checkbox for value: ${value}`);
                            }
                        }
                    });
                }
            });
            
            // Apply price and area filters
            if (parsedFilters.priceFrom) {
                activeFilters.priceFrom = parseFloat(parsedFilters.priceFrom) || 0;
                const input = document.getElementById('priceFrom');
                if (input) input.value = parsedFilters.priceFrom;
            }
            if (parsedFilters.priceTo) {
                activeFilters.priceTo = parseFloat(parsedFilters.priceTo) || 0;
                const input = document.getElementById('priceTo');
                if (input) input.value = parsedFilters.priceTo;
            }
            if (parsedFilters.areaFrom) {
                activeFilters.areaFrom = parseFloat(parsedFilters.areaFrom) || 0;
                const input = document.getElementById('areaFrom');
                if (input) input.value = parsedFilters.areaFrom;
            }
            if (parsedFilters.areaTo) {
                activeFilters.areaTo = parseFloat(parsedFilters.areaTo) || 0;
                const input = document.getElementById('areaTo');
                if (input) input.value = parsedFilters.areaTo;
            }
        } catch (error) {
            console.error('Error parsing additional_filters:', error);
        }
    }
    
    // Apply filters to properties
    if (Object.keys(activeFilters).some(key => 
        Array.isArray(activeFilters[key]) ? activeFilters[key].length > 0 : activeFilters[key] > 0
    )) {
        console.log('Applied URL filters:', activeFilters);
        filterProperties();
        updateActiveFiltersDisplay();
    }
}

// Initialize URL filter application on page load
document.addEventListener('DOMContentLoaded', function() {
    // ⚡ УСКОРЕНО: применяем фильтры сразу без задержки  
    applyFiltersFromURL();
});

// Recommendation system for managers
function initializeRecommendButtons() {
    console.log('Initializing recommend buttons...');
    
    // Remove existing listeners and add new ones directly to buttons
    document.querySelectorAll('.recommend-btn').forEach(btn => {
        if (btn.hasAttribute('data-listener-added')) return;
        
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const propertyId = this.dataset.propertyId;
            const propertyName = this.dataset.propertyName;
            const complexName = this.dataset.complexName;
            
            console.log('Recommend button clicked:', {propertyId, propertyName, complexName});
            
            if (!propertyId) {
                console.error('Property ID is missing');
                alert('Ошибка: отсутствует ID объекта');
                return;
            }
            
            // Create property data object
            const property = {
                id: propertyId,
                name: propertyName || `Объект ${propertyId}`,
                complex_name: complexName || '',
                rooms: 'н/д'
            };
            
            console.log('Using property data:', property);
            openRecommendModal('property', propertyId, property);
        });
        
        btn.setAttribute('data-listener-added', 'true');
    });
    
    console.log('Recommend buttons initialized:', document.querySelectorAll('.recommend-btn').length);
}

function openRecommendModal(type, itemId, itemData) {
    const modal = document.getElementById('recommendModal') || createRecommendModal();
    
    console.log('Opening recommend modal with:', {type, itemId, itemData});
    
    // Determine item name based on type
    let itemName = '';
    if (type === 'property') {
        itemName = itemData.name || itemData.title || `Квартира ${itemData.rooms}к` || 'Недвижимость';
    } else if (type === 'complex') {
        itemName = itemData.name || itemData.title || 'ЖК';
    }
    
    // Fill modal with data
    const typeField = document.getElementById('recommendType');
    const idField = document.getElementById('recommendItemId');
    const nameField = document.getElementById('recommendItemName');
    const titleField = document.getElementById('recommendTitle');
    
    if (!typeField || !idField || !nameField || !titleField) {
        console.error('Modal fields not found');
        return;
    }
    
    typeField.value = type;
    idField.value = String(itemId);
    nameField.value = itemName;
    titleField.value = `Рекомендую: ${itemName}`;
    
    console.log('Modal fields set:', {
        type: typeField.value,
        itemId: idField.value,
        itemName: nameField.value,
        title: titleField.value
    });
    
    // Load clients if not already loaded
    loadClientsForRecommendation();
    
    // Show modal
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function createRecommendModal() {
    const modal = document.createElement('div');
    modal.id = 'recommendModal';
    modal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 z-50 justify-center items-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Отправить рекомендацию клиенту</h3>
                <button onclick="closeRecommendModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="recommendForm" class="space-y-4">
                <input type="hidden" id="recommendType">
                <input type="hidden" id="recommendItemId">
                <input type="hidden" id="recommendItemName">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Заголовок рекомендации</label>
                    <input type="text" id="recommendTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Клиент *</label>
                    <select id="recommendClientSelect" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]">
                        <option value="">Выберите клиента...</option>
                    </select>
                    <input type="hidden" id="recommendClientEmail">
                </div>
                
                <div id="categorySection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Категория рекомендации</label>
                    <div class="space-y-2">
                        <select id="recommendCategorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]">
                            <option value="">Без категории</option>
                            <option value="new">+ Создать новую категорию</option>
                        </select>
                        <div id="newCategoryInput" class="hidden">
                            <input type="text" id="recommendCategoryName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]" placeholder="Например: Однокомнатные до 5 млн, Черемушки">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Описание (опционально)</label>
                    <textarea id="recommendDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]" placeholder="Краткое описание для клиента"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ваши заметки</label>
                    <textarea id="recommendNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]" placeholder="Почему рекомендуете этот объект"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Приоритет</label>
                    <select id="recommendPriority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#0088CC] focus:border-[#0088CC]">
                        <option value="normal">Обычный</option>
                        <option value="high">Высокий</option>
                        <option value="urgent">Срочный</option>
                    </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" id="submitRecommendBtn" class="flex-1 px-4 py-2 bg-[#0088CC] text-white rounded-md hover:bg-[#0077BB] transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane mr-2" id="submitIcon"></i>
                        <span class="loading-spinner hidden mr-2">
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        <span id="submitText">Отправить рекомендацию</span>
                    </button>
                    <button type="button" onclick="closeRecommendModal()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                        Отмена
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add form submit handler
    document.getElementById('recommendForm').addEventListener('submit', handleRecommendSubmit);
    
    // Load clients list
    loadClientsForRecommendation();
    
    return modal;
}

// Load clients for recommendation dropdown
async function loadClientsForRecommendation() {
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        const select = document.getElementById('recommendClientSelect');
        select.innerHTML = '<option value="">Выберите клиента...</option>';
        
        if (data.success && data.clients) {
            data.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.full_name} (${client.email})`;
                option.dataset.email = client.email;
                select.appendChild(option);
            });
            
            // Add change handler
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const emailInput = document.getElementById('recommendClientEmail');
                const categorySection = document.getElementById('categorySection');
                
                if (selectedOption.dataset.email) {
                    emailInput.value = selectedOption.dataset.email;
                    categorySection.classList.remove('hidden');
                    loadRecommendationCategories(this.value);
                } else {
                    emailInput.value = '';
                    categorySection.classList.add('hidden');
                }
            });
        }
    } catch (error) {
        console.error('Error loading clients:', error);
    }
}

// Load recommendation categories for selected client
async function loadRecommendationCategories(clientId) {
    try {
        const response = await fetch(`/api/manager/recommendation-categories/${clientId}`);
        const data = await response.json();
        
        const select = document.getElementById('recommendCategorySelect');
        select.innerHTML = '<option value="">Без категории</option><option value="new">+ Создать новую категорию</option>';
        
        if (data.success && data.categories) {
            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.recommendations_count})`;
                select.appendChild(option);
            });
        }
        
        // Add change handler for category selection
        select.addEventListener('change', function() {
            const newCategoryInput = document.getElementById('newCategoryInput');
            if (this.value === 'new') {
                newCategoryInput.classList.remove('hidden');
            } else {
                newCategoryInput.classList.add('hidden');
            }
        });
        
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function closeRecommendModal() {
    const modal = document.getElementById('recommendModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('recommendForm').reset();
        
        // Reset button state
        const submitBtn = document.getElementById('submitRecommendBtn');
        const submitIcon = document.getElementById('submitIcon');
        const submitText = document.getElementById('submitText');
        const spinner = submitBtn.querySelector('.loading-spinner');
        
        if (submitBtn && submitIcon && submitText && spinner) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-green-500');
            submitBtn.classList.add('bg-[#0088CC]', 'hover:bg-[#0077BB]');
            spinner.classList.add('hidden');
            submitIcon.classList.remove('hidden');
            submitIcon.className = 'fas fa-paper-plane mr-2';
            submitText.textContent = 'Отправить рекомендацию';
        }
    }
}

function showRecommendationLoading() {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    if (submitBtn && submitIcon && submitText && spinner) {
        submitBtn.disabled = true;
        submitIcon.classList.add('hidden');
        spinner.classList.remove('hidden');
        submitText.textContent = 'Отправка...';
    }
}

function showRecommendationSuccess() {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    if (submitBtn && submitIcon && submitText && spinner) {
        spinner.classList.add('hidden');
        submitIcon.classList.remove('hidden');
        submitIcon.className = 'fas fa-check mr-2';
        submitText.textContent = 'Отправлено!';
        submitBtn.classList.remove('bg-[#0088CC]', 'hover:bg-[#0077BB]');
        submitBtn.classList.add('bg-green-500');
    }
}

function showRecommendationError(message) {
    const submitBtn = document.getElementById('submitRecommendBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    if (submitBtn && submitIcon && submitText && spinner) {
        submitBtn.disabled = false;
        spinner.classList.add('hidden');
        submitIcon.classList.remove('hidden');
        submitIcon.className = 'fas fa-paper-plane mr-2';
        submitText.textContent = 'Отправить рекомендацию';
    }
    
    alert(message);
}

async function handleRecommendSubmit(e) {
    e.preventDefault();
    
    const clientSelect = document.getElementById('recommendClientSelect');
    const selectedClientId = clientSelect.value;
    
    if (!selectedClientId) {
        alert('Выберите клиента для отправки рекомендации');
        return;
    }
    
    const categorySelect = document.getElementById('recommendCategorySelect');
    const categoryValue = categorySelect ? categorySelect.value : '';
    const categoryName = categoryValue === 'new' ? document.getElementById('recommendCategoryName').value.trim() : '';
    
    const formData = {
        recommendation_type: document.getElementById('recommendType').value,
        item_id: document.getElementById('recommendItemId').value,
        item_name: document.getElementById('recommendItemName').value,
        title: document.getElementById('recommendTitle').value.trim(),
        client_id: selectedClientId,
        client_email: document.getElementById('recommendClientEmail').value.trim(),
        description: document.getElementById('recommendDescription').value.trim(),
        manager_notes: document.getElementById('recommendNotes').value.trim(),
        priority_level: document.getElementById('recommendPriority').value,
        category_id: categoryValue,
        category_name: categoryName,
        highlighted_features: [], // Can be expanded later
        item_data: {} // Can include full property data
    };
    
    if (!formData.title) {
        alert('Введите заголовок рекомендации');
        return;
    }
    
    // Show loading state
    showRecommendationLoading();
    
    try {
        // Debug log the form data being sent
        console.log('Sending recommendation with data:', formData);
        
        const response = await fetch('/api/manager/send_recommendation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showRecommendationSuccess();
            
            setTimeout(() => {
                closeRecommendModal();
                if (result.sent_to_client) {
                    alert(`Рекомендация успешно отправлена клиенту на ${formData.client_email}!`);
                } else {
                    alert('Рекомендация сохранена, но email не был отправлен. Проверьте настройки уведомлений.');
                }
            }, 1500);
        } else {
            const error = await response.json();
            showRecommendationError('Ошибка при отправке рекомендации: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error sending recommendation:', error);
        showRecommendationError('Ошибка при отправке рекомендации. Попробуйте позже.');
    }
}

// Initialize recommendation buttons when manager authenticated
if (window.manager_authenticated) {
    console.log('Manager authenticated, recommendation buttons will be initialized');
    // Initialize buttons on page load
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            initializeRecommendButtons();
        }, 1000);
    });
}

// Smart Search Integration
function initializeSmartSearch() {
    console.log('Initializing smart search integration...');
    
    // Test smart search API on page load
    testSmartSearchAPI();
}

function testSmartSearchAPI() {
    // ✅ ОТКЛЮЧЕН: тест API замедлял загрузку страницы
    console.log('Smart search API test disabled for faster loading');
}

function showSmartSearchStatus(isWorking, data = null) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${isWorking ? 'bg-green-500' : 'bg-red-500'} text-white`;
    
    let detailText = isWorking ? 'OpenAI интеграция работает' : 'Используется обычный поиск';
    if (data && data.criteria) {
        const criteriaCount = Object.keys(data.criteria).length;
        detailText = `Найдено ${criteriaCount} критериев поиска`;
    }
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${isWorking ? 'fa-brain' : 'fa-exclamation-triangle'} mr-2"></i>
            <div>
                <div class="font-semibold">${isWorking ? 'Умный поиск активирован!' : 'Умный поиск недоступен'}</div>
                <div class="text-sm">${detailText}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// ✅ ОТКЛЮЧЕНО: initializeSmartSearch замедлял загрузку /properties на 2 секунды
// document.addEventListener('DOMContentLoaded', function() {
//     setTimeout(() => {
//         initializeSmartSearch();
//     }, 2000); // Wait 2 seconds after page load
// });

// Ensure proper script closure
console.log('Properties page script loaded with smart search integration');

// PDF функция удалена - теперь используем прямые ссылки на property_pdf

// Show notification function (same style as favorites)
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
    
    // Style based on type
    if (type === 'success') {
        notification.classList.add('bg-green-500', 'text-white');
        notification.innerHTML = `<i class="fas fa-balance-scale mr-2"></i>${message}`;
    } else if (type === 'warning') {
        notification.classList.add('bg-yellow-500', 'text-white');
        notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
    } else {
        notification.classList.add('bg-blue-500', 'text-white');
        notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
    }
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Animate out and remove
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Comparison toggle function with authentication check
function toggleComparison(propertyId, buttonElement) {
    // Check if user is authenticated (same logic as favorites)
    const isAuthenticated = document.querySelector('a[href*="dashboard"]') !== null;
    
    if (!isAuthenticated) {
        // Show styled notification and redirect to login (same as favorites)
        showNotification('Для добавления в сравнение необходимо зарегистрироваться или войти в систему', 'warning');
        setTimeout(() => {
            window.location.href = '/login';
        }, 1500);
        return;
    }
    
    try {
        const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
        const isInComparison = comparisonData.properties.includes(propertyId);
        
        if (isInComparison) {
            // Remove from comparison
            comparisonData.properties = comparisonData.properties.filter(id => id !== propertyId);
            buttonElement.style.background = '#ffffff';
            buttonElement.querySelector('i').style.color = '#6b7280';
            buttonElement.classList.remove('active');
        } else {
            // Add to comparison
            comparisonData.properties.push(propertyId);
            buttonElement.style.background = '#0088CC';
            buttonElement.querySelector('i').style.color = 'white';
            buttonElement.classList.add('active');
        }
        
        localStorage.setItem('comparison-data', JSON.stringify(comparisonData));
        // Also save in format expected by dashboard
        localStorage.setItem('comparisons', JSON.stringify(comparisonData.properties));
        console.log('Comparison updated:', comparisonData.properties.length, 'properties');
        
        // Update comparison counter if exists
        const counter = document.querySelector('.comparison-counter');
        if (counter) {
            counter.textContent = comparisonData.properties.length;
            counter.style.display = comparisonData.properties.length > 0 ? 'inline-flex' : 'none';
        }
    } catch (error) {
        console.error('Error toggling comparison:', error);
    }
}

// Update button initialization to include new buttons
function initializeAllButtons() {
    // Initialize favorites
    if (window.favoritesManager) {
        const heartElements = document.querySelectorAll('.favorite-heart');
        heartElements.forEach(heart => {
            if (window.favoritesManager.toggleFavorite) {
                // Already initialized
                return;
            }
        });
    }
    
    // Initialize comparison buttons
    const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
    document.querySelectorAll('.comparison-btn').forEach(btn => {
        const propertyId = btn.dataset.propertyId;
        
        if (comparisonData.properties.includes(propertyId)) {
            btn.style.background = '#0088CC';
            btn.querySelector('i').style.color = 'white';
            btn.classList.add('active');
        } else {
            btn.style.background = '#ffffff';
            btn.querySelector('i').style.color = '#6b7280';
            btn.classList.remove('active');
        }
    });
    
    console.log('All buttons initialized: favorites, comparison, PDF');
}

// Debug favorites system
setTimeout(() => {
    console.log('=== FAVORITES DEBUG START ===');
    console.log('favoritesManager instance:', typeof window.favoritesManager);
    console.log('Heart elements:', document.querySelectorAll('.favorite-heart').length);
    console.log('User authenticated check:', document.querySelector('a[href*="dashboard"]') !== null);
    console.log('=== FAVORITES DEBUG END ===');
}, 3000);

// Инициализация dropdown-фильтров при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing dropdown filters...');
    initializeDropdownFilters();
});

// Также попробуем инициализировать сразу, если DOM уже готов
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDropdownFilters);
} else {
    initializeDropdownFilters();
}

// Hide unsupported filter buttons based on user feedback
function hideUnsupportedFilters() {
    console.log('Скрываем неподдерживаемые фильтры...');
    
    // List of unsupported filter text patterns
    const unsupportedFilters = [
        'Материал стен',
        'Вид из окон', 
        'Видовые квартиры',
        'Лифт',
        'Сторона света',
        'Стороны света',
        'Парковка'
    ];
    
    // Hide buttons containing unsupported filter text
    unsupportedFilters.forEach(filterText => {
        const buttons = document.querySelectorAll(`button, .filter-option-btn, .dropdown-btn`);
        buttons.forEach(button => {
            if (button.textContent && button.textContent.includes(filterText)) {
                console.log(`Скрываем фильтр: ${filterText}`);
                button.style.display = 'none';
                // Also hide parent container if it's a filter dropdown
                const parentDropdown = button.closest('.filter-dropdown');
                if (parentDropdown) {
                    parentDropdown.style.display = 'none';
                }
            }
        });
    });
}

// Initialize hiding unsupported filters
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        hideUnsupportedFilters();
    }, 500); // Wait for other initializations
});

// ========== MODERN ADVANCED FILTERS ==========
let advancedFiltersVisible = false;
let activeAdvancedFilters = 0;

// Initialize advanced filters functionality
function initializeAdvancedFiltersPanel() {
    const toggleButton = document.getElementById('advancedFiltersToggle');
    const panel = document.getElementById('advancedFiltersPanel');
    const closeButton = document.getElementById('closeAdvancedFilters');
    const counter = document.getElementById('advancedFiltersCounter');
    const arrow = document.getElementById('advancedFiltersArrow');
    
    if (!toggleButton || !panel) return;
    
    // Toggle panel visibility
    function togglePanel() {
        advancedFiltersVisible = !advancedFiltersVisible;
        
        if (advancedFiltersVisible) {
            panel.classList.remove('hidden');
            panel.style.opacity = '0';
            panel.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                panel.style.opacity = '1';
                panel.style.transform = 'translateY(0)';
            }, 10);
            
            toggleButton.classList.add('border-[#0088CC]', 'bg-blue-50');
            arrow.style.transform = 'rotate(180deg)';
        } else {
            panel.style.opacity = '0';
            panel.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                panel.classList.add('hidden');
            }, 200);
            
            toggleButton.classList.remove('border-[#0088CC]', 'bg-blue-50');
            arrow.style.transform = 'rotate(0deg)';
        }
    }
    
    // Event listeners
    toggleButton.addEventListener('click', togglePanel);
    if (closeButton) {
        closeButton.addEventListener('click', togglePanel);
    }
    
    // Apply advanced filters
    document.getElementById('applyAdvancedFilters')?.addEventListener('click', function() {
        console.log('Применяем расширенные фильтры...');
        collectAdvancedFilters();
        applyFilters();
        updateAdvancedFiltersCounter();
        
        // Show success notification
        showNotification('Расширенные фильтры применены!', 'success');
    });
    
    // Reset advanced filters
    document.getElementById('resetAdvancedFilters')?.addEventListener('click', function() {
        resetAdvancedFilters();
        applyFilters();
        updateAdvancedFiltersCounter();
        
        showNotification('Фильтры сброшены', 'info');
    });
    
    // Update counter on any filter change
    panel.addEventListener('change', function() {
        updateAdvancedFiltersCounter();
    });
    
    panel.addEventListener('input', function() {
        updateAdvancedFiltersCounter();
    });
}

// Collect all advanced filter values
function collectAdvancedFilters() {
    const filters = {};
    
    // Range filters
    const rangeFilters = [
        { from: 'areaFrom', to: 'areaTo', key: 'area_range' },
        { from: 'floorFrom', to: 'floorTo', key: 'floor_range' },
        { from: 'maxFloorFrom', to: 'maxFloorTo', key: 'max_floor_range' },
        { from: 'buildYearFrom', to: 'buildYearTo', key: 'build_year_range' }
    ];
    
    rangeFilters.forEach(filter => {
        const fromInput = document.getElementById(filter.from);
        const toInput = document.getElementById(filter.to);
        const fromVal = fromInput ? fromInput.value : '';
        const toVal = toInput ? toInput.value : '';
        
        if (fromVal || toVal) {
            filters[filter.key] = {
                from: fromVal ? parseFloat(fromVal) : null,
                to: toVal ? parseFloat(toVal) : null
            };
        }
    });
    
    // Checkbox filters
    const checkboxGroups = [
        'object_class',
        'renovation', 
        'features',
        'building_released'
    ];
    
    checkboxGroups.forEach(group => {
        const checkboxes = document.querySelectorAll(`input[data-filter-type="${group}"]:checked`);
        if (checkboxes.length > 0) {
            filters[group] = Array.from(checkboxes).map(cb => cb.value);
        }
    });
    
    // Store in global filters object
    window.advancedFilters = filters;
    
    console.log('Collected advanced filters:', filters);
    return filters;
}

// Reset all advanced filters
function resetAdvancedFilters() {
    try {
        // Clear range inputs
        ['areaFrom', 'areaTo', 'floorFrom', 'floorTo', 'maxFloorFrom', 'maxFloorTo', 'buildYearFrom', 'buildYearTo'].forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = '';
        });
        
        // Uncheck all checkboxes
        const panel = document.getElementById('advancedFiltersPanel');
        if (panel) {
            panel.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
        
        // Clear stored filters
        window.advancedFilters = {};
        
        console.log('Advanced filters reset successfully');
    } catch (error) {
        console.warn('Error resetting advanced filters:', error);
        window.advancedFilters = {};
    }
}

// Update advanced filters counter
function updateAdvancedFiltersCounter() {
    const counter = document.getElementById('advancedFiltersCounter');
    if (!counter) return;
    
    let count = 0;
    
    // Count range filters that have values
    ['areaFrom', 'areaTo', 'floorFrom', 'floorTo', 'maxFloorFrom', 'maxFloorTo', 'buildYearFrom', 'buildYearTo'].forEach(id => {
        try {
            const input = document.getElementById(id);
            if (input && input.value && input.value.toString().trim()) {
                count++;
            }
        } catch (e) {
            console.warn('Error checking input', id, ':', e);
        }
    });
    
    // Count checked checkboxes
    count += document.querySelectorAll('#advancedFiltersPanel input[type="checkbox"]:checked').length;
    
    activeAdvancedFilters = count;
    
    if (count > 0) {
        counter.textContent = count;
        counter.classList.remove('hidden');
    } else {
        counter.classList.add('hidden');
    }
    
    console.log('Advanced filters count:', count);
}

// Enhanced filter function to include advanced filters
function applyAdvancedFilterToProperties() {
    if (!window.advancedFilters) return;
    
    const filters = window.advancedFilters;
    console.log('Applying advanced filters to properties:', filters);
    
    // This will be called from the main applyFilters() function
    // The actual filtering logic should be integrated with existing system
    
    // Add advanced filter indicators to active filters display
    updateAdvancedFilterTags();
}

// Update active filter tags to include advanced filters
function updateAdvancedFilterTags() {
    const container = document.getElementById('activeFiltersList');
    if (!container || !window.advancedFilters) return;
    
    const filters = window.advancedFilters;
    
    // Remove existing advanced filter tags
    container.querySelectorAll('[data-advanced-filter]').forEach(tag => tag.remove());
    
    // Add range filter tags
    Object.keys(filters).forEach(key => {
        const filter = filters[key];
        
        if (key.includes('_range') && filter) {
            const filterName = key.replace('_range', '').replace('_', ' ');
            const fromVal = filter.from;
            const toVal = filter.to;
            
            if (fromVal || toVal) {
                const tag = document.createElement('span');
                tag.className = 'px-3 py-1 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white text-sm rounded-full flex items-center gap-2';
                tag.setAttribute('data-advanced-filter', key);
                
                let text = filterName.charAt(0).toUpperCase() + filterName.slice(1);
                if (fromVal && toVal) {
                    text += `: ${fromVal} - ${toVal}`;
                } else if (fromVal) {
                    text += `: от ${fromVal}`;
                } else if (toVal) {
                    text += `: до ${toVal}`;
                }
                
                tag.innerHTML = `${text} <button onclick="removeAdvancedFilter('${key}')" class="hover:bg-white hover:bg-opacity-20 rounded-full p-0.5">×</button>`;
                container.appendChild(tag);
            }
        } else if (Array.isArray(filter)) {
            filter.forEach(value => {
                const tag = document.createElement('span');
                tag.className = 'px-3 py-1 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white text-sm rounded-full flex items-center gap-2';
                tag.setAttribute('data-advanced-filter', `${key}_${value}`);
                tag.innerHTML = `${value} <button onclick="removeAdvancedFilterValue('${key}', '${value}')" class="hover:bg-white hover:bg-opacity-20 rounded-full p-0.5">×</button>`;
                container.appendChild(tag);
            });
        }
    });
}

// Remove individual advanced filter
function removeAdvancedFilter(filterKey) {
    if (window.advancedFilters && window.advancedFilters[filterKey]) {
        delete window.advancedFilters[filterKey];
        
        // Clear UI elements
        if (filterKey.includes('_range')) {
            const baseName = filterKey.replace('_range', '');
            ['From', 'To'].forEach(suffix => {
                const input = document.getElementById(baseName + suffix);
                if (input) input.value = '';
            });
        }
        
        applyFilters();
        updateAdvancedFiltersCounter();
        updateAdvancedFilterTags();
    }
}

// Remove specific advanced filter value
function removeAdvancedFilterValue(filterKey, value) {
    if (window.advancedFilters && window.advancedFilters[filterKey]) {
        const index = window.advancedFilters[filterKey].indexOf(value);
        if (index > -1) {
            window.advancedFilters[filterKey].splice(index, 1);
            
            // Remove from UI
            const checkbox = document.querySelector(`input[data-filter-type="${filterKey}"][value="${value}"]`);
            if (checkbox) checkbox.checked = false;
            
            // Remove filter key if empty
            if (window.advancedFilters[filterKey].length === 0) {
                delete window.advancedFilters[filterKey];
            }
            
            applyFilters();
            updateAdvancedFiltersCounter();
            updateAdvancedFilterTags();
        }
    }
}

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;
    
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
    };
    
    notification.classList.add(colors[type] || colors.info);
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto remove
    setTimeout(() => {
        notification.style.transform = 'translateX(full)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ✅ НОВЫЕ ФУНКЦИИ: Управление активными фильтрами

// Читаем фильтры из URL при загрузке страницы
function updateActiveFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Читаем и применяем фильтры по комнатам
    const rooms = urlParams.get('rooms');
    if (rooms) {
        const roomValues = rooms.split(',');
        // Конвертируем серверные значения обратно в JavaScript
        const jsRooms = roomValues.map(room => {
            if (room === '0') return 'студия';
            if (room === '1') return '1-комн';
            if (room === '2') return '2-комн';
            if (room === '3') return '3-комн';
            if (room === '4') return '4+-комн';
            return room;
        });
        
        // Отмечаем соответствующие чекбоксы
        jsRooms.forEach(room => {
            const checkbox = document.querySelector(`input[data-filter-type="rooms"][value="${room}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        
        // Обновляем глобальные фильтры
        if (!window.currentFilters) window.currentFilters = {};
        window.currentFilters.rooms = jsRooms;
    }
    
    // Читаем другие фильтры
    const developer = urlParams.get('developer');
    if (developer) {
        const checkbox = document.querySelector(`input[data-filter-type="developer"][value="${developer}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    }
    
    const priceMin = urlParams.get('price_min');
    const priceMax = urlParams.get('price_max');
    if (priceMin || priceMax) {
        if (!window.currentFilters) window.currentFilters = {};
        window.currentFilters.priceFrom = parseFloat(priceMin) || 0;
        window.currentFilters.priceTo = parseFloat(priceMax) || 0;
    }
}

// ✅ ИСПРАВЛЕНО: Показываем ВСЕ активные фильтры в специальном блоке
function displayActiveFilters() {
    const activeFiltersContainer = document.getElementById('active-filters');
    if (!activeFiltersContainer) return;
    
    const activeFiltersList = document.getElementById('active-filters-list') || 
                             activeFiltersContainer.querySelector('div');
    if (!activeFiltersList) return;
    
    let hasActiveFilters = false;
    let filtersHTML = '';
    
    // Проверяем активные фильтры по комнатам
    const checkedRooms = document.querySelectorAll('input[data-filter-type="rooms"]:checked');
    if (checkedRooms.length > 0) {
        hasActiveFilters = true;
        checkedRooms.forEach(checkbox => {
            const label = checkbox.value === 'студия' ? 'Студия' : 
                         checkbox.value === '1-комн' ? '1-комнатная' :
                         checkbox.value === '2-комн' ? '2-комнатная' :
                         checkbox.value === '3-комн' ? '3-комнатная' :
                         checkbox.value === '4+-комн' ? '4+ комнатная' : checkbox.value;
            filtersHTML += `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                    <i class="fas fa-home mr-1"></i>
                    ${label}
                    <button onclick="removeRoomFilter('${checkbox.value}')" class="ml-2 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `;
        });
    }
    
    // Проверяем активные фильтры по застройщикам
    const checkedDevelopers = document.querySelectorAll('input[data-filter-type="developer"]:checked');
    if (checkedDevelopers.length > 0) {
        hasActiveFilters = true;
        checkedDevelopers.forEach(checkbox => {
            filtersHTML += `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
                    <i class="fas fa-building mr-1"></i>
                    ${checkbox.value}
                    <button onclick="removeDeveloperFilter('${checkbox.value}')" class="ml-2 text-green-600 hover:text-green-800">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `;
        });
    }
    
    // ✅ ДОБАВЛЕНО: Проверяем активные фильтры по дате сдачи
    const checkedCompletion = document.querySelectorAll('input[data-filter-type="completion"]:checked');
    if (checkedCompletion.length > 0) {
        hasActiveFilters = true;
        checkedCompletion.forEach(checkbox => {
            filtersHTML += `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-purple-100 text-purple-800">
                    <i class="fas fa-calendar mr-1"></i>
                    ${checkbox.value}
                    <button onclick="removeCompletionFilter('${checkbox.value}')" class="ml-2 text-purple-600 hover:text-purple-800">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `;
        });
    }
    
    // ✅ ДОБАВЛЕНО: Проверяем активные фильтры по классу объектов
    const checkedObjectClass = document.querySelectorAll('input[data-filter-type="object_class"]:checked');
    if (checkedObjectClass.length > 0) {
        hasActiveFilters = true;
        checkedObjectClass.forEach(checkbox => {
            filtersHTML += `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-indigo-100 text-indigo-800">
                    <i class="fas fa-star mr-1"></i>
                    ${checkbox.value}
                    <button onclick="removeObjectClassFilter('${checkbox.value}')" class="ml-2 text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `;
        });
    }
    
    // ✅ ИСПРАВЛЕНО: Проверяем активные фильтры по цене (из полей ввода)
    const priceFromEl = document.getElementById('priceFrom');
    const priceToEl = document.getElementById('priceTo');
    const priceFromValue = priceFromEl ? priceFromEl.value : '';
    const priceToValue = priceToEl ? priceToEl.value : '';
    
    if (priceFromValue || priceToValue) {
        hasActiveFilters = true;
        let priceText = 'Цена ';
        if (priceFromValue) priceText += `от ${priceFromValue}млн `;
        if (priceToValue) priceText += `до ${priceToValue}млн`;
        
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800">
                <i class="fas fa-ruble-sign mr-1"></i>
                ${priceText.trim()}
                <button onclick="removePriceFilter()" class="ml-2 text-yellow-600 hover:text-yellow-800">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    }
    
    // ✅ ИСПРАВЛЕНО: Проверяем активные фильтры по площади с правильными ID
    const areaFromEl = document.getElementById('areaFrom');
    const areaToEl = document.getElementById('areaTo');
    const areaFromValue = areaFromEl ? areaFromEl.value : '';
    const areaToValue = areaToEl ? areaToEl.value : '';
    
    if (areaFromValue || areaToValue) {
        hasActiveFilters = true;
        let areaText = 'Площадь ';
        if (areaFromValue) areaText += `от ${areaFromValue}м² `;
        if (areaToValue) areaText += `до ${areaToValue}м²`;
        
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-cyan-100 text-cyan-800">
                <i class="fas fa-expand-arrows-alt mr-1"></i>
                ${areaText.trim()}
                <button onclick="removeAreaFilter()" class="ml-2 text-cyan-600 hover:text-cyan-800">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    }
    
    // ✅ ИСПРАВЛЕНО: Проверяем активные фильтры по этажу с правильными ID
    const floorFromEl = document.getElementById('floorFrom');
    const floorToEl = document.getElementById('floorTo');
    const floorFromValue = floorFromEl ? floorFromEl.value : '';
    const floorToValue = floorToEl ? floorToEl.value : '';
    
    if (floorFromValue || floorToValue) {
        hasActiveFilters = true;
        let floorText = 'Этаж ';
        if (floorFromValue) floorText += `от ${floorFromValue} `;
        if (floorToValue) floorText += `до ${floorToValue}`;
        
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-orange-100 text-orange-800">
                <i class="fas fa-layer-group mr-1"></i>
                ${floorText.trim()}
                <button onclick="removeFloorFilter()" class="ml-2 text-orange-600 hover:text-orange-800">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    }
    
    // ✅ ИСПРАВЛЕНО: Проверяем активные фильтры по этажности дома с правильными ID
    const buildingFloorFromEl = document.getElementById('maxFloorFrom') || document.querySelector('input[name="max_floor_from"]');
    const buildingFloorToEl = document.getElementById('maxFloorTo') || document.querySelector('input[name="max_floor_to"]');
    const buildingFloorFromValue = buildingFloorFromEl ? buildingFloorFromEl.value : '';
    const buildingFloorToValue = buildingFloorToEl ? buildingFloorToEl.value : '';
    
    if (buildingFloorFromValue || buildingFloorToValue) {
        hasActiveFilters = true;
        let buildingText = 'Этажность ';
        if (buildingFloorFromValue) buildingText += `от ${buildingFloorFromValue} `;
        if (buildingFloorToValue) buildingText += `до ${buildingFloorToValue}`;
        
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-teal-100 text-teal-800">
                <i class="fas fa-building mr-1"></i>
                ${buildingText.trim()}
                <button onclick="removeBuildingFloorFilter()" class="ml-2 text-teal-600 hover:text-teal-800">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    }
    
    // ✅ ДОБАВЛЕНО: Проверяем активные фильтры по отделке
    const checkedRenovation = document.querySelectorAll('input[data-filter-type="renovation"]:checked');
    if (checkedRenovation.length > 0) {
        hasActiveFilters = true;
        checkedRenovation.forEach(checkbox => {
            filtersHTML += `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-pink-100 text-pink-800">
                    <i class="fas fa-paint-brush mr-1"></i>
                    ${checkbox.value}
                    <button onclick="removeRenovationFilter('${checkbox.value}')" class="ml-2 text-pink-600 hover:text-pink-800">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `;
        });
    }
    
    // ✅ ДОБАВЛЕНО: Проверяем активные фильтры по статусу сдачи (сдан/в строительстве)
    const checkedBuildingReleased = document.querySelectorAll('input[data-filter-type="building_released"]:checked');
    if (checkedBuildingReleased.length > 0) {
        hasActiveFilters = true;
        checkedBuildingReleased.forEach(checkbox => {
            const statusText = checkbox.value === 'true' ? 'Сданный дом' : 'В строительстве';
            filtersHTML += `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                    <i class="fas fa-hammer mr-1"></i>
                    ${statusText}
                    <button onclick="removeBuildingStatusFilter('${checkbox.value}')" class="ml-2 text-red-600 hover:text-red-800">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `;
        });
    }
    
    // ✅ ИСПРАВЛЕНО: Проверяем активный фильтр по ЖК (из разных источников)
    const complexFromWindow = window.activeFilters?.complex;
    const complexFromGlobal = (typeof activeFilters !== 'undefined' && activeFilters.complex);
    const activeComplexName = complexFromWindow || complexFromGlobal;
    
    if (activeComplexName) {
        hasActiveFilters = true;
        console.log(`🏗️ Отображаем активный фильтр ЖК: "${activeComplexName}"`);
        filtersHTML += `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-emerald-100 text-emerald-800">
                <i class="fas fa-building-columns mr-1"></i>
                ${activeComplexName}
                <button onclick="removeComplexFilter()" class="ml-2 text-emerald-600 hover:text-emerald-800">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `;
    } else {
        console.log('🔍 Активный фильтр ЖК не найден', {
            complexFromWindow,
            complexFromGlobal,
            windowActiveFilters: window.activeFilters,
            globalActiveFilters: typeof activeFilters !== 'undefined' ? activeFilters : 'undefined'
        });
    }
    
    // Показываем/скрываем блок активных фильтров
    if (hasActiveFilters) {
        activeFiltersList.innerHTML = filtersHTML;
        activeFiltersContainer.classList.remove('hidden');
    } else {
        activeFiltersContainer.classList.add('hidden');
    }
}

// Функции для удаления отдельных фильтров
function removeRoomFilter(roomValue) {
    const checkbox = document.querySelector(`input[data-filter-type="rooms"][value="${roomValue}"]`);
    if (checkbox) {
        checkbox.checked = false;
        handleRoomFilterChange(); // Запускаем фильтрацию
    }
}

function removeDeveloperFilter(developerValue) {
    const checkbox = document.querySelector(`input[data-filter-type="developer"][value="${developerValue}"]`);
    if (checkbox) {
        checkbox.checked = false;
        filterProperties(); // Запускаем фильтрацию
        displayActiveFilters();
    }
}

function removePriceFilter() {
    // Очищаем поля цены
    const priceFromEl = document.getElementById('priceFrom');
    const priceToEl = document.getElementById('priceTo');
    if (priceFromEl) priceFromEl.value = '';
    if (priceToEl) priceToEl.value = '';
    
    // Сбрасываем текст кнопки
    const buttonText = document.getElementById('priceFilterText');
    if (buttonText) buttonText.textContent = 'Цена от-до, ₽';
    
    // Запускаем фильтрацию
    filterProperties();
    displayActiveFilters();
}

// ✅ ДОБАВЛЕНО: Функции удаления остальных фильтров
function removeCompletionFilter(completionValue) {
    const checkbox = document.querySelector(`input[data-filter-type="completion"][value="${completionValue}"]`);
    if (checkbox) {
        checkbox.checked = false;
        filterProperties();
        displayActiveFilters();
    }
}

function removeObjectClassFilter(objectClassValue) {
    const checkbox = document.querySelector(`input[data-filter-type="object_class"][value="${objectClassValue}"]`);
    if (checkbox) {
        checkbox.checked = false;
        filterProperties();
        displayActiveFilters();
    }
}

// ✅ ДОБАВЛЕНЫ: Функции удаления новых фильтров
function removeAreaFilter() {
    const areaFromEl = document.getElementById('areaFrom');
    const areaToEl = document.getElementById('areaTo');
    if (areaFromEl) areaFromEl.value = '';
    if (areaToEl) areaToEl.value = '';
    filterProperties();
    displayActiveFilters();
}

function removeFloorFilter() {
    const floorFromEl = document.getElementById('floorFrom');
    const floorToEl = document.getElementById('floorTo');
    if (floorFromEl) floorFromEl.value = '';
    if (floorToEl) floorToEl.value = '';
    filterProperties();
    displayActiveFilters();
}

function removeBuildingFloorFilter() {
    const buildingFloorFromEl = document.getElementById('maxFloorFrom') || document.querySelector('input[name="max_floor_from"]');
    const buildingFloorToEl = document.getElementById('maxFloorTo') || document.querySelector('input[name="max_floor_to"]');
    if (buildingFloorFromEl) buildingFloorFromEl.value = '';
    if (buildingFloorToEl) buildingFloorToEl.value = '';
    filterProperties();
    displayActiveFilters();
}

function removeRenovationFilter(renovationValue) {
    const checkbox = document.querySelector(`input[data-filter-type="renovation"][value="${renovationValue}"]`);
    if (checkbox) {
        checkbox.checked = false;
        filterProperties();
        displayActiveFilters();
    }
}

function removeBuildingStatusFilter(statusValue) {
    const checkbox = document.querySelector(`input[data-filter-type="building_released"][value="${statusValue}"]`);
    if (checkbox) {
        checkbox.checked = false;
        filterProperties();
        displayActiveFilters();
    }
}

// ✅ ДОБАВЛЕНО: Функция удаления фильтра ЖК
function removeComplexFilter() {
    console.log('🗑️ Удаляем фильтр ЖК...');
    
    // ✅ ИСПРАВЛЕНО: Очищаем все возможные места где хранится фильтр
    if (window.activeFilters) {
        window.activeFilters.complex = null;
        console.log('✅ Очищен window.activeFilters.complex');
    }
    if (typeof activeFilters !== 'undefined') {
        activeFilters.complex = null;
        console.log('✅ Очищен activeFilters.complex');
    }
    
    // Очищаем поисковую строку если там был ЖК
    const searchInput = document.getElementById('property-search');
    if (searchInput && searchInput.value.includes('ЖК ')) {
        searchInput.value = '';
        console.log('✅ Очищена поисковая строка');
    }
    
    // ✅ ИСПРАВЛЕНО: НЕ обновляем URL чтобы избежать перезагрузки страницы
    // Просто очищаем фильтры без изменения URL
    console.log('✅ Фильтры очищены без изменения URL (избегаем перезагрузку)');
    
    console.log('🔄 Применяем фильтрацию после удаления...');
    filterProperties();
    displayActiveFilters();
    
    console.log('✅ Фильтр ЖК полностью удален');
}

// ✅ УБРАНА СЛОЖНАЯ ФУНКЦИЯ - заменена простым перенаправлением
// Простое перенаправление на /properties без параметров надежнее всего

// ✅ УБРАНА ДИАГНОСТИКА - она вызывала бесконечные перезагрузки
console.log('✅ Диагностический код отключен для предотвращения циклов');

// ✅ ДОПОЛНИТЕЛЬНАЯ ПОПЫТКА через DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔄 DOM готов - повторная попытка инициализации...');
    setTimeout(function() {
        const btn = document.getElementById('clearAllFilters');
        if (btn && !btn.hasAttribute('data-initialized')) {
            btn.setAttribute('data-initialized', 'true');
            btn.onclick = function(e) {
                console.log('✅ ПЕРЕНАПРАВЛЯЕМ НА /properties');
                window.location.href = '/properties';
                return false;
            };
            console.log('✅ Кнопка переинициализирована через DOM');
        }
    }, 500);
});

// Initialize advanced filters on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initializeAdvancedFiltersPanel();
        console.log('✅ Modern Advanced Filters initialized');
        
        // ✅ ДОБАВЛЕНО: Читаем и применяем фильтры из URL
        updateActiveFiltersFromURL();
        displayActiveFilters();
        
        // Применяем фильтрацию если есть параметры из URL
        if (window.location.search) {
            setTimeout(() => {
                filterProperties();
            }, 500);
        }
    }, 1000); // Wait for other systems to load
});

</script>

<!-- Favorites system is loaded globally in base.html to prevent duplicates -->

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/smart_autocomplete.js') }}"></script>
{% endblock %}
