{% extends "base.html" %}

{% block title %}{% if property.title %}{{ property.title }}{% else %}{{ property.rooms }}-комнатная квартира {{ property.area }} м²{% endif %} - Квартира в {{ property.complex_name or 'ЖК' }} с кэшбеком{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
.custom-property-marker {
    background: transparent !important;
    border: none !important;
}
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<div class="container mx-auto px-4 py-3 text-sm">
    <nav aria-label="Breadcrumb" class="flex">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a class="text-[#0088CC] hover:underline inline-flex items-center" href="/">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                    </svg>
                    Главная
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <a href="{{ url_for('properties') }}" class="text-[#0088CC] hover:underline ml-1 md:ml-2">Квартиры</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-gray-500 ml-1 md:ml-2">
                        {% if property.title %}
                            {{ property.title }}
                        {% elif property.rooms == 0 %}
                            Студия {{ property.area }} м²
                        {% else %}
                            {{ property.rooms }}-комнатная квартира {{ property.area }} м²
                        {% endif %}
                    </span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Кэшбек баннер -->
    <div class="bg-gradient-to-r from-[#006699] to-[#0088CC] rounded-2xl p-6 text-white mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div class="mb-4 md:mb-0">
                <h2 class="text-2xl font-bold mb-2">Получите кэшбек при покупке этой квартиры!</h2>
                <p class="opacity-90">Приобретая эту квартиру через наш сервис, вы получите кэшбек до {{ property.cashback_percent or 5 }}% от стоимости.</p>
            </div>
            <button onclick="openApplicationModal()" class="bg-white text-[#0088CC] hover:bg-opacity-90 font-semibold px-6 py-3 rounded-xl whitespace-nowrap transition-all">
                Получить кэшбек
            </button>
        </div>
    </div>

    <!-- Основная карточка -->
    <div class="bg-white rounded-2xl overflow-hidden shadow-lg mb-8">
        <!-- Галерея -->
        <div class="relative">
            <!-- Favorite Heart Button -->
            <div class="absolute top-4 right-4 z-20">
                <div class="favorite-heart" data-property-id="{{ property.id }}" title="Добавить в избранное">
                    <i class="fas fa-heart"></i>
                </div>
            </div>
            
            <div class="relative rounded-xl overflow-hidden">
                <div class="aspect-[2/1] md:aspect-[5/2] bg-gray-100">
                    {% if property.gallery and property.gallery|length > 0 %}
                        <div class="swiper property-slider relative h-full">
                            <div class="swiper-wrapper">
                                {% for image in property.gallery %}
                                <div class="swiper-slide">
                                    <div class="relative h-full w-full bg-gray-100 flex items-center justify-center">
                                        <img alt="{% if property.title %}{{ property.title }}{% else %}{{ property.rooms }}-комнатная квартира{% endif %}" 
                                             class="max-w-full max-h-full object-contain" 
                                             src="{{ image }}"
                                             loading="lazy"/>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="swiper-pagination"></div>
                            <div class="swiper-button-prev"></div>
                            <div class="swiper-button-next"></div>
                        </div>
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-gray-100">
                            {% if property.image and 'placeholder' not in property.image %}
                                <img alt="{% if property.title %}{{ property.title }}{% else %}{{ property.rooms }}-комнатная квартира{% endif %}" class="w-full h-full object-cover" src="{{ property.image }}"/>
                            {% else %}
                                <div class="text-center text-gray-500">
                                    <i class="fas fa-home text-4xl mb-2 text-gray-400"></i>
                                    <p class="text-lg font-medium">{{ property.rooms }}-комнатная квартира</p>
                                    <p class="text-sm">{{ property.area }} м² • ЖК {{ property.complex_name }}</p>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="p-6">
            <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-6">
                <!-- Левая колонка -->
                <div class="flex-1">
                    <!-- Заголовок и метки -->
                    <div class="mb-4">
                        <h1 class="text-2xl md:text-3xl font-bold mb-2">{% if property.title %}{{ property.title }}{% else %}{{ property.rooms }}-комнатная квартира {{ property.area }} м²{% endif %}</h1>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="bg-gray-100 text-[#0088CC] px-3 py-1 rounded-full text-sm">Новостройка</span>
                            <span class="bg-gray-100 text-[#7e5bef] px-3 py-1 rounded-full text-sm">{{ property.finishing or property.renovation or "Чистовая отделка" }}</span>
                            <span class="bg-gray-100 text-green-700 px-3 py-1 rounded-full text-sm">{{ property.floor }}/{{ property.total_floors }} этаж</span>
                            {% if property.balcony %}
                            <span class="bg-gray-100 text-yellow-700 px-3 py-1 rounded-full text-sm">Балкон {{ property.balcony_area }} м²</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Адрес -->
                    <div class="mb-6">
                        <div class="flex items-center text-gray-600 mb-1">
                            <i class="fas fa-map-marker-alt mr-2 text-[#0088CC]"></i>
                            <span>{{ property.full_address or property.location or property.address or ((property.complex_name or 'ЖК') + ', ' + (property.district or '')) }}</span>
                        </div>
                        <p class="text-sm text-gray-500">Рядом: {{ property.nearby or "торговые центры, парки, школы" }}</p>
                    </div>

                    <!-- Характеристики -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <p class="text-gray-500 text-sm">Площадь</p>
                            <p class="font-semibold">{{ property.area }} м²</p>
                        </div>
                        {% if property.kitchen_area %}
                        <div>
                            <p class="text-gray-500 text-sm">Кухня</p>
                            <p class="font-semibold">{{ property.kitchen_area }} м²</p>
                        </div>
                        {% endif %}
                        {% if property.living_area %}
                        <div>
                            <p class="text-gray-500 text-sm">Жилая площадь</p>
                            <p class="font-semibold">{{ property.living_area }} м²</p>
                        </div>
                        {% endif %}
                        <div>
                            <p class="text-gray-500 text-sm">Этаж</p>
                            <p class="font-semibold">{{ property.floor }} из {{ property.total_floors }}</p>
                        </div>
                        {% if property.ceiling_height %}
                        <div>
                            <p class="text-gray-500 text-sm">Высота потолков</p>
                            <p class="font-semibold">{{ property.ceiling_height }} м</p>
                        </div>
                        {% endif %}
                        <div>
                            <p class="text-gray-500 text-sm">Вид из окна</p>
                            <p class="font-semibold">{{ property.view or "Двор" }}</p>
                        </div>
                        {% if property.complex_building_end_build_quarter and property.complex_building_end_build_year %}
                        <div>
                            <p class="text-gray-500 text-sm">Срок сдачи корпуса</p>
                            <p class="font-semibold">{{ property.complex_building_end_build_quarter }} кв. {{ property.complex_building_end_build_year }}</p>
                        </div>
                        {% elif property.complex_end_build_quarter and property.complex_end_build_year %}
                        <div>
                            <p class="text-gray-500 text-sm">Срок сдачи ЖК</p>
                            <p class="font-semibold">{{ property.complex_end_build_quarter }} кв. {{ property.complex_end_build_year }}</p>
                        </div>
                        {% endif %}
                        {% if property.developer %}
                        <div>
                            <p class="text-gray-500 text-sm">Застройщик</p>
                            <p class="font-semibold">{{ property.developer }}</p>
                        </div>
                        {% endif %}
                        {% if property.class_type %}
                        <div>
                            <p class="text-gray-500 text-sm">Класс жилья</p>
                            <p class="font-semibold">{{ property.class_type }}</p>
                        </div>
                        {% endif %}
                        {% if property.complex_building_released is defined %}
                        <div>
                            <p class="text-gray-500 text-sm">Статус объекта</p>
                            <p class="font-semibold {% if property.complex_building_released %}text-green-600{% else %}text-orange-600{% endif %}">
                                {% if property.complex_building_released %}Сдан в эксплуатацию{% else %}В стадии строительства{% endif %}
                            </p>
                        </div>
                        {% endif %}
                        {% if property.renovation_display_name %}
                        <div>
                            <p class="text-gray-500 text-sm">Отделка</p>
                            <p class="font-semibold">{{ property.renovation_display_name }}</p>
                        </div>
                        {% endif %}
                        {% if property.square_price %}
                        <div>
                            <p class="text-gray-500 text-sm">Цена за м²</p>
                            <p class="font-semibold">{{ "{:,.0f}".format(property.square_price).replace(',', ' ') }} ₽/м²</p>
                        </div>
                        {% endif %}
                        {% if property.building_name %}
                        <div>
                            <p class="text-gray-500 text-sm">Корпус</p>
                            <p class="font-semibold">{{ property.building_name }}</p>
                        </div>
                        {% endif %}
                        {% if property.total_floors and property.floor %}
                        <div>
                            <p class="text-gray-500 text-sm">Этажи в корпусе</p>
                            <p class="font-semibold">{{ property.floor }}—{{ property.total_floors }}</p>
                        </div>
                        {% endif %}
                        {% if property.deal_type %}
                        <div>
                            <p class="text-gray-500 text-sm">Тип сделки</p>
                            <p class="font-semibold">
                                {% if property.deal_type == 'sale' %}Продажа{% else %}{{ property.deal_type }}{% endif %}
                            </p>
                        </div>
                        {% endif %}
                        {% if property.complex_start_build_year and property.complex_first_build_quarter %}
                        <div>
                            <p class="text-gray-500 text-sm">Начало строительства</p>
                            <p class="font-semibold">{{ property.complex_first_build_quarter }} кв. {{ property.complex_start_build_year }}</p>
                        </div>
                        {% endif %}
                        {% if property.published_date %}
                        <div>
                            <p class="text-gray-500 text-sm">Размещено</p>
                            <p class="font-semibold text-xs">
                                {% if property.published_date and property.published_date.strftime %}
                                    {{ property.published_date.strftime('%d.%m.%Y') }}
                                {% else %}
                                    Недавно
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Ипотека и финансирование -->
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-4">Ипотека и финансирование</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h4 class="font-semibold mb-3 text-[#0088CC]">Доступные программы</h4>
                                <div class="space-y-3">
                                    {% if property.has_mortgage_subsidy %}
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-green-500"></i>
                                        <span class="text-sm">Льготная ипотека до 8%</span>
                                    </div>
                                    {% endif %}
                                    {% if property.has_green_mortgage %}
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-leaf text-green-500"></i>
                                        <span class="text-sm">Зеленая ипотека до 7%</span>
                                    </div>
                                    {% endif %}
                                    {% if property.complex_has_government_program %}
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-star text-yellow-500"></i>
                                        <span class="text-sm">Государственная программа</span>
                                    </div>
                                    {% endif %}
                                    {% if property.complex_financing_sber %}
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-university text-green-600"></i>
                                        <span class="text-sm">Финансирование Сбербанк</span>
                                    </div>
                                    {% endif %}
                                    {% if property.has_accreditation %}
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-certificate text-blue-500"></i>
                                        <span class="text-sm">Аккредитован банками</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <h4 class="font-semibold mb-3 text-green-600">Расчет ипотеки</h4>
                                {% if property.mortgage_price %}
                                <div class="mb-3">
                                    <p class="text-sm text-gray-600">Ежемесячный платеж от:</p>
                                    <p class="text-2xl font-bold text-green-600">{{ "{:,.0f}".format(property.mortgage_price).replace(',', ' ') }} ₽</p>
                                </div>
                                {% endif %}
                                {% if property.min_rate %}
                                <div class="mb-3">
                                    <p class="text-sm text-gray-600">Ставка от:</p>
                                    <p class="text-lg font-semibold">{{ property.min_rate }}% годовых</p>
                                </div>
                                {% endif %}
                                <button onclick="openApplicationModal()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                    Рассчитать ипотеку
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Контакты застройщика -->
                    {% if property.sales_phone or property.sales_address %}
                    <div class="mb-6 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-5">
                        <h3 class="font-bold text-lg mb-4 text-[#0088CC]">Контакты застройщика</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {% if property.sales_phone and property.sales_phone != 'Уточняется' %}
                            <div class="flex items-center gap-3">
                                <i class="fas fa-phone text-green-500 text-lg"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Отдел продаж</p>
                                    <a href="tel:{{ property.sales_phone }}" class="font-semibold text-green-600 hover:text-green-700">
                                        {{ property.sales_phone }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            {% if property.sales_address and property.sales_address != 'Уточняется' %}
                            <div class="flex items-center gap-3">
                                <i class="fas fa-map-marker-alt text-red-500 text-lg"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Адрес офиса продаж</p>
                                    <p class="font-semibold text-gray-700 text-sm">{{ property.sales_address }}</p>
                                </div>
                            </div>
                            {% endif %}
                            <div class="flex items-center gap-3">
                                <i class="fas fa-handshake text-orange-500 text-lg"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Кэшбэк с InBack</p>
                                    <p class="font-bold text-orange-600">
                                        {% if property.cashback and property.cashback > 0 %}
                                            {{ "{:,.0f}".format(property.cashback).replace(',', ' ') }} ₽
                                        {% else %}
                                            До 3% от стоимости
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Описание -->
                    {% if property.description or property.detailed_description %}
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Об этой квартире</h3>
                        {% if property.description %}
                        <p class="text-gray-700 mb-3">
                            {{ property.description }}
                        </p>
                        {% endif %}
                        {% if property.detailed_description %}
                        <p class="text-gray-700">
                            {{ property.detailed_description }}
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Варианты отделки -->
                    {% if property.finish_options %}
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Варианты отделки</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {% for option in property.finish_options %}
                            <div class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-all">
                                {% if option.image %}
                                <div class="h-32 bg-gray-200 overflow-hidden">
                                    <img src="{{ option.image }}" alt="{{ option.type }}" class="w-full h-full object-cover">
                                </div>
                                {% endif %}
                                <div class="p-4">
                                    <div class="font-semibold mb-2">{{ option.type }}</div>
                                    <p class="text-sm text-gray-600 mb-3">{{ option.description }}</p>
                                    <div class="text-sm space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Стены:</span>
                                            <span>{{ option.details.walls }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Пол:</span>
                                            <span>{{ option.details.floor }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Санузел:</span>
                                            <span>{{ option.details.bathroom }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-4 text-sm text-gray-500">
                            <p>Фото отделки представлены для примера. Фактическая отделка может отличаться.</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Инфраструктура -->
                    {% if property.infrastructure %}
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Инфраструктура</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            {% for amenity in property.infrastructure %}
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-[#0088CC]/10 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-sm text-[#0088CC]"></i>
                                </div>
                                <div>
                                    <span class="text-sm">{{ amenity }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Преимущества -->
                    {% if property.advantages %}
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Преимущества</h3>
                        <div class="space-y-3">
                            {% for advantage in property.advantages %}
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 mt-1 text-[#0088CC]">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <p class="text-gray-700">{{ advantage }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Правая колонка (цена и кэшбек) -->
                <div class="md:w-80 flex-shrink-0">
                    <!-- Цена -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold">Стоимость квартиры</h3>
                        </div>
                        <div class="text-2xl font-bold mb-4 bg-gradient-to-r from-[#006699] to-[#0088CC] bg-clip-text text-transparent">{{ "{:,.0f}".format(property.price).replace(',', ' ') }} ₽</div>
                        <div class="text-sm text-gray-500 mb-4">
                            <div class="flex justify-between mb-1">
                                <span>Цена за м²</span>
                                <span class="font-medium">{{ "{:,.0f}".format(property.price / property.area).replace(',', ' ') }} ₽</span>
                            </div>
                        </div>
                        <button class="w-full bg-gradient-to-r from-[#006699] to-[#0088CC] hover:bg-opacity-90 text-white font-semibold py-3 px-4 rounded-xl transition-all mb-3">
                            Забронировать квартиру
                        </button>
                        
                        <!-- PDF и поделиться -->
                        <div class="flex gap-2 mb-3">
                            <a href="{{ url_for('property_pdf', property_id=property.id) }}" target="_blank" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-3 rounded-lg text-center text-sm transition-all">
                                <i class="fas fa-file-pdf mr-1"></i>
                                PDF
                            </a>
                            <button onclick="shareProperty()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-3 rounded-lg text-sm transition-all">
                                <i class="fas fa-share-alt mr-1"></i>
                                Поделиться
                            </button>
                        </div>
                    </div>
                    
                    <!-- Кэшбек -->
                    <div class="bg-blue-50 rounded-xl p-6 mb-6 border border-blue-100">
                        <h3 class="font-bold text-lg mb-3 text-[#0088CC]">Ваш кэшбек</h3>
                        <div class="flex items-end gap-2 mb-2">
                            <span class="text-2xl font-bold text-[#0088CC]">{{ "{:,.0f}".format(property.cashback_amount).replace(',', ' ') }} ₽</span>
                        </div>
                        <div class="text-sm text-gray-500 mb-4">
                            {{ property.cashback_percent }}% от стоимости квартиры
                        </div>
                        <p class="text-sm text-gray-600 mb-4">
                            При покупке этой квартиры через наш сервис вы получаете дополнительный кэшбек на карту после сделки.
                        </p>
                        <button class="w-full bg-white hover:bg-gray-50 text-[#0088CC] font-semibold py-3 px-4 rounded-xl border border-[#0088CC] transition-all">
                            Получить кэшбек
                        </button>
                    </div>
                    
                    <!-- Ипотечный калькулятор -->
                    <div class="bg-green-50 rounded-xl p-5 border border-green-100">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fas fa-calculator text-green-600"></i>
                            <h3 class="font-bold text-lg text-green-700">Семейная ипотека</h3>
                        </div>
                        
                        <!-- Стоимость (только показ) -->
                        <div class="mb-4">
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Стоимость квартиры</div>
                                <div class="font-bold text-lg text-gray-800">{{ "{:,.0f}".format(property.price).replace(',', ' ') }} ₽</div>
                            </div>
                        </div>
                        
                        <!-- Компактные параметры -->
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <!-- ПВ -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ПВ %</label>
                                <input type="number" id="mortgage-down-payment" value="20" min="10" max="80"
                                       class="w-full p-2 text-sm border border-gray-200 rounded text-center">
                            </div>
                            
                            <!-- Ставка -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Ставка %</label>
                                <input type="number" id="mortgage-rate" value="6.0" step="0.1" min="3" max="20"
                                       class="w-full p-2 text-sm border border-gray-200 rounded text-center">
                            </div>
                            
                            <!-- Срок -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Лет</label>
                                <input type="number" id="mortgage-term" value="30" min="5" max="30"
                                       class="w-full p-2 text-sm border border-gray-200 rounded text-center">
                            </div>
                        </div>
                        
                        <!-- Предупреждение о лимите -->
                        <div id="family-mortgage-limit-warning" class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-3 text-sm" style="display: none;">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-info-circle text-amber-600 mt-0.5"></i>
                                <div class="text-amber-800">
                                    <strong>Лимит семейной ипотеки:</strong> максимум 6 млн ₽. 
                                    Превышение автоматически добавлено к первоначальному взносу.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Результаты -->
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Первый взнос:</span>
                                <span id="mortgage-down-amount" class="font-medium">{{ "{:,.0f}".format(property.price * 0.2).replace(',', ' ') }} ₽</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Сумма кредита:</span>
                                <span id="loan-amount" class="font-medium">{{ "{:,.0f}".format(property.price * 0.8).replace(',', ' ') }} ₽</span>
                            </div>
                            <div class="bg-white rounded-lg p-3 border-2 border-green-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-green-700">Ежемесячный платеж:</span>
                                    <span id="monthly-payment" class="text-xl font-bold text-green-600">—</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="openApplicationModal()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-all text-sm">
                            <i class="fas fa-home mr-2"></i>
                            Подать заявку на ипотеку
                        </button>
                        
                        <p class="text-xs text-gray-500 mt-3 text-center">
                            * Предварительный расчет. Окончательные условия определяет банк.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Планировка -->
    {% if property.layout_image %}
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-6">Планировка квартиры</h2>
        <div class="flex justify-center">
            <img alt="Планировка {{ property.title }}" class="max-w-full h-auto rounded-xl" src="{{ property.layout_image }}"/>
        </div>
    </div>
    {% endif %}

    <!-- Информация о здании -->
    {% if property.building_info %}
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-6">О доме</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <p class="text-gray-500 text-sm">Тип дома</p>
                <p class="font-semibold">{{ property.building_info.type }}</p>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Класс</p>
                <p class="font-semibold">{{ property.building_info.class }}</p>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Год постройки</p>
                <p class="font-semibold">{{ property.building_info.year }}</p>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Лифты</p>
                <p class="font-semibold">{{ property.building_info.elevator }}</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Похожие квартиры в этом ЖК -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">
                {% set count = property.same_type_apartments or 0 %}
                {% if property.rooms == 0 %}
                    {{ count }} студий в этом ЖК
                {% elif property.rooms == 1 %}
                    {{ count }} 1-комнатных квартир в этом ЖК  
                {% elif property.rooms == 2 %}
                    {{ count }} 2-комнатных квартир в этом ЖК
                {% elif property.rooms == 3 %}
                    {{ count }} 3-комнатных квартир в этом ЖК
                {% elif property.rooms == 4 %}
                    {{ count }} 4-комнатных квартир в этом ЖК
                {% else %}
                    {{ count }} квартир такой планировки в этом ЖК
                {% endif %}
            </h2>
            <a href="{{ url_for('residential_complex_detail', complex_id=property.complex_id) }}" class="text-[#0088CC] hover:underline">Показать все</a>
        </div>
        
        <!-- Фильтры для похожих квартир -->
        <div class="flex flex-wrap gap-4 mb-6 text-sm">
            <select class="border border-gray-200 rounded-lg px-3 py-2">
                <option>Этаж: Любой</option>
                <option>1-5</option>
                <option>6-10</option>
                <option>11-15</option>
                <option>16-20</option>
                <option>21-25</option>
            </select>
            <select class="border border-gray-200 rounded-lg px-3 py-2">
                <option>Срок сдачи: Любой</option>
                <option>1 кв. 2024</option>
                <option>2 кв. 2024</option>
                <option>3 кв. 2024</option>
                <option>4 кв. 2024</option>
            </select>
            <select class="border border-gray-200 rounded-lg px-3 py-2">
                <option>Стоимость: Любая</option>
                <option>До 7 млн</option>
                <option>7-8 млн</option>
                <option>8-9 млн</option>
                <option>Более 9 млн</option>
            </select>
            <button class="bg-[#0088CC] text-white px-4 py-2 rounded-lg hover:bg-[#0077BB]">Показать 31 квартиру</button>
        </div>
        
        <!-- Планировка -->
        <div class="mb-4">
            <img src="https://via.placeholder.com/150x100/E0E7FF/9333EA?text=План" alt="Планировка {{ property.type }}" class="w-32 h-20 object-cover rounded-lg">
        </div>
    </div>
    
    <!-- О жилом комплексе -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-6">О жилом комплексе "{{ property.complex_name }}"</h2>
        
        <!-- Фотографии ЖК -->
        {% if property.gallery and property.gallery|length > 1 %}
        <div class="mb-6">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                {% for image in property.gallery[:6] %}
                <div class="aspect-video rounded-lg overflow-hidden">
                    <img src="{{ image }}" alt="ЖК {{ property.complex_name }}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Информация о ЖК -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h4 class="font-semibold mb-3 text-[#0088CC]">Основные характеристики</h4>
                <div class="space-y-2 text-sm">
                    {% if property.class_type %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Класс недвижимости:</span>
                        <span class="font-medium">{{ property.class_type }}</span>
                    </div>
                    {% endif %}
                    {% if property.completion_date != 'Уточняется' %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Срок завершения:</span>
                        <span class="font-medium">{{ property.completion_date }}</span>
                    </div>
                    {% endif %}
                    {% if property.developer %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Застройщик:</span>
                        <span class="font-medium">{{ property.developer }}</span>
                    </div>
                    {% endif %}
                    {% if property.complex_name %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Название ЖК:</span>
                        <span class="font-medium">{{ property.complex_name }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div>
                <h4 class="font-semibold mb-3 text-[#0088CC]">Особенности комплекса</h4>
                <div class="space-y-2 text-sm">
                    {% if property.has_accreditation %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span>Аккредитован банками</span>
                    </div>
                    {% endif %}
                    {% if property.has_green_mortgage %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-leaf text-green-500"></i>
                        <span>Зеленая ипотека</span>
                    </div>
                    {% endif %}
                    {% if property.with_renovation %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-paint-brush text-blue-500"></i>
                        <span>Квартиры с отделкой</span>
                    </div>
                    {% endif %}
                    {% if property.has_mortgage_subsidy %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-percentage text-amber-500"></i>
                        <span>Льготная ипотека</span>
                    </div>
                    {% endif %}
                    {% if property.complex_financing_sber %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-university text-green-600"></i>
                        <span>Финансирование Сбербанк</span>
                    </div>
                    {% endif %}
                    {% if property.complex_has_big_check %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-shield-alt text-blue-500"></i>
                        <span>Большая проверка пройдена</span>
                    </div>
                    {% endif %}
                    {% if property.complex_building_accreditation %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-building text-indigo-500"></i>
                        <span>Корпус аккредитован</span>
                    </div>
                    {% endif %}
                    {% if property.trade_in_available %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exchange-alt text-purple-500"></i>
                        <span>Доступен Trade-in</span>
                    </div>
                    {% endif %}
                    {% if property.chat_available %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-comments text-blue-400"></i>
                        <span>Онлайн-консультации</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Статистика по квартирам -->
        {% if property.complex_total_apartments > 0 %}
        <div class="bg-blue-50 rounded-lg p-4 mb-6">
            <h4 class="font-semibold mb-3">В этом ЖК доступно:</h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                <div class="text-center">
                    <div class="text-2xl font-bold text-[#0088CC]">{{ property.complex_total_apartments }}</div>
                    <div class="text-gray-600">всего квартир</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-[#0088CC]">{{ property.same_type_apartments }}</div>
                    <div class="text-gray-600">
                        {% if property.rooms == 0 %}студий
                        {% elif property.rooms == 1 %}1-комнатных
                        {% elif property.rooms == 2 %}2-комнатных  
                        {% elif property.rooms == 3 %}3-комнатных
                        {% elif property.rooms == 4 %}4-комнатных
                        {% else %}{{ property.rooms }}-комнатных
                        {% endif %}
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-[#0088CC]">{{ property.complex_buildings_count }}</div>
                    <div class="text-gray-600">корпусов</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Другие квартиры в ЖК -->
        {% if similar_apartments and similar_apartments|length > 0 %}
        <div class="mt-6">
            <h4 class="font-semibold mb-4">Другие квартиры в {{ property.complex_name }}</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                {% for apartment in similar_apartments[:8] %}
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="aspect-[4/3] relative overflow-hidden">
                        <img src="{{ apartment.image }}" alt="{{ apartment.title }}" 
                             class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
                        <div class="absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded">
                            {{ "{:,.0f}".format(apartment.cashback).replace(',', ' ') }} ₽ кэшбек
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="text-sm font-medium mb-1">{{ apartment.room_type }}</div>
                        <div class="text-xs text-gray-600 mb-2">{{ apartment.area }} м² • {{ apartment.floor }}/{{ apartment.total_floors }} эт.</div>
                        <div class="text-lg font-bold text-[#0088CC] mb-2">
                            {{ "{:,.0f}".format(apartment.price).replace(',', ' ') }} ₽
                        </div>
                        <a href="{{ url_for('property_detail', property_id=apartment.id) }}" 
                           class="block w-full bg-gray-100 hover:bg-[#0088CC] hover:text-white text-center text-sm py-2 rounded-lg transition-all">
                            Подробнее
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="mt-6">
            <a href="{{ url_for('residential_complex_detail', complex_name=property.complex_name) }}" class="bg-[#0088CC] text-white px-6 py-3 rounded-lg hover:bg-[#0077BB] transition-colors">
                Подробнее о ЖК
            </a>
        </div>
    </div>
    
    <!-- Расположение на карте -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-6">Расположение квартиры</h2>
        <div class="mb-4">
            <div class="flex items-center text-gray-600 mb-2">
                <i class="fas fa-map-marker-alt mr-2 text-[#0088CC]"></i>
                <span class="font-medium">{{ property.address_locality_display_name or property.district or 'Краснодарский край' }}, {{ property.complex_name }}</span>
            </div>
            <p class="text-sm text-gray-500">{{ property.full_address or property.address or ((property.address_locality_display_name or 'Краснодар') + ', ' + (property.complex_name or 'ЖК')) }}</p>
        </div>
        
        <!-- Карта -->
        <div id="property-map" class="w-full h-80 rounded-xl overflow-hidden mb-4"></div>
        
        <!-- Кнопки карты -->
        <div class="flex gap-3 text-sm">
            <a href="https://yandex.ru/maps/?ll={{ property.address_position_lon or 39.0 }},{{ property.address_position_lat or 45.0 }}&z=16&pt={{ property.address_position_lon or 39.0 }},{{ property.address_position_lat or 45.0 }}" 
               target="_blank" 
               class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fab fa-yandex"></i>
                Открыть в Яндекс Картах
            </a>
            <a href="https://maps.google.com/?q={{ property.address_position_lat or 45.0 }},{{ property.address_position_lon or 39.0 }}" 
               target="_blank" 
               class="flex items-center gap-2 bg-blue-500 hover:bg-[#0088CC] text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fab fa-google"></i>
                Открыть в Google Maps
            </a>
        </div>
        
        <!-- Транспорт и инфраструктура рядом -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 pt-6 border-t border-gray-100">
            <div>
                <h4 class="font-semibold mb-3 flex items-center gap-2">
                    <i class="fas fa-bus text-[#0088CC]"></i>
                    Транспорт
                </h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Остановка автобуса</span>
                        <span class="font-medium">200 м</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Станция метро</span>
                        <span class="font-medium">1.2 км</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ж/д вокзал</span>
                        <span class="font-medium">8.5 км</span>
                    </div>
                </div>
            </div>
            <div>
                <h4 class="font-semibold mb-3 flex items-center gap-2">
                    <i class="fas fa-store text-[#0088CC]"></i>
                    Инфраструктура
                </h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Торговый центр</span>
                        <span class="font-medium">500 м</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Школа</span>
                        <span class="font-medium">400 м</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Детский сад</span>
                        <span class="font-medium">300 м</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Застройщик -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-6">Застройщик</h2>
        <div class="flex items-start gap-6">
            <div class="w-16 h-16 bg-gray-200 rounded-xl flex items-center justify-center">
                <span class="text-lg font-bold text-[#0088CC]">{{ property.developer[:3].upper() }}</span>
            </div>
            <div class="flex-1">
                <h3 class="text-xl font-semibold mb-2">{{ property.developer }}</h3>
                <p class="text-gray-600 mb-4">Надежный застройщик с многолетним опытом строительства качественного жилья в Краснодаре. Все объекты сданы в срок.</p>
                <div class="flex gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Построено объектов:</span>
                        <span class="font-medium">15+</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Опыт работы:</span>
                        <span class="font-medium">12 лет</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<!-- Яндекс.Карты API -->
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=" type="text/javascript"></script>

<script>
    // Красивый слайдер с эффектами
    const swiper = new Swiper('.property-slider', {
        loop: true,
        autoplay: {
            delay: 4000,
            disableOnInteraction: false,
            pauseOnMouseEnter: true,
        },
        // Убираем fade эффект для лучшего листания
        effect: 'slide',
        speed: 600,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
            renderBullet: function (index, className) {
                return '<span class="' + className + '">' + (index + 1) + '</span>';
            },
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        keyboard: {
            enabled: true,
            onlyInViewport: true
        },
        mousewheel: false,
        touchRatio: 1,
        touchAngle: 45,
        grabCursor: true,
        slidesPerView: 1,
        spaceBetween: 0,
        resistance: true,
        resistanceRatio: 0.85,
        centeredSlides: false,
        watchSlidesProgress: true,
        watchSlidesVisibility: true,
        preloadImages: false,
        lazy: {
            loadPrevNext: true,
            loadPrevNextAmount: 2
        },
        on: {
            init: function() {
                console.log('Слайдер инициализирован');
            },
            slideChange: function() {
                // Плавная анимация при смене слайда
                this.slides.forEach(slide => {
                    slide.style.opacity = '1';
                });
            }
        }
    });

    // Initialize Yandex Map
    ymaps.ready(function() {
        {% if property.address_position_lat and property.address_position_lon %}
        const propertyLat = {{ property.address_position_lat }};
        const propertyLng = {{ property.address_position_lon }};
        {% else %}
        const propertyLat = 45.0355;
        const propertyLng = 38.9753;
        {% endif %}
        
        const map = new ymaps.Map('property-map', {
            center: [propertyLat, propertyLng],
            zoom: 15,
            controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
        });
        
        // Добавляем слой с инфраструктурой
        const infraLayer = new ymaps.ObjectManager({
            clusterize: false,
            gridSize: 32,
            geoObjectOpenBalloonOnClick: false
        });
        
        // Создаем метку для квартиры
        const placemark = new ymaps.Placemark([propertyLat, propertyLng], {
            balloonContentHeader: '{{ property.complex_name }}',
            balloonContentBody: `
                <div class="text-center p-2">
                    <div class="text-sm text-gray-600 mb-2">{{ property.title }}</div>
                    <div class="text-lg font-bold text-blue-600">{{ "{:,.0f}".format(property.price).replace(',', ' ') }} ₽</div>
                    <div class="text-xs text-gray-500 mt-1">{{ "{:,.0f}".format(property.price / property.area).replace(',', ' ') }} ₽/м²</div>
                </div>
            `,
            hintContent: '{{ property.complex_name }}'
        }, {
            preset: 'islands#redDotIcon',
            iconColor: '#0088CC'
        });
        
        map.geoObjects.add(placemark);
        placemark.balloon.open();
        
        // Поиск ближайшей инфраструктуры
        const searchControl = new ymaps.control.SearchControl({
            options: {
                provider: 'yandex#search',
                size: 'small',
                float: 'left'
            }
        });
        
        // Показываем объекты инфраструктуры поблизости
        setTimeout(() => {
            // Школы
            ymaps.geocode(`школа около ${propertyLat}, ${propertyLng}`, {
                results: 3,
                kind: 'house'
            }).then(function(res) {
                res.geoObjects.each(function(obj) {
                    const coords = obj.geometry.getCoordinates();
                    const schoolMark = new ymaps.Placemark(coords, {
                        hintContent: 'Школа'
                    }, {
                        preset: 'islands#greenEducationIcon',
                        iconColor: '#4CAF50'
                    });
                    map.geoObjects.add(schoolMark);
                });
            });
            
            // Детские сады
            ymaps.geocode(`детский сад около ${propertyLat}, ${propertyLng}`, {
                results: 3,
                kind: 'house'
            }).then(function(res) {
                res.geoObjects.each(function(obj) {
                    const coords = obj.geometry.getCoordinates();
                    const kindergartenMark = new ymaps.Placemark(coords, {
                        hintContent: 'Детский сад'
                    }, {
                        preset: 'islands#yellowIcon',
                        iconColor: '#FFC107'
                    });
                    map.geoObjects.add(kindergartenMark);
                });
            });
            
            // Больницы
            ymaps.geocode(`больница около ${propertyLat}, ${propertyLng}`, {
                results: 2,
                kind: 'house'
            }).then(function(res) {
                res.geoObjects.each(function(obj) {
                    const coords = obj.geometry.getCoordinates();
                    const hospitalMark = new ymaps.Placemark(coords, {
                        hintContent: 'Больница'
                    }, {
                        preset: 'islands#redMedicalIcon',
                        iconColor: '#F44336'
                    });
                    map.geoObjects.add(hospitalMark);
                });
            });
            
            // Магазины
            ymaps.geocode(`магазин около ${propertyLat}, ${propertyLng}`, {
                results: 5,
                kind: 'house'
            }).then(function(res) {
                res.geoObjects.each(function(obj) {
                    const coords = obj.geometry.getCoordinates();
                    const shopMark = new ymaps.Placemark(coords, {
                        hintContent: 'Магазин'
                    }, {
                        preset: 'islands#blueShoppingIcon',
                        iconColor: '#2196F3'
                    });
                    map.geoObjects.add(shopMark);
                });
            });
        }, 1000);
    });

    // Share property function
    function shareProperty() {
        const url = window.location.href;
        const title = document.title;
        
        if (navigator.share) {
            navigator.share({
                title: title,
                url: url
            }).catch(error => console.warn('Property detail error:', error));
        } else if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(() => {
                alert('Ссылка скопирована в буфер обмена!');
            }).catch(() => {
                fallbackCopyTextToClipboard(url);
            });
        } else {
            fallbackCopyTextToClipboard(url);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            alert('Ссылка скопирована в буфер обмена!');
        } catch (err) {
            alert('Не удалось скопировать ссылку. URL: ' + text);
        }
        
        document.body.removeChild(textArea);
    }

    // Ипотечный калькулятор
    function calculateMortgage() {
        const propertyPrice = {{ property.price }};
        const maxLoanAmount = 6000000; // Максимальная сумма по семейной ипотеке
        let downPaymentPercent = parseFloat(document.getElementById('mortgage-down-payment').value);
        const rate = parseFloat(document.getElementById('mortgage-rate').value);
        const termYears = parseInt(document.getElementById('mortgage-term').value);
        
        // Расчет с учетом ограничения семейной ипотеки
        let loanAmount = propertyPrice * (1 - downPaymentPercent / 100);
        let downPaymentAmount = propertyPrice * (downPaymentPercent / 100);
        
        // Если сумма кредита превышает лимит семейной ипотеки
        if (loanAmount > maxLoanAmount) {
            loanAmount = maxLoanAmount;
            downPaymentAmount = propertyPrice - loanAmount;
            const actualDownPaymentPercent = (downPaymentAmount / propertyPrice) * 100;
            
            // Обновляем поле первоначального взноса
            document.getElementById('mortgage-down-payment').value = actualDownPaymentPercent.toFixed(1);
        }
        
        const monthlyRate = (rate / 100) / 12;
        const totalMonths = termYears * 12;
        
        // Формула аннуитетного платежа
        let monthlyPayment;
        if (rate === 0) {
            monthlyPayment = loanAmount / totalMonths;
        } else {
            monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                           (Math.pow(1 + monthlyRate, totalMonths) - 1);
        }
        
        // Обновляем интерфейс
        document.getElementById('mortgage-down-amount').textContent = formatNumber(downPaymentAmount) + ' ₽';
        document.getElementById('loan-amount').textContent = formatNumber(loanAmount) + ' ₽';
        document.getElementById('monthly-payment').textContent = formatNumber(monthlyPayment) + ' ₽';
        
        // Показываем предупреждение если достигнут лимит
        const warningElement = document.getElementById('family-mortgage-limit-warning');
        if (loanAmount >= maxLoanAmount) {
            if (warningElement) warningElement.style.display = 'block';
        } else {
            if (warningElement) warningElement.style.display = 'none';
        }
    }
    
    function formatNumber(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }
    
    // Инициализация калькулятора
    document.addEventListener('DOMContentLoaded', function() {
        // Первоначальный расчет
        calculateMortgage();
        
        // Привязка событий к полям ввода
        const inputs = ['mortgage-down-payment', 'mortgage-rate', 'mortgage-term'];
        inputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', calculateMortgage);
                element.addEventListener('change', calculateMortgage);
            }
        });
    });
</script>
{% endblock %}