{% extends "base.html" %}

{% block title %}Панель менеджера | InBack{% endblock %}

{% block head %}
<!-- Swiper.js для галерей изображений в презентациях -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
{% endblock %}

{% block content %}
<style>
.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.tab-button.active {
    color: #0088CC !important;
    border-color: #0088CC !important;
}

.tab-button:hover {
    color: #374151 !important;
    border-color: #D1D5DB !important;
}
</style>

<!-- Tab Navigation under main header -->
<div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between py-4">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#0088CC] to-[#006699] flex items-center justify-center">
                        <span class="text-white font-semibold">{{ current_manager.full_name[0] }}</span>
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-gray-900">{{ current_manager.full_name }}</p>
                        <p class="text-sm text-gray-500">Менеджер недвижимости
                            {% if current_manager.email.startswith('demo') %}
                                <span class="inline-block ml-2 px-2 py-1 text-xs bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-full">ДЕМО</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/logout" class="text-gray-500 hover:text-gray-700 text-sm">Выйти</a>
                <a href="/" class="text-[#0088CC] hover:text-[#006699] text-sm flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    На сайт
                </a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <nav class="flex space-x-8" aria-label="Tabs">
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-[#0088CC] text-[#0088CC] whitespace-nowrap tab-button active" href="#" data-page="dashboard">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2L3 7v11h3v-6h8v6h3V7l-7-5z"/>
                    </svg>
                    Главная
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="clients">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    Клиенты
                    <span class="ml-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="clients-count">{{ total_clients }}</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="create-collection">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                    </svg>
                    Создать подборку
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="collections">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                    </svg>
                    Подборки
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="presentations">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                        <path d="M16 5a1 1 0 011 1v8a1 1 0 01-1 1h-4V5h4z"/>
                    </svg>
                    Презентации
                    <span class="ml-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="presentations-count">{{ presentations_count }}</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="recommendations">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                    </svg>
                    Рекомендации
                    <span class="ml-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="recommendations-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="saved-searches">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    Сохраненные поиски
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="applications">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0h8v12H6V4z" clip-rule="evenodd"/>
                    </svg>
                    Заявки
                    <span class="ml-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white text-xs px-2 py-1 rounded-full font-medium">{{ pending_applications_count }}</span>
                </a>
            </nav>
        </div>
    </div>
</div>

<!-- Main Content Area - Full Width -->
<div class="bg-gradient-to-b from-white to-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Section (Default) -->
        <div class="content-section active" id="dashboard">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full mb-4" id="welcome-icon">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                    </div>
                    <div id="welcome-message-container">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2" id="welcome-title">Добро пожаловать, {{ current_manager.full_name.split()[0] }}!</h2>
                        <div id="welcome-messages" class="space-y-2 mb-6">
                            <p class="text-lg text-gray-600">Панель управления менеджера недвижимости</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-[#0088CC]">{{ total_clients }}</div>
                            <div class="text-sm text-gray-600">Клиентов</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-green-600">{{ collections_count }}</div>
                            <div class="text-sm text-gray-600">Подборок</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-blue-600">{{ sent_collections_count }}</div>
                            <div class="text-sm text-gray-600">Отправлено</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-purple-600">{{ pending_applications_count }}</div>
                            <div class="text-sm text-gray-600">Заявок</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Create Collection -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('create-collection')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Создать подборку</h3>
                            <p class="text-sm text-gray-600">Подберите недвижимость для клиента</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Нажмите для создания</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Manage Clients -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('clients')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Управление клиентами</h3>
                            <p class="text-sm text-gray-600">{{ total_clients }} активных клиентов</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Просмотр и добавление</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- View Collections -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('collections')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Мои подборки</h3>
                            <p class="text-sm text-gray-600">{{ collections_count }} созданных подборок</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Редактирование и отправка</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Последняя активность</h3>
                <div id="recent-recommendations" class="space-y-3">
                    <div class="text-gray-500 text-sm">Загрузка активности...</div>
                </div>
            </div>
        </div>

        <!-- Clients Section -->
        <div class="content-section" id="clients">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Управление клиентами</h3>
                    <button onclick="showAddClientModal()" class="bg-gradient-to-r from-[#0088CC] to-[#006699] hover:from-[#006699] hover:to-[#004466] text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Добавить клиента
                    </button>
                </div>
                
                <!-- Clients Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Телефон</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка клиентов...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Create Collection Section -->
        <div class="content-section" id="create-collection">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Создать подборку недвижимости</h2>
                    
                    <!-- Collection Form -->
                    <form id="collection-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Название подборки</label>
                                <input type="text" id="collection-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" placeholder="Введите название подборки">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Клиент</label>
                                <div class="flex space-x-2">
                                    <select id="collection-client" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                        <option value="">Выберите клиента</option>
                                    </select>
                                    <button type="button" id="add-client-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm whitespace-nowrap">
                                        + Добавить
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Property Search Section -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Поиск недвижимости</h3>
                            <div class="space-y-4" id="property-search-container">
                                <!-- Основные фильтры -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Район</label>
                                        <select id="filter-district" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все районы</option>
                                            {% for district in districts %}
                                            <option value="{{ district }}">{{ district }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Застройщик</label>
                                        <select id="filter-developer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все застройщики</option>
                                            {% for developer in developers %}
                                            <option value="{{ developer }}">{{ developer }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Комнаты</label>
                                        <select id="filter-rooms" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Любое количество</option>
                                            <option value="студия">Студия</option>
                                            <option value="1">1 комната</option>
                                            <option value="2">2 комнаты</option>
                                            <option value="3">3 комнаты</option>
                                            <option value="4">4+ комнат</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Жилой комплекс</label>
                                        <select id="filter-complex" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все ЖК</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Цена и площадь -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена от</label>
                                        <input type="number" id="filter-price-min" placeholder="От, ₽" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена до</label>
                                        <input type="number" id="filter-price-max" placeholder="До, ₽" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Площадь от</label>
                                        <input type="number" id="filter-area-min" placeholder="От, м²" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Площадь до</label>
                                        <input type="number" id="filter-area-max" placeholder="До, м²" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                </div>

                                <!-- Дополнительные фильтры (скрытые по умолчанию) -->
                                <div class="border-t pt-4">
                                    <button id="toggle-advanced-filters" class="text-[#0088cc] hover:text-[#006699] text-sm font-medium mb-4">
                                        + Дополнительные фильтры
                                    </button>
                                    <div id="advanced-filters" class="hidden space-y-4">
                                        <!-- Этажи и характеристики -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Этаж от</label>
                                                <input type="number" id="filter-floor-min" placeholder="От" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Этаж до</label>
                                                <input type="number" id="filter-floor-max" placeholder="До" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
                                                <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой статус</option>
                                                    <option value="строительство">Строительство</option>
                                                    <option value="сдан">Сдан</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Отделка</label>
                                                <select id="filter-finishing" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любая отделка</option>
                                                    <option value="черновая">Черновая</option>
                                                    <option value="чистовая">Стандартная</option>
                                                    <option value="под ключ">Премиум</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Дополнительные характеристики -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Класс дома</label>
                                                <select id="filter-class" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой класс</option>
                                                    <option value="эконом">Эконом</option>
                                                    <option value="комфорт">Комфорт</option>
                                                    <option value="бизнес">Бизнес</option>
                                                    <option value="элитный">Элитный</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Материал стен</label>
                                                <select id="filter-material" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой материал</option>
                                                    <option value="кирпич">Кирпич</option>
                                                    <option value="монолит">Монолит</option>
                                                    <option value="панель">Панель</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Высота потолков от</label>
                                                <input type="number" id="filter-ceiling-min" placeholder="От, м" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Высота потолков до</label>
                                                <input type="number" id="filter-ceiling-max" placeholder="До, м" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                        </div>
                                        
                                        <!-- Удобства -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-balcony" class="mr-2 text-[#0088cc]">
                                                    Балкон/Лоджия
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-parking" class="mr-2 text-[#0088cc]">
                                                    Парковка
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-view" class="mr-2 text-[#0088cc]">
                                                    Красивый вид
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-penthouse" class="mr-2 text-[#0088cc]">
                                                    Пентхаус
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Ипотека -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-family-mortgage" class="mr-2 text-[#0088cc]">
                                                    Семейная ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-it-mortgage" class="mr-2 text-[#0088cc]">
                                                    IT ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-military-mortgage" class="mr-2 text-[#0088cc]">
                                                    Военная ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-rural-mortgage" class="mr-2 text-[#0088cc]">
                                                    Сельская ипотека
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Результаты поиска -->
                                <div class="mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="flex items-center space-x-4">
                                            <h4 class="text-lg font-medium text-gray-800">Результаты поиска</h4>
                                            <span id="results-count" class="text-sm text-gray-500">0 квартир</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="saveCurrentSearch()" class="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                                <i class="fas fa-save"></i> Сохранить поиск
                                            </button>
                                            <button onclick="showSavedSearches()" class="px-3 py-2 bg-[#0088CC] text-white rounded text-sm hover:bg-[#006699]">
                                                <i class="fas fa-folder"></i> Сохранённые поиски
                                            </button>
                                        </div>
                                    </div>
                                        <div class="flex items-center space-x-3">
                                            <!-- View toggle -->
                                            <div class="flex border border-gray-300 rounded-lg">
                                                <button type="button" id="view-grid-btn" class="px-3 py-2 text-sm bg-[#0088cc] text-white rounded-l-lg">
                                                    <i class="fas fa-th"></i>
                                                </button>
                                                <button type="button" id="view-list-btn" class="px-3 py-2 text-sm bg-white text-gray-600 border-l border-gray-300 rounded-r-lg hover:bg-gray-50">
                                                    <i class="fas fa-list"></i>
                                                </button>
                                            </div>
                                            <button type="button" id="search-apartments-btn" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                                Найти квартиры
                                            </button>
                                        </div>
                                    </div>
                                    <div id="properties-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>
                                    </div>
                                </div>

                                <!-- Выбранные объекты -->
                                <div class="mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="text-lg font-medium text-gray-800">Выбранные объекты для подборки</h4>
                                        <span id="selected-count" class="text-sm text-gray-500">0 объектов</span>
                                    </div>
                                    <div id="selected-properties" class="space-y-3">
                                        <p class="text-gray-500 text-center py-4">Объекты не выбраны</p>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button type="button" id="clear-selection-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" disabled>
                                            Очистить выбор
                                        </button>
                                        <div class="space-x-3">
                                            <button type="button" id="save-collection-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" disabled>
                                                Сохранить подборку
                                            </button>
                                            <button type="button" id="send-collection-btn" class="px-6 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors" disabled>
                                                Отправить клиенту
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Clients Section -->
            <div class="content-section" id="clients">
                <div class="bg-white rounded-xl shadow-sm p-1">
                    <div class="flex justify-between items-center mb-2 px-2 pt-2">
                        <h2 class="text-2xl font-bold text-gray-800">Управление клиентами</h2>
                        <button id="add-client-btn" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                            <i class="fas fa-plus mr-2"></i>Добавить клиента
                        </button>
                    </div>
                    
                    <!-- Clients list -->
                    <div class="overflow-x-auto px-1">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Клиент</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Телефон</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка клиентов...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Collections Section -->
            <div class="content-section" id="collections">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Мои подборки</h2>
                            <button onclick="showSection('create-collection')" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать новую
                            </button>
                        </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="collections-grid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">Загрузка подборок...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Presentations Section -->
            <div class="content-section" id="presentations">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Презентации 
                                <!-- FORCE UPDATE: 211155 -->
                            </h2>
                            <button onclick="showCreatePresentationModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать презентацию
                            </button>
                        </div>
                        
                        <!-- Presentations Grid -->
                        <div id="presentations-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="text-center py-8 col-span-full">
                                <p class="text-gray-500">Загрузка презентаций...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Section -->
            <div class="content-section" id="recommendations">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Рекомендации клиентам</h2>
                        <div class="flex gap-2">
                            <button onclick="loadRecommendations()" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition">
                                <i class="fas fa-sync mr-2"></i>
                                Обновить
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-paper-plane text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Отправлено</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-sent">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-eye text-2xl text-green-600 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Просмотрено</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-viewed">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-heart text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Заинтересованы</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-interested">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-calendar text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Просмотры назначены</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-scheduled">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <select id="rec-filter-client" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все клиенты</option>
                            </select>
                            <select id="rec-filter-status" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все статусы</option>
                                <option value="sent">Отправлено</option>
                                <option value="viewed">Просмотрено</option>
                                <option value="interested">Заинтересованы</option>
                                <option value="not_interested">Не заинтересованы</option>
                                <option value="scheduled_viewing">Просмотр назначен</option>
                            </select>
                            <select id="rec-filter-type" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все типы</option>
                                <option value="property">Квартиры</option>
                                <option value="complex">ЖК</option>
                            </select>
                            <select id="rec-filter-priority" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все приоритеты</option>
                                <option value="urgent">Срочно</option>
                                <option value="high">Высокий</option>
                                <option value="normal">Обычный</option>
                            </select>
                            <button onclick="loadRecommendations()" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition">
                                Применить фильтры
                            </button>
                        </div>
                    </div>

                    <!-- Recommendations List -->
                    <div id="recommendations-container" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-paper-plane text-4xl mb-4"></i>
                            <p>Загрузка рекомендаций...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Saved Searches Section -->
            <div class="content-section" id="saved-searches">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Сохранённые поиски</h2>
                        <div class="flex space-x-3">
                            <button onclick="createNewSearch()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать поиск
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="saved-searches-grid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">Загрузка сохранённых поисков...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Collections Section -->
            <div class="content-section" id="collections">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Мои подборки</h2>
                    <div id="collections-container" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">Загрузка подборок...</div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Recommendations Section -->
            <div class="content-section" id="recommendations">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Рекомендации клиентам</h2>
                        <div class="flex space-x-2">
                            <select id="recommendations-client-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Все клиенты</option>
                            </select>
                            <select id="recommendations-status-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Все статусы</option>
                                <option value="sent">Отправлено</option>
                                <option value="viewed">Просмотрено</option>
                                <option value="interested">Заинтересованы</option>
                                <option value="not_interested">Не заинтересованы</option>
                                <option value="scheduled_viewing">Просмотр назначен</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Stats cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-gray-900" id="recommendations-sent">0</div>
                            <div class="text-sm text-gray-600">Отправлено</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600" id="recommendations-viewed">0</div>
                            <div class="text-sm text-gray-600">Просмотрено</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-purple-600" id="recommendations-interested">0</div>
                            <div class="text-sm text-gray-600">Заинтересованы</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-orange-600" id="recommendations-scheduled">0</div>
                            <div class="text-sm text-gray-600">Просмотры назначены</div>
                        </div>
                    </div>
                    
                    <div id="recommendations-container" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">Загрузка рекомендаций...</div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Applications Section -->
            <div class="content-section" id="applications">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Заявки на кешбек</h2>
                    
                    <!-- Filter tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button class="application-tab active border-b-2 border-[#0088cc] py-2 px-1 text-sm font-medium text-[#0088cc]" data-status="all">
                                Все заявки
                            </button>
                            <button class="application-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700" data-status="pending">
                                На рассмотрении
                            </button>
                            <button class="application-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700" data-status="approved">
                                Одобрены
                            </button>
                            <button class="application-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700" data-status="rejected">
                                Отклонены
                            </button>
                        </nav>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Клиент</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Объект</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Сумма кешбека</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="applications-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">Загрузка заявок...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';

    // Tab navigation with event delegation
    const sections = document.querySelectorAll('.content-section');
    const nav = document.querySelector('nav[aria-label="Tabs"]');
    if (nav) {
        nav.addEventListener('click', function(e) {
            const btn = e.target.closest('.tab-button'); 
            if (!btn) return; 
            e.preventDefault();
            const page = btn.dataset.page;
            console.log('🎯 Tab clicked:', page);
            nav.querySelectorAll('.tab-button').forEach(b => b.classList.toggle('active', b === btn));
            sections.forEach(s => {
                const shouldBeActive = s.id === page;
                s.classList.toggle('active', shouldBeActive);
                console.log(`🔄 Section ${s.id} active: ${shouldBeActive}`);
            });
            
            // Load data when switching sections
            if (page === 'clients') {
                loadClients();
            } else if (page === 'recommendations') {
                loadRecommendations();
            } else if (page === 'saved-searches') {
                loadManagerSavedSearches();
            } else if (page === 'collections') {
                loadCollections();
            } else if (page === 'presentations') {
                loadPresentations();
            } else if (page === 'applications') {
                loadApplications();
            }
        });
    }

    // Load initial data
    loadClients();
    loadRecommendations();

    // CORE FUNCTIONS
    window.loadClients = function() {
        console.log('🔄 Loading clients...');
        const tableBody = document.getElementById('clients-table-body');
        
        if (!tableBody) {
            console.error('❌ clients-table-body not found');
            return;
        }
        
        tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка клиентов...</td></tr>';
        
        fetch('/api/manager/clients')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const clientsCountElement = document.getElementById('clients-count');
                    if (clientsCountElement) {
                        clientsCountElement.textContent = data.clients.length;
                    }
                    
                    const tbody = document.getElementById('clients-table-body');
                    if (!data.clients || data.clients.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Клиенты не найдены</td></tr>';
                    } else {
                        tbody.innerHTML = data.clients.map(client => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${client.full_name || 'Не указано'}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email || 'Не указано'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.phone || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                        Активен
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="editClient(${client.id})" class="text-[#0088cc] hover:text-[#006699] mr-3">Редактировать</button>
                                    <button onclick="deleteClient(${client.id}, '${client.full_name}')" class="text-red-600 hover:text-red-900">Удалить</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } else {
                    tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Ошибка: ${data.error}</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error loading clients:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Ошибка загрузки клиентов</td></tr>';
            });
    };

    window.loadRecommendations = function() {
        console.log('🔄 Loading recommendations...');
        const container = document.getElementById('recommendations-container');
        
        if (!container) {
            console.error('❌ recommendations-container not found');
            return;
        }
        
        container.innerHTML = '<div class="text-center py-8 text-gray-500">Загрузка рекомендаций...</div>';
        
        fetch('/api/manager/recommendations')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const recommendationsCountElement = document.getElementById('recommendations-count');
                    if (recommendationsCountElement) {
                        recommendationsCountElement.textContent = data.recommendations.length;
                    }
                    
                    // Update stats if available
                    if (data.stats) {
                        const sentEl = document.getElementById('recommendations-sent');
                        const viewedEl = document.getElementById('recommendations-viewed');
                        const interestedEl = document.getElementById('recommendations-interested');
                        const scheduledEl = document.getElementById('recommendations-scheduled');
                        
                        if (sentEl) sentEl.textContent = data.stats.sent || 0;
                        if (viewedEl) viewedEl.textContent = data.stats.viewed || 0;
                        if (interestedEl) interestedEl.textContent = data.stats.interested || 0;
                        if (scheduledEl) scheduledEl.textContent = data.stats.scheduled || 0;
                    }
                    
                    if (!data.recommendations || data.recommendations.length === 0) {
                        container.innerHTML = '<div class="text-center py-8 text-gray-500">Рекомендации не найдены</div>';
                    } else {
                        container.innerHTML = data.recommendations.map(rec => `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="font-medium text-gray-900">${rec.property_title || rec.title || 'Объект недвижимости'}</h4>
                                        <p class="text-sm text-gray-600">Клиент: ${rec.client_name}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                        ${rec.status || 'Отправлено'}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${rec.message || 'Рекомендация отправлена'}</p>
                                <div class="text-xs text-gray-500">
                                    Отправлено: ${new Date(rec.created_at || rec.sent_at).toLocaleDateString('ru-RU')}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    container.innerHTML = `<div class="text-center py-8 text-red-500">Ошибка: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error loading recommendations:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
            });
    };

    window.loadManagerSavedSearches = function() {
        console.log('🔄 Loading saved searches...');
        const container = document.getElementById('saved-searches-grid');
        
        if (!container) {
            console.error('❌ saved-searches-grid not found');
            return;
        }
        
        container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">Загрузка сохранённых поисков...</p></div>';
        
        fetch('/api/manager/saved-searches')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (!data.searches || data.searches.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-8 col-span-full">
                                <div class="text-gray-400 mb-4">
                                    <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-gray-500 text-lg">Сохранённые поиски не найдены</p>
                                <p class="text-gray-400 text-sm mt-2">Создайте поиск на странице "Недвижимость" и сохраните его</p>
                            </div>
                        `;
                    } else {
                        container.innerHTML = data.searches.map(search => {
                            let filtersDescription = 'Все объекты';
                            let activeFiltersCount = 0;
                            
                            if (search.additional_filters) {
                                try {
                                    const filters = JSON.parse(search.additional_filters);
                                    const parts = [];
                                    
                                    if (filters.rooms && filters.rooms.length > 0) {
                                        parts.push(filters.rooms.join(', '));
                                        activeFiltersCount++;
                                    }
                                    
                                    if (filters.priceFrom || filters.priceTo) {
                                        const from = filters.priceFrom || '0';
                                        const to = filters.priceTo || '∞';
                                        parts.push(`${from}-${to} млн`);
                                        activeFiltersCount++;
                                    }
                                    
                                    if (filters.districts && filters.districts.length > 0) {
                                        parts.push(filters.districts.join(', '));
                                        activeFiltersCount++;
                                    }
                                    
                                    if (filters.developers && filters.developers.length > 0) {
                                        parts.push(filters.developers.join(', '));
                                        activeFiltersCount++;
                                    }
                                    
                                    if (parts.length > 0) {
                                        filtersDescription = parts.join(' • ');
                                    }
                                } catch (e) {
                                    console.error('Error parsing filters:', e);
                                }
                            }
                            
                            return `
                                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex-1">
                                            <h3 class="font-medium text-gray-900 mb-1">${search.name || 'Без названия'}</h3>
                                            <p class="text-sm text-gray-600">${filtersDescription}</p>
                                        </div>
                                        <span class="px-2 py-1 text-xs rounded-full bg-blue-50 text-blue-700 border border-blue-200">
                                            ${activeFiltersCount} ${activeFiltersCount === 1 ? 'фильтр' : activeFiltersCount < 5 ? 'фильтра' : 'фильтров'}
                                        </span>
                                    </div>
                                    
                                    <div class="text-xs text-gray-500 mb-3">
                                        ${new Date(search.created_at).toLocaleDateString('ru-RU')}
                                    </div>
                                    
                                    <div class="flex gap-2">
                                        <button onclick="viewSearch(${search.id})" class="flex-1 px-3 py-2 bg-[#0088cc] text-white rounded text-sm hover:bg-[#006699] transition-colors">
                                            Просмотр
                                        </button>
                                        <button onclick="sendSearchToClient(${search.id})" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">
                                            Отправить
                                        </button>
                                        <button onclick="deleteSearch(${search.id})" class="px-3 py-2 bg-gray-100 text-gray-600 rounded text-sm hover:bg-red-50 hover:text-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zM8 11a1 1 0 102 0v2a1 1 0 11-2 0v-2zm4 0a1 1 0 102 0v2a1 1 0 11-2 0v-2z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    container.innerHTML = `<div class="text-center py-8 col-span-full"><p class="text-red-500">Ошибка: ${data.error}</p></div>`;
                }
            })
            .catch(error => {
                console.error('Error loading saved searches:', error);
                container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-red-500">Ошибка загрузки сохранённых поисков</p></div>';
            });
    };

    // SAVED SEARCHES FUNCTIONS
    window.viewSearch = function(searchId) {
        fetch('/api/manager/saved-searches')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const search = data.searches.find(s => s.id === searchId);
                    if (search && search.additional_filters) {
                        try {
                            const filters = JSON.parse(search.additional_filters);
                            const params = new URLSearchParams();
                            
                            if (filters.rooms && filters.rooms.length > 0) {
                                params.append('rooms', filters.rooms.join(','));
                            }
                            if (filters.districts && filters.districts.length > 0) {
                                params.append('district', filters.districts.join(','));
                            }
                            if (filters.developers && filters.developers.length > 0) {
                                params.append('developer', filters.developers.join(','));
                            }
                            if (filters.priceFrom && filters.priceFrom !== '') {
                                const priceFromRubles = parseFloat(filters.priceFrom) * 1000000;
                                params.append('price_min', priceFromRubles.toString());
                            }
                            if (filters.priceTo && filters.priceTo !== '') {
                                const priceToRubles = parseFloat(filters.priceTo) * 1000000;
                                params.append('price_max', priceToRubles.toString());
                            }
                            if (filters.areaFrom && filters.areaFrom !== '') {
                                params.append('area_min', filters.areaFrom);
                            }
                            if (filters.areaTo && filters.areaTo !== '') {
                                params.append('area_max', filters.areaTo);
                            }
                            
                            const url = `/properties?${params.toString()}`;
                            window.open(url, '_blank');
                        } catch (e) {
                            console.error('Error parsing filters:', e);
                            window.open('/properties', '_blank');
                        }
                    } else {
                        window.open('/properties', '_blank');
                    }
                }
            })
            .catch(error => {
                console.error('Error loading search filters:', error);
                window.open('/properties', '_blank');
            });
    };

    window.sendSearchToClient = function(searchId) {
        const modalHTML = `
            <div id="send-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-semibold mb-4">Отправить поиск клиенту</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Выберите клиента</label>
                            <select id="client-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc]">
                                <option value="">Загрузка клиентов...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Сообщение (необязательно)</label>
                            <textarea id="search-message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc]" placeholder="Добавьте персональное сообщение..."></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="closeSendSearchModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Отмена
                        </button>
                        <button onclick="confirmSendSearch(${searchId})" class="flex-1 px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699]">
                            Отправить
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        fetch('/api/manager/clients')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('client-select');
                    select.innerHTML = '<option value="">Выберите клиента</option>' + 
                        data.clients.map(client => 
                            `<option value="${client.id}">${client.full_name} (${client.email})</option>`
                        ).join('');
                }
            });
    };

    window.closeSendSearchModal = function() {
        const modal = document.getElementById('send-search-modal');
        if (modal) modal.remove();
    };

    window.confirmSendSearch = function(searchId) {
        const clientId = document.getElementById('client-select').value;
        const message = document.getElementById('search-message').value;
        
        if (!clientId) {
            alert('Пожалуйста, выберите клиента');
            return;
        }
        
        fetch('/api/manager/send-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                search_id: searchId,
                client_id: clientId,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Поиск успешно отправлен клиенту!');
                closeSendSearchModal();
            } else {
                alert('Ошибка при отправке: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Error sending search:', error);
            alert('Ошибка при отправке поиска');
        });
    };

    window.deleteSearch = function(searchId) {
        if (!confirm('Вы уверены, что хотите удалить этот сохранённый поиск?')) {
            return;
        }
        
        fetch(`/api/manager/saved-searches/${searchId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Поиск успешно удалён!');
                loadManagerSavedSearches();
            } else {
                alert('Ошибка при удалении: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Error deleting search:', error);
            alert('Ошибка при удалении поиска');
        });
    };
});

console.log('✅ Saved searches functions defined');

// Navigation functionality - Global scope
window.showSection = function(sectionId) {
    console.log('🔄 showSection called with:', sectionId);
    
    // Hide all sections
    const allSections = document.querySelectorAll('.content-section');
    console.log(`📊 Found ${allSections.length} content-sections`);
    allSections.forEach(section => {
        console.log(`🔄 Removing active from section: ${section.id}`);
        section.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
        tab.classList.remove('border-[#0088CC]', 'text-[#0088CC]');
        tab.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        console.log(`✅ Adding active to section: ${sectionId}`);
        targetSection.classList.add('active');
    } else {
        console.error(`❌ Target section not found: ${sectionId}`);
    }
    
    // Add active class to corresponding tab button
    const activeTab = document.querySelector(`[data-page="${sectionId}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
        activeTab.classList.remove('border-transparent', 'text-gray-500');
        activeTab.classList.add('border-[#0088CC]', 'text-[#0088CC]');
    }
    
    // Load section-specific data
    if (sectionId === 'clients') {
        console.log('🎯 Clients section selected - calling loadClients');
        if (typeof window.loadClients === 'function') {
            window.loadClients();
        } else {
            console.error('❌ window.loadClients is not a function');
        }
    } else if (sectionId === 'collections') {
        loadCollections();
    } else if (sectionId === 'saved-searches') {
        loadManagerSavedSearches();
    } else if (sectionId === 'applications') {
        loadApplications();
    } else if (sectionId === 'presentations') {
        console.log('🎯 Presentations section selected - calling loadPresentations');
        if (typeof window.loadPresentations === 'function') {
            window.loadPresentations();
        } else if (typeof loadPresentations === 'function') {
            loadPresentations();
        } else {
            console.error('❌ loadPresentations function not found');
        }
    } else if (sectionId === 'recommendations') {
        console.log('🎯 Recommendations section selected - calling loadRecommendations');
        if (typeof window.loadRecommendations === 'function') {
            window.loadRecommendations();
        } else {
            console.error('❌ window.loadRecommendations is not a function');
        }
    } else if (sectionId === 'overview' || sectionId === 'dashboard') {
        console.log('🎯 Dashboard overview selected - loading recent recommendations');
        if (typeof window.loadRecentRecommendations === 'function') {
            window.loadRecentRecommendations();
        } else {
            console.error('❌ window.loadRecentRecommendations is not a function');
        }
        // Reload welcome message when returning to overview
        if (typeof window.loadWelcomeMessage === 'function') {
            window.loadWelcomeMessage();
        }
    }
}

// Add click handlers to tab buttons
document.querySelectorAll('.tab-button[data-page]').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const page = this.getAttribute('data-page');
        showSection(page);
    });
});

// User menu toggle (only if element exists)
const userMenuButton = document.getElementById('user-menu-button');
if (userMenuButton) {
    userMenuButton.addEventListener('click', function() {
        const menu = document.getElementById('user-menu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    });
}

// Property search functionality - Make functions global
let selectedProperties = [];
let currentView = 'grid'; // grid or list
let collections = [];
let complexes = {};

// Global functions
window.searchApartments = function() {
    const district = document.getElementById('filter-district').value;
    const developer = document.getElementById('filter-developer').value;
    const rooms = document.getElementById('filter-rooms').value;
    const complex = document.getElementById('filter-complex').value;
    const priceMin = document.getElementById('filter-price-min').value;
    const priceMax = document.getElementById('filter-price-max').value;
    const areaMin = document.getElementById('filter-area-min').value;
    const areaMax = document.getElementById('filter-area-max').value;
    const floorMin = document.getElementById('filter-floor-min').value;
    const floorMax = document.getElementById('filter-floor-max').value;
    const status = document.getElementById('filter-status').value;
    const finishing = document.getElementById('filter-finishing').value;
    
    const searchParams = new URLSearchParams();
    if (district) searchParams.append('district', district);
    if (developer) searchParams.append('developer', developer);
    if (rooms) searchParams.append('rooms', rooms);
    if (complex) searchParams.append('complex', complex);
    if (priceMin) searchParams.append('price_min', priceMin);
    if (priceMax) searchParams.append('price_max', priceMax);
    if (areaMin) searchParams.append('area_min', areaMin);
    if (areaMax) searchParams.append('area_max', areaMax);
    if (floorMin) searchParams.append('floor_min', floorMin);
    if (floorMax) searchParams.append('floor_max', floorMax);
    if (status) searchParams.append('status', status);
    if (finishing) searchParams.append('finishing', finishing);
    
    // Show loading state
    document.getElementById('properties-results').innerHTML = 
        '<p class="text-gray-500 col-span-full text-center py-8">Поиск квартир...</p>';
    
    // Load the EXACT same data that properties.html uses
    console.log('Loading properties using same method as properties.html...');
    
    // First try to get the data from the same endpoint properties.html uses
    fetch('/properties')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract the allProperties array from the script tag
            const scriptTags = doc.querySelectorAll('script');
            let allProperties = [];
            
            for (let script of scriptTags) {
                if (script.textContent.includes('let allProperties = ')) {
                    const match = script.textContent.match(/let allProperties = (\[.*?\]);/s);
                    if (match) {
                        try {
                            allProperties = JSON.parse(match[1]);
                            console.log('Successfully extracted properties from properties.html:', allProperties.length);
                            break;
                        } catch (e) {
                            console.error('Failed to parse properties from properties.html:', e);
                        }
                    }
                }
            }
            
            if (allProperties.length === 0) {
                console.log('Could not extract from properties.html, trying JSON endpoint...');
                return fetch('/data/properties_expanded.json').then(r => r.json());
            }
            
            return allProperties;
        })
        .then(allProperties => {
            console.log('Final properties data:', allProperties.length);
            console.log('Sample property:', allProperties[0]);
            
            // Apply filtering exactly like properties.html
            let filteredProperties = allProperties.filter(property => {
                // District filter
                if (district && property.district && !property.district.toLowerCase().includes(district.toLowerCase())) {
                    return false;
                }
                
                // Developer filter
                if (developer && property.developer && !property.developer.toLowerCase().includes(developer.toLowerCase())) {
                    return false;
                }
                
                // Rooms filter - exactly like properties.html
                if (rooms) {
                    const propertyType = property.type || '';
                    const propertyRooms = property.rooms || 0;
                    
                    if (rooms === 'студия' && propertyType !== 'студия') return false;
                    if (rooms === '1' && propertyRooms !== 1) return false;
                    if (rooms === '2' && propertyRooms !== 2) return false;
                    if (rooms === '3' && propertyRooms !== 3) return false;
                    if (rooms === '4+' && propertyRooms < 4 && propertyType !== 'дом') return false;
                }
                
                // Complex filter (ЖК filter)
                if (complex && complex !== 'Все ЖК' && property.complex_name && !property.complex_name.toLowerCase().includes(complex.toLowerCase())) {
                    return false;
                }
                
                // Price filter (in millions like properties.html)
                if (priceMin && property.price < (parseFloat(priceMin) * 1000000)) return false;
                if (priceMax && property.price > (parseFloat(priceMax) * 1000000)) return false;
                
                // Area filter
                if (areaMin && property.area < parseFloat(areaMin)) return false;
                if (areaMax && property.area > parseFloat(areaMax)) return false;
                
                // Floor filter
                if (floorMin && property.floor < parseInt(floorMin)) return false;
                if (floorMax && property.floor > parseInt(floorMax)) return false;
                
                return true;
            });
            
            console.log('Filtered properties:', filteredProperties.length);
            
            // Show filtered results - limit to 20 for performance
            const displayProps = filteredProperties.slice(0, 20);
            displayApartments(displayProps);
            document.getElementById('results-count').textContent = `${filteredProperties.length} квартир (показано ${displayProps.length})`;
        })
        .catch(error => {
            console.error('Error loading properties:', error);
            document.getElementById('properties-results').innerHTML = 
                '<p class="text-red-500 col-span-full text-center py-8">Ошибка загрузки данных</p>';
            document.getElementById('results-count').textContent = '0 квартир';
        });
}

function filterProperties(properties, filters) {
    const { 
        district, developer, rooms, complex, priceMin, priceMax, areaMin, areaMax, 
        floorMin, floorMax, status, finishing, buildingClass, material, ceilingMin, ceilingMax,
        hasBalcony, hasParking, hasView, isPenthouse, familyMortgage, itMortgage, militaryMortgage, ruralMortgage
    } = filters;
    
    return properties.filter(property => {
        // District filter
        if (district && property.district && !property.district.toLowerCase().includes(district.toLowerCase())) {
            return false;
        }
        
        // Developer filter
        if (developer && property.developer && !property.developer.toLowerCase().includes(developer.toLowerCase())) {
            return false;
        }
        
        // Rooms filter - fix to match property data structure
        if (rooms) {
            const propertyType = property.type || '';
            const propertyRooms = property.rooms || 0;
            
            if (rooms === 'студия' && propertyType !== 'студия') return false;
            if (rooms === '1' && propertyRooms !== 1) return false;
            if (rooms === '2' && propertyRooms !== 2) return false;
            if (rooms === '3' && propertyRooms !== 3) return false;
            if (rooms === '4+' && propertyRooms < 4 && propertyType !== 'дом') return false;
        }
        
        // Complex filter
        if (complex && property.complex_id && property.complex_id != complex) {
            return false;
        }
        
        // Price filter (in millions)
        if (priceMin && property.price < (parseFloat(priceMin) * 1000000)) return false;
        if (priceMax && property.price > (parseFloat(priceMax) * 1000000)) return false;
        
        // Area filter
        if (areaMin && property.area < parseFloat(areaMin)) return false;
        if (areaMax && property.area > parseFloat(areaMax)) return false;
        
        // Floor filter
        if (floorMin && property.floor < parseInt(floorMin)) return false;
        if (floorMax && property.floor > parseInt(floorMax)) return false;
        
        // Status filter
        if (status) {
            const completionDate = property.completion_date || '';
            if (status === 'сдан' && !completionDate.toLowerCase().includes('сдан')) return false;
            if (status === 'строительство' && completionDate.toLowerCase().includes('сдан')) return false;
        }
        
        // Finishing filter  
        if (finishing) {
            const finishType = property.finish_type || '';
            if (finishing === 'черновая' && !finishType.toLowerCase().includes('черновая')) return false;
            if (finishing === 'чистовая' && !finishType.toLowerCase().includes('чистовая')) return false;
            if (finishing === 'под ключ' && !finishType.toLowerCase().includes('премиум')) return false;
        }
        
        // Building class filter
        if (buildingClass && property.building_class && !property.building_class.toLowerCase().includes(buildingClass.toLowerCase())) {
            return false;
        }
        
        // Material filter
        if (material && property.wall_material && !property.wall_material.toLowerCase().includes(material.toLowerCase())) {
            return false;
        }
        
        // Ceiling height filter
        if (ceilingMin && property.ceiling_height && property.ceiling_height < parseFloat(ceilingMin)) return false;
        if (ceilingMax && property.ceiling_height && property.ceiling_height > parseFloat(ceilingMax)) return false;
        
        // Amenities filters
        if (hasBalcony && !property.has_balcony) return false;
        if (hasParking && !property.has_parking) return false;
        if (hasView && !property.has_view) return false;
        if (isPenthouse && !property.is_penthouse) return false;
        
        // Mortgage filters
        if (familyMortgage && !property.family_mortgage) return false;
        if (itMortgage && !property.it_mortgage) return false;
        if (militaryMortgage && !property.military_mortgage) return false;
        if (ruralMortgage && !property.rural_mortgage) return false;
        
        return true;
    });
}

function displayApartments(apartments) {
    const container = document.getElementById('properties-results');
    
    if (apartments.length === 0) {
        container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Квартиры не найдены</p>';
        return;
    }
    
    if (currentView === 'grid') {
        // Grid view
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
        container.innerHTML = apartments.map(apartment => {
            const images = apartment.gallery || [apartment.image] || [];
            const mainImage = images[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=300&q=80';
            const cashback = Math.round(apartment.price * 0.05); // 5% cashback
            
            return `
                <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow ${selectedProperties.includes(apartment.id) ? 'border-green-500 bg-green-50' : ''}">
                    <div class="relative">
                        <img src="${mainImage}" alt="${apartment.title || apartment.complex_name}" class="w-full h-48 object-cover">
                        <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-medium">
                            Кешбэк ₽${(cashback / 1000000).toFixed(1)}М
                        </div>
                        <div class="absolute bottom-2 left-2 bg-white px-2 py-1 rounded text-xs font-medium">
                            ${apartment.rooms === 0 ? 'Студия' : apartment.rooms + '-комн.'}
                        </div>
                    </div>
                    <div class="p-4">
                        <h5 class="font-medium text-gray-900 mb-1">${apartment.title || apartment.complex_name + ' ' + apartment.type}</h5>
                        <p class="text-sm text-gray-600 mb-2">${apartment.district} • ${apartment.developer}</p>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">${apartment.area} м²</span>
                            <span class="text-xs text-gray-500">${apartment.floor}/${apartment.total_floors || apartment.max_floor || 'Н/Д'} этаж</span>
                        </div>
                        <p class="text-lg font-bold text-[#0088cc] mb-2">₽${apartment.price?.toLocaleString() || 'Цена по запросу'}</p>
                        <p class="text-sm text-green-600 mb-3">Кешбек: ₽${cashback.toLocaleString()}</p>
                        <div class="flex gap-2">
                            <button onclick="viewProperty(${apartment.id})" class="flex-1 px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                Подробнее
                            </button>
                            <button onclick="selectProperty(${apartment.id})" class="flex-1 px-3 py-2 ${selectedProperties.includes(apartment.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-[#0088cc] hover:bg-[#006699]'} text-white rounded transition-colors text-sm">
                                ${selectedProperties.includes(apartment.id) ? 'Добавлено ✓' : 'Добавить в подборку'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        // List view
        container.className = 'space-y-4';
        container.innerHTML = apartments.map(apartment => {
            const complex = complexes[apartment.complex_id] || {};
            const images = apartment.images || complex.images || [];
            const mainImage = images[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&h=150&q=80';
            
            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${selectedProperties.includes(apartment.id) ? 'border-green-500 bg-green-50' : ''}">
                    <div class="flex gap-4">
                        <img src="${mainImage}" alt="${apartment.complex_name}" class="w-32 h-24 object-cover rounded flex-shrink-0">
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h5 class="font-medium text-gray-900">${apartment.title || apartment.complex_name + ' ' + apartment.type}</h5>
                                    <p class="text-sm text-gray-600">${apartment.district} • ${apartment.developer}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-[#0088cc]">${apartment.price.toLocaleString()} ₽</p>
                                    <p class="text-sm text-green-600">Кешбек: ${apartment.cashback.toLocaleString()} ₽</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex space-x-4 text-sm text-gray-500">
                                    <span>${apartment.type === 'студия' ? 'Студия' : apartment.rooms + '-комн.'}</span>
                                    <span>${apartment.area} м²</span>
                                    <span>${apartment.floor}/${apartment.max_floor} этаж</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="viewProperty(${apartment.id})" class="px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                        Подробнее
                                    </button>
                                    <button onclick="selectProperty(${apartment.id})" class="px-4 py-2 ${selectedProperties.includes(apartment.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-[#0088cc] hover:bg-[#006699]'} text-white rounded transition-colors text-sm">
                                        ${selectedProperties.includes(apartment.id) ? 'Добавлено ✓' : 'Добавить в подборку'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

// Make all functions global
window.selectProperty = function(propertyId) {
    // Toggle selection
    if (selectedProperties.includes(propertyId)) {
        // Remove from selection
        const index = selectedProperties.indexOf(propertyId);
        selectedProperties.splice(index, 1);
    } else {
        // Add to selection
        selectedProperties.push(propertyId);
    }
    
    updateSelectedProperties();
    updateButtons();
    
    // Update visual state in search results
    const searchContainer = document.getElementById('properties-results');
    if (searchContainer) {
        searchApartments(); // Refresh to update visual state
    }
}

window.updateSelectedProperties = function() {
    const container = document.getElementById('selected-properties');
    const countElement = document.getElementById('selected-count');
    
    countElement.textContent = `${selectedProperties.length} объектов`;
    
    if (selectedProperties.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Объекты не выбраны</p>';
        return;
    }
    
    // Fetch selected properties details
    Promise.all(selectedProperties.map(id => 
        fetch(`/api/properties/${id}`).then(r => r.json())
    )).then(responses => {
        const totalCashback = responses.reduce((sum, response) => {
            return sum + (response.success ? response.property.cashback : 0);
        }, 0);
        
        container.innerHTML = `
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-blue-900">Общий кешбек по подборке:</span>
                    <span class="text-xl font-bold text-blue-900">${totalCashback.toLocaleString()} ₽</span>
                </div>
            </div>
        ` + responses.map((response, index) => {
            if (!response.success) return '';
            const property = response.property;
            return `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                    <div class="flex-1">
                        <h6 class="font-medium">${property.complex_name}</h6>
                        <p class="text-sm text-gray-600">${property.district} • ${property.developer}</p>
                        <p class="text-sm text-gray-600">${property.rooms}-комн. • ${property.area} м² • ${property.price.toLocaleString()} ₽</p>
                        <p class="text-sm text-green-600">Кешбек: ${property.cashback.toLocaleString()} ₽</p>
                    </div>
                    <button onclick="removeProperty(${index})" class="ml-3 text-red-500 hover:text-red-700 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }).join('');
    });
}

window.updateButtons = function() {
    const hasSelection = selectedProperties.length > 0;
    document.getElementById('save-collection-btn').disabled = !hasSelection;
    document.getElementById('send-collection-btn').disabled = !hasSelection;
    document.getElementById('clear-selection-btn').disabled = !hasSelection;
}

window.removeProperty = function(index) {
    selectedProperties.splice(index, 1);
    updateSelectedProperties();
    updateButtons();
    
    // Refresh search results to update visual state
    const searchContainer = document.getElementById('properties-results');
    if (searchContainer && searchContainer.innerHTML !== '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>') {
        searchApartments();
    }
}

// Save search with client-compatible format
window.saveCurrentSearch = function() {
    openSaveSearchModal();
};

// Create save search modal
function openSaveSearchModal() {
    const modalHTML = `
        <div id="save-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">Сохранить поиск</h3>
                <form id="save-search-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Название поиска</label>
                        <input type="text" id="manager-search-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                               placeholder="Например: 2-комн в центре до 10млн">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email клиента</label>
                        <input type="email" id="manager-client-email" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                               placeholder="client@example.com">
                        <p class="text-xs text-gray-500 mt-1">Если указан, поиск будет отправлен клиенту и сохранён в его аккаунте</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                        <textarea id="manager-search-description" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                                  placeholder="Дополнительные заметки о поиске"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeSaveSearchModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                            Отмена
                        </button>
                        <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-md hover:bg-[#0077bb]">
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Auto-generate search name
    generateManagerSearchName();
    
    // Bind events
    document.getElementById('save-search-form').addEventListener('submit', handleSaveSearch);
}

function generateManagerSearchName() {
    const district = document.getElementById('filter-district').value;
    const developer = document.getElementById('filter-developer').value;
    const rooms = document.getElementById('filter-rooms').value;
    const priceMin = document.getElementById('filter-price-min').value;
    const priceMax = document.getElementById('filter-price-max').value;
    
    let name = 'Поиск ';
    if (rooms) name += rooms + ' ';
    if (district) name += 'в ' + district + ' ';
    if (developer) name += 'от ' + developer + ' ';
    if (priceMin || priceMax) {
        name += `${priceMin || '0'}-${priceMax || '∞'} млн`;
    }
    
    document.getElementById('manager-search-name').value = name.trim() || 'Мой поиск';
}

function closeSaveSearchModal() {
    const modal = document.getElementById('save-search-modal');
    if (modal) modal.remove();
}

async function handleSaveSearch(e) {
    e.preventDefault();
    
    const searchName = document.getElementById('manager-search-name').value.trim();
    const clientEmail = document.getElementById('manager-client-email').value.trim();
    const description = document.getElementById('manager-search-description').value.trim();
    
    if (!searchName) {
        alert('Введите название поиска');
        return;
    }
    
    // Convert manager filters to client-compatible format
    const clientFilters = convertManagerFiltersToClient();
    
    const searchData = {
        name: searchName,
        description: description,
        client_email: clientEmail,
        notify_new_matches: true,
        search_type: 'properties',
        ...clientFilters
    };
    
    try {
        const response = await fetch('/api/searches', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(searchData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeSaveSearchModal();
            if (clientEmail) {
                alert(`Поиск успешно сохранён и отправлен клиенту на ${clientEmail}!`);
            } else {
                alert('Поиск успешно сохранён!');
            }
        } else {
            alert('Ошибка при сохранении поиска: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error saving search:', error);
        alert('Ошибка при сохранении поиска');
    }
}

// Convert manager filters to client-compatible format
function convertManagerFiltersToClient() {
    return {
        // Basic filters
        location: document.getElementById('filter-district').value || '',
        developer: document.getElementById('filter-developer').value || '',
        property_type: document.getElementById('filter-rooms').value || '',
        complex_name: document.getElementById('filter-complex').value || '',
        
        // Price (convert to client format)
        price_min: document.getElementById('filter-price-min').value ? 
                   parseFloat(document.getElementById('filter-price-min').value) * 1000000 : null,
        price_max: document.getElementById('filter-price-max').value ? 
                   parseFloat(document.getElementById('filter-price-max').value) * 1000000 : null,
        
        // Size
        size_min: document.getElementById('filter-area-min').value ? 
                  parseFloat(document.getElementById('filter-area-min').value) : null,
        size_max: document.getElementById('filter-area-max').value ? 
                  parseFloat(document.getElementById('filter-area-max').value) : null,
        
        // Floor
        floor_min: document.getElementById('filter-floor-min').value ? 
                   parseInt(document.getElementById('filter-floor-min').value) : null,
        floor_max: document.getElementById('filter-floor-max').value ? 
                   parseInt(document.getElementById('filter-floor-max').value) : null,
        
        // Additional filters as JSON
        additional_filters: JSON.stringify({
            status: document.getElementById('filter-status').value || '',
            finishing: document.getElementById('filter-finishing').value || '',
            buildingClass: document.getElementById('filter-class') ? document.getElementById('filter-class').value : '',
            material: document.getElementById('filter-material') ? document.getElementById('filter-material').value : '',
            ceilingMin: document.getElementById('filter-ceiling-min') ? document.getElementById('filter-ceiling-min').value : '',
            ceilingMax: document.getElementById('filter-ceiling-max') ? document.getElementById('filter-ceiling-max').value : '',
            hasBalcony: document.getElementById('filter-balcony') ? document.getElementById('filter-balcony').checked : false,
            hasParking: document.getElementById('filter-parking') ? document.getElementById('filter-parking').checked : false,
            hasView: document.getElementById('filter-view') ? document.getElementById('filter-view').checked : false,
            isPenthouse: document.getElementById('filter-penthouse') ? document.getElementById('filter-penthouse').checked : false,
            familyMortgage: document.getElementById('filter-family-mortgage') ? document.getElementById('filter-family-mortgage').checked : false,
            itMortgage: document.getElementById('filter-it-mortgage') ? document.getElementById('filter-it-mortgage').checked : false,
            militaryMortgage: document.getElementById('filter-military-mortgage') ? document.getElementById('filter-military-mortgage').checked : false,
            ruralMortgage: document.getElementById('filter-rural-mortgage') ? document.getElementById('filter-rural-mortgage').checked : false
        })
    };
};

// Show saved searches from server
window.showSavedSearches = function() {
    loadSavedSearchesPage();
};

async function loadSavedSearchesPage() {
    try {
        const response = await fetch('/api/searches', {
            method: 'GET',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            displaySavedSearchesModal(result.searches);
        } else {
            alert('Ошибка загрузки сохранённых поисков');
        }
    } catch (error) {
        console.error('Error loading saved searches:', error);
        alert('Ошибка загрузки сохранённых поисков');
    }
}

function displaySavedSearchesModal(searches) {
    if (searches.length === 0) {
        alert('У вас нет сохранённых поисков');
        return;
    }
    
    const searchesHTML = searches.map(search => `
        <div class="border rounded-lg p-4 mb-3 bg-gray-50">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-lg">${search.name}</h4>
                    <div class="text-sm text-gray-600 mt-1">
                        Создан: ${search.created_at}
                    </div>
                    ${getSearchSummary(search)}
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="loadSavedSearch(${search.id})" class="px-3 py-1 bg-[#0088cc] text-white text-sm rounded hover:bg-[#0077bb]">
                        Применить
                    </button>
                    <button onclick="deleteSavedSearch(${search.id})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                        Удалить
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    const modalHTML = `
        <div id="saved-searches-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Сохранённые поиски</h3>
                    <button onclick="closeSavedSearchesModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="searches-list">
                    ${searchesHTML}
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeSavedSearchesModal() {
    const modal = document.getElementById('saved-searches-modal');
    if (modal) modal.remove();
}

function getSearchSummary(search) {
    const parts = [];
    
    if (search.property_type) parts.push(search.property_type);
    if (search.location) parts.push('в ' + search.location);
    if (search.price_min || search.price_max) {
        let priceRange = '';
        if (search.price_min) priceRange += `от ${formatPrice(search.price_min)}`;
        if (search.price_max) priceRange += ` до ${formatPrice(search.price_max)}`;
        parts.push(priceRange);
    }
    if (search.developer) parts.push('от ' + search.developer);
    if (search.complex_name) parts.push('ЖК ' + search.complex_name);

    if (parts.length === 0) return '';
    return `<div class="mt-2 text-sm text-gray-600">${parts.join(', ')}</div>`;
}

function formatPrice(price) {
    if (price >= 1000000) {
        return (price / 1000000).toFixed(1) + 'млн';
    }
    return price.toLocaleString() + 'р';
}

async function loadSavedSearch(searchId) {
    try {
        const response = await fetch(`/api/searches/${searchId}/apply`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            applySavedSearch(result.search);
            closeSavedSearchesModal();
            alert('Поиск применён');
        } else {
            alert('Ошибка при применении поиска');
        }
    } catch (error) {
        console.error('Error applying search:', error);
        alert('Ошибка при применении поиска');
    }
}

function applySavedSearch(search) {
    // Clear current filters
    document.getElementById('filter-district').value = '';
    document.getElementById('filter-developer').value = '';
    document.getElementById('filter-rooms').value = '';
    document.getElementById('filter-complex').value = '';
    document.getElementById('filter-price-min').value = '';
    document.getElementById('filter-price-max').value = '';
    document.getElementById('filter-area-min').value = '';
    document.getElementById('filter-area-max').value = '';
    
    // Apply basic filters
    if (search.location) document.getElementById('filter-district').value = search.location;
    if (search.developer) document.getElementById('filter-developer').value = search.developer;
    if (search.property_type) document.getElementById('filter-rooms').value = search.property_type;
    if (search.complex_name) document.getElementById('filter-complex').value = search.complex_name;
    
    // Apply price filters (convert from rubles to millions)
    if (search.price_min) document.getElementById('filter-price-min').value = (search.price_min / 1000000).toString();
    if (search.price_max) document.getElementById('filter-price-max').value = (search.price_max / 1000000).toString();
    
    // Apply size filters
    if (search.size_min) document.getElementById('filter-area-min').value = search.size_min.toString();
    if (search.size_max) document.getElementById('filter-area-max').value = search.size_max.toString();
    
    // Apply additional filters if available
    if (search.additional_filters) {
        try {
            const additionalFilters = JSON.parse(search.additional_filters);
            
            if (additionalFilters.status && document.getElementById('filter-status')) {
                document.getElementById('filter-status').value = additionalFilters.status;
            }
            if (additionalFilters.finishing && document.getElementById('filter-finishing')) {
                document.getElementById('filter-finishing').value = additionalFilters.finishing;
            }
            
            // Apply advanced filters
            if (document.getElementById('filter-class') && additionalFilters.buildingClass) {
                document.getElementById('filter-class').value = additionalFilters.buildingClass;
            }
            if (document.getElementById('filter-material') && additionalFilters.material) {
                document.getElementById('filter-material').value = additionalFilters.material;
            }
            
            // Apply checkboxes
            if (document.getElementById('filter-balcony')) document.getElementById('filter-balcony').checked = additionalFilters.hasBalcony || false;
            if (document.getElementById('filter-parking')) document.getElementById('filter-parking').checked = additionalFilters.hasParking || false;
            if (document.getElementById('filter-view')) document.getElementById('filter-view').checked = additionalFilters.hasView || false;
            if (document.getElementById('filter-penthouse')) document.getElementById('filter-penthouse').checked = additionalFilters.isPenthouse || false;
            
        } catch (e) {
            console.log('Could not parse additional filters:', e);
        }
    }
    
    // Execute search
    searchApartments();
}

async function deleteSavedSearch(searchId) {
    if (!confirm('Удалить сохранённый поиск?')) return;
    
    try {
        const response = await fetch(`/api/searches/${searchId}`, {
            method: 'DELETE',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reload the searches modal
            closeSavedSearchesModal();
            loadSavedSearchesPage();
        } else {
            alert('Ошибка при удалении поиска');
        }
    } catch (error) {
        console.error('Error deleting search:', error);
        alert('Ошибка при удалении поиска');
    }
};

// View property details
window.viewProperty = function(propertyId) {
    // Open property in new tab or modal
    window.open(`/property/${propertyId}`, '_blank');
};

// Load clients - Global scope - MAIN FUNCTION
window.loadClients = function() {
    console.log('🔄 Loading clients...');
    const tableBody = document.getElementById('clients-table-body');
    
    if (!tableBody) {
        console.error('❌ clients-table-body not found');
        return;
    }
    
    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка клиентов...</td></tr>';
    
    fetch('/api/manager/clients')
        .then(response => {
            console.log('📡 Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Clients data received:', data);
            if (data.success) {
                console.log('✅ Success! Displaying', data.clients.length, 'clients');
                displayClients(data.clients);
                updateClientSelect(data.clients);
                // Update count in tab
                const countElement = document.getElementById('clients-count');
                if (countElement) {
                    countElement.textContent = data.clients.length;
                }
            } else {
                console.error('❌ API returned error:', data.error);
                tableBody.innerHTML = 
                    `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Ошибка: ${data.error}</td></tr>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading clients:', error);
            tableBody.innerHTML = 
                '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Ошибка загрузки клиентов</td></tr>';
        });
}

// Ensure displayClients is available
window.displayClients = function(clients) {
    console.log('📝 Displaying clients:', clients);
    const tbody = document.getElementById('clients-table-body');
    if (!tbody) {
        console.error('❌ Table body not found');
        return;
    }
    
    if (!clients || clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Клиенты не найдены</td></tr>';
        return;
    }
    
    tbody.innerHTML = clients.map(client => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${client.full_name || 'Не указано'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email || 'Не указано'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.phone || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                    Активен
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="editClient(${client.id})" class="text-[#0088cc] hover:text-[#006699] mr-3">Редактировать</button>
                <button onclick="deleteClient(${client.id}, '${client.full_name}')" class="text-red-600 hover:text-red-900">Удалить</button>
            </td>
        </tr>
    `).join('');
}

// Removed duplicate - using window.displayClients above

function updateClientSelect(clients) {
    const select = document.getElementById('collection-client');
    select.innerHTML = '<option value="">Выберите клиента</option>' + 
        clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
}

// Load recommendations - Global scope
window.loadRecommendations = function() {
    console.log('Loading recommendations...');
    fetch('/api/manager/recommendations')
        .then(response => response.json())
        .then(data => {
            console.log('Recommendations data received:', data);
            if (data.success) {
                displayRecommendations(data.recommendations);
                updateRecommendationsStats(data.stats || {});
            } else {
                console.error('Failed to load recommendations:', data.error);
                document.getElementById('recommendations-container').innerHTML = 
                    '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = 
                '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
        });
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">Рекомендации не найдены</div>';
        return;
    }
    
    container.innerHTML = recommendations.map(rec => `
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-medium text-gray-900">${rec.property_title || 'Объект недвижимости'}</h4>
                    <p class="text-sm text-gray-600">Клиент: ${rec.client_name}</p>
                </div>
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(rec.status)}">
                    ${getStatusText(rec.status)}
                </span>
            </div>
            <p class="text-sm text-gray-600 mb-2">${rec.message || 'Рекомендация отправлена'}</p>
            <div class="text-xs text-gray-500">
                Отправлено: ${new Date(rec.created_at).toLocaleDateString('ru-RU')}
            </div>
        </div>
    `).join('');
}

function updateRecommendationsStats(stats) {
    document.getElementById('recommendations-sent').textContent = stats.sent || 0;
    document.getElementById('recommendations-viewed').textContent = stats.viewed || 0;
    document.getElementById('recommendations-interested').textContent = stats.interested || 0;
    document.getElementById('recommendations-scheduled').textContent = stats.scheduled || 0;
}

function getStatusClass(status) {
    const classes = {
        'sent': 'bg-blue-100 text-blue-800',
        'viewed': 'bg-green-100 text-green-800',
        'interested': 'bg-purple-100 text-purple-800',
        'not_interested': 'bg-gray-100 text-gray-800',
        'scheduled_viewing': 'bg-orange-100 text-orange-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'sent': 'Отправлено',
        'viewed': 'Просмотрено',
        'interested': 'Заинтересованы',
        'not_interested': 'Не заинтересованы',
        'scheduled_viewing': 'Просмотр назначен'
    };
    return texts[status] || 'Неизвестно';
}

// Load complexes for filter
function loadComplexes() {
    fetch('/api/complexes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('filter-complex');
                select.innerHTML = '<option value="">Все ЖК</option>' + 
                    data.complexes.map(complex => `<option value="${complex.id}">${complex.name}</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading complexes:', error));
}

// Edit client function
window.editClient = function(clientId) {
    // Find client data using correct endpoint
    fetch(`/manager/get-client/${clientId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            console.log('Client data received:', data);
            if (data.success) {
                const client = data;
                
                // Create edit modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">Редактировать клиента</h3>
                        <form id="edit-client-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Полное имя</label>
                                    <input type="text" id="edit-client-full-name" value="${client.full_name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="edit-client-email" value="${client.email}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                                    <input type="tel" id="edit-client-phone" value="${client.phone || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
                                    <select id="edit-client-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                        <option value="1" ${client.is_active ? 'selected' : ''}>Активен</option>
                                        <option value="0" ${!client.is_active ? 'selected' : ''}>Неактивен</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">Отмена</button>
                                <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">Сохранить</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                document.getElementById('edit-client-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveClientChanges(clientId);
                });
            } else {
                alert('Ошибка загрузки данных клиента');
            }
        })
        .catch(error => {
            console.error('Error loading client:', error);
            alert('Ошибка загрузки данных клиента');
        });
};

// Delete client function
window.deleteClient = function(clientId, clientName) {
    if (confirm(`Вы уверены, что хотите удалить клиента "${clientName}"?`)) {
        fetch(`/manager/delete-client`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `client_id=${clientId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Клиент успешно удален');
                loadClients(); // Reload the clients list
            } else {
                alert(data.message || 'Ошибка при удалении клиента');
            }
        })
        .catch(error => {
            console.error('Error deleting client:', error);
            alert('Ошибка при удалении клиента');
        });
    }
};

// Close edit modal
window.closeEditModal = function() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
};

// Save client changes
function saveClientChanges(clientId) {
    const formData = new FormData();
    formData.append('client_id', clientId);
    formData.append('full_name', document.getElementById('edit-client-full-name').value);
    formData.append('email', document.getElementById('edit-client-email').value);
    formData.append('phone', document.getElementById('edit-client-phone').value);
    if (document.getElementById('edit-client-status').value === '1') {
        formData.append('is_active', 'on');
    }
    
    fetch(`/manager/edit-client`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Данные клиента обновлены');
            closeEditModal();
            loadClients(); // Reload the clients list
        } else {
            alert(data.message || 'Ошибка при сохранении');
        }
    })
    .catch(error => {
        console.error('Error saving client:', error);
        alert('Ошибка при сохранении');
    });
}

// Show add client modal
function showAddClientModal() {
    console.log('showAddClientModal called');
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Добавить нового клиента</h3>
            <form id="add-client-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Полное имя *</label>
                        <input type="text" id="add-client-full-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required minlength="2" maxlength="100">
                        <div class="text-xs text-gray-500 mt-1">Введите имя и фамилию</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="add-client-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                        <div class="text-xs text-gray-500 mt-1">Формат: example@domain.com</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                        <input type="tel" id="add-client-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" placeholder="+7-918-123-45-67">
                        <div class="text-xs text-gray-500 mt-1">Формат: +7-918-123-45-67</div>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="add-client-active" checked class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Активный клиент</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddClientModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">Добавить</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add phone number formatting with better UX
    const phoneInput = document.getElementById('add-client-phone');
    phoneInput.addEventListener('input', function(e) {
        let cursorPosition = e.target.selectionStart;
        let value = e.target.value.replace(/\D/g, '');
        
        // Handle different input patterns
        if (value.startsWith('7')) {
            value = value.substring(1);
        } else if (value.startsWith('8')) {
            value = value.substring(1);
        }
        
        let formattedValue = '';
        if (value.length > 0) {
            formattedValue = '+7';
            if (value.length >= 1) {
                formattedValue += '-' + value.substring(0, Math.min(3, value.length));
            }
            if (value.length >= 4) {
                formattedValue += '-' + value.substring(3, Math.min(6, value.length));
            }
            if (value.length >= 7) {
                formattedValue += '-' + value.substring(6, Math.min(8, value.length));
            }
            if (value.length >= 9) {
                formattedValue += '-' + value.substring(8, Math.min(10, value.length));
            }
        }
        
        e.target.value = formattedValue;
        
        // Restore cursor position approximately
        if (cursorPosition <= formattedValue.length) {
            e.target.setSelectionRange(cursorPosition, cursorPosition);
        }
    });
    
    // Auto-start with +7- when user starts typing
    phoneInput.addEventListener('focus', function(e) {
        if (!e.target.value) {
            e.target.value = '+7-';
        }
    });
    
    // Clear placeholder text on empty
    phoneInput.addEventListener('blur', function(e) {
        if (e.target.value === '+7-' || e.target.value === '+7') {
            e.target.value = '';
        }
    });
    
    // Handle form submission
    document.getElementById('add-client-form').addEventListener('submit', function(e) {
        console.log('Form submit event triggered');
        e.preventDefault();
        console.log('Default prevented, calling validateAndSaveNewClient');
        validateAndSaveNewClient();
    });
}

// Close add client modal
function closeAddClientModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

// Validate and save new client
function validateAndSaveNewClient() {
    const fullName = document.getElementById('add-client-full-name').value.trim();
    const email = document.getElementById('add-client-email').value.trim();
    const phone = document.getElementById('add-client-phone').value.trim();
    
    console.log('Validating client data:', {fullName, email, phone});
    
    // Validation
    if (!fullName || fullName.length < 2) {
        alert('Пожалуйста, введите корректное полное имя (минимум 2 символа)');
        return;
    }
    
    // Email validation
    const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
    if (!email || !emailRegex.test(email)) {
        alert('Пожалуйста, введите корректный email адрес');
        return;
    }
    
    // Phone validation (optional but must be correct format if provided)
    const phoneRegex = /^\+7-\d{3}-\d{3}-\d{2}-\d{2}$/;
    if (phone && !phoneRegex.test(phone)) {
        alert('Пожалуйста, введите телефон в формате +7-918-123-45-67 или оставьте поле пустым');
        return;
    }
    
    console.log('Validation passed, calling saveNewClient');
    saveNewClient(fullName, email, phone);
}

// Save new client
function saveNewClient(fullName, email, phone) {
    const requestData = {
        full_name: fullName,
        email: email,
        phone: phone || null,
        is_active: document.getElementById('add-client-active').checked
    };
    
    console.log('Sending client data:', requestData);
    
    fetch('/api/manager/add-client', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            alert(`Клиент "${fullName}" успешно добавлен!`);
            closeAddClientModal();
            
            // Force reload clients with a small delay to ensure server processing
            setTimeout(() => {
                loadClients();
                // Also update the client select dropdown
                loadClientsForCollectionSelect();
            }, 500);
        } else {
            alert(data.error || 'Ошибка при добавлении клиента');
        }
    })
    .catch(error => {
        console.error('Error adding client:', error);
        alert('Ошибка при добавлении клиента. Проверьте подключение к интернету.');
    });
}

// Load clients for collection select dropdown
function loadClientsForCollectionSelect() {
    fetch('/api/manager/clients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('collection-client');
                if (select) {
                    select.innerHTML = '<option value="">Выберите клиента</option>' + 
                        data.clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
                }
            }
        })
        .catch(error => console.error('Error loading clients for collection select:', error));
}

// Event listeners
// Remove application modal functionality - causes unwanted popups
function removeApplicationModals() {
    // Remove any existing application modals
    const modals = document.querySelectorAll('.modal, [id*="application"], [id*="Application"]');
    modals.forEach(modal => {
        if (modal.id !== 'user-menu' && !modal.closest('.content-section')) {
            modal.remove();
        }
    });
    
    // Disable any application form handlers
    const forms = document.querySelectorAll('form[action*="application"]');
    forms.forEach(form => form.style.display = 'none');
}

document.addEventListener('DOMContentLoaded', function() {
    // Remove unwanted application modals first
    removeApplicationModals();
    // Auto-activate create-collection section for managers
    showSection('create-collection');
    
    // Toggle advanced filters (only if element exists)
    const toggleFiltersButton = document.getElementById('toggle-advanced-filters');
    if (toggleFiltersButton) {
        toggleFiltersButton.addEventListener('click', function() {
            const advancedFilters = document.getElementById('advanced-filters');
            const button = this;
            
            if (advancedFilters && advancedFilters.classList.contains('hidden')) {
                advancedFilters.classList.remove('hidden');
                button.textContent = '- Скрыть дополнительные фильтры';
            } else if (advancedFilters) {
                advancedFilters.classList.add('hidden');
                button.textContent = '+ Дополнительные фильтры';
            }
        });
    }

    // View toggle buttons (only if elements exist)
    const viewGridBtn = document.getElementById('view-grid-btn');
    const viewListBtn = document.getElementById('view-list-btn');
    
    if (viewGridBtn) {
        viewGridBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            currentView = 'grid';
            this.classList.add('bg-[#0088cc]', 'text-white');
            this.classList.remove('bg-white', 'text-gray-600');
            if (viewListBtn) {
                viewListBtn.classList.remove('bg-[#0088cc]', 'text-white');
                viewListBtn.classList.add('bg-white', 'text-gray-600');
            }
            
            // Re-render if we have results
            const container = document.getElementById('properties-results');
            if (container && container.children.length > 0 && !container.querySelector('p')) {
                searchApartments();
            }
        });
    }

    if (viewListBtn) {
        viewListBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            currentView = 'list';
            this.classList.add('bg-[#0088cc]', 'text-white');
            this.classList.remove('bg-white', 'text-gray-600');
            if (viewGridBtn) {
                viewGridBtn.classList.remove('bg-[#0088cc]', 'text-white');
                viewGridBtn.classList.add('bg-white', 'text-gray-600');
            }
            
            // Re-render if we have results
            const container = document.getElementById('properties-results');
            if (container && container.children.length > 0 && !container.querySelector('p')) {
                searchApartments();
            }
        });
    }
    
    // Search apartments button
    document.getElementById('search-apartments-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        searchApartments();
    });
    
    // Add filter change listeners to trigger search
    ['filter-district', 'filter-developer', 'filter-rooms', 'filter-complex', 'filter-price-min', 'filter-price-max', 'filter-area-min', 'filter-area-max', 'filter-floor-min', 'filter-floor-max', 'filter-status', 'filter-finishing'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                // Only search if we already have results
                const container = document.getElementById('properties-results');
                if (container && !container.querySelector('p')) {
                    searchApartments();
                }
            });
        }
    });

    // Load complexes for filter
    loadComplexes();
    
    // Add client button
    document.getElementById('add-client-btn').addEventListener('click', function() {
        showAddClientModal();
    });
    
    // Clear selection button
    document.getElementById('clear-selection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        selectedProperties = [];
        updateSelectedProperties();
        updateButtons();
        
        // Refresh search results
        const searchContainer = document.getElementById('properties-results');
        if (searchContainer && searchContainer.innerHTML !== '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>') {
            searchApartments();
        }
    });
    
    // Save collection button
    document.getElementById('save-collection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const name = document.getElementById('collection-name').value;
        const clientId = document.getElementById('collection-client').value;
        
        if (!name || !clientId || selectedProperties.length === 0) {
            alert('Заполните все поля и выберите объекты');
            return;
        }
        
        fetch('/api/manager/collections', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                client_id: clientId,
                property_ids: selectedProperties
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Подборка успешно создана!');
                // Reset form
                document.getElementById('collection-name').value = '';
                document.getElementById('collection-client').value = '';
                selectedProperties = [];
                updateSelectedProperties();
                updateButtons();
                // Clear search results
                document.getElementById('properties-results').innerHTML = 
                    '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>';
            } else {
                alert('Ошибка создания подборки: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving collection:', error);
            alert('Ошибка сохранения подборки');
        });
    });
    
    // Send collection button
    document.getElementById('send-collection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const name = document.getElementById('collection-name').value;
        const clientId = document.getElementById('collection-client').value;
        
        if (!name || !clientId || selectedProperties.length === 0) {
            alert('Заполните все поля и выберите объекты');
            return;
        }
        
        if (confirm('Отправить подборку клиенту по email?')) {
            fetch('/api/manager/send-collection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    client_id: clientId,
                    property_ids: selectedProperties
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Подборка отправлена клиенту!');
                    // Reset form
                    document.getElementById('collection-name').value = '';
                    document.getElementById('collection-client').value = '';
                    selectedProperties = [];
                    updateSelectedProperties();
                    updateButtons();
                    // Clear search results
                    document.getElementById('properties-results').innerHTML = 
                        '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>';
                } else {
                    alert('Ошибка отправки: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error sending collection:', error);
                alert('Ошибка отправки подборки');
            });
        }
    });
    
    // Load initial data based on active section
    loadClients();
    
    // Clean up any remaining unwanted modals periodically
    setInterval(removeApplicationModals, 5000);
});

// Manager Saved Searches functionality
window.loadManagerSavedSearches = async function() {
    try {
        const response = await fetch('/api/manager/saved-searches');
        const data = await response.json();
        
        const grid = document.getElementById('saved-searches-grid');
        if (!data.success || !data.searches.length) {
            grid.innerHTML = `
                <div class="text-center py-12 col-span-full">
                    <div class="w-16 h-16 mx-auto mb-4 text-gray-300">
                        <i class="fas fa-search text-4xl"></i>
                    </div>
                    <p class="text-gray-500 text-lg mb-4">У вас пока нет сохранённых поисков</p>
                    <button onclick="createNewSearch()" class="px-6 py-3 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition-colors">
                        <i class="fas fa-plus mr-2"></i>Создать первый поиск
                    </button>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = data.searches.map(search => `
            <div class="bg-gray-50 rounded-lg border p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg text-gray-800 mb-1">${search.name}</h3>
                        ${search.description ? '<p class="text-sm text-gray-600 mb-2">' + search.description + '</p>' : ''}
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${search.additional_filters ? formatSearchFilters(JSON.parse(search.additional_filters)) : ''}
                        </div>
                        <div class="flex items-center text-sm text-gray-500 space-x-4">
                            <span><i class="fas fa-calendar mr-1"></i>${formatDate(search.created_at)}</span>
                            <span><i class="fas fa-paper-plane mr-1"></i>Отправлен ${search.usage_count || 0} раз</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="sendSearchToClient(${search.id})" class="flex-1 px-3 py-2 bg-[#0088cc] text-white text-sm rounded-md hover:bg-[#0077bb] transition-colors">
                        <i class="fas fa-share mr-1"></i>Отправить клиенту
                    </button>
                    <button onclick="editManagerSearch(${search.id})" class="px-3 py-2 text-gray-600 border border-gray-300 text-sm rounded-md hover:bg-gray-50 transition-colors">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteManagerSearch(${search.id})" class="px-3 py-2 text-[#0088CC] border border-gray-300 text-sm rounded-md hover:bg-red-50 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading saved searches:', error);
        document.getElementById('saved-searches-grid').innerHTML = `
            <div class="text-center py-8 col-span-full">
                <p class="text-red-500">Ошибка загрузки сохранённых поисков</p>
            </div>
        `;
    }
};

window.createNewSearch = function() {
    window.open('/properties', '_blank');
};

window.sendSearchToClient = async function(searchId) {
    // Open modal to select client
    const modalHTML = `
        <div id="send-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">Отправить поиск клиенту</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Выберите клиента</label>
                    <select id="client-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]">
                        <option value="">Выберите клиента...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Сообщение (необязательно)</label>
                    <textarea id="search-message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]" placeholder="Дополнительное сообщение для клиента..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeSendSearchModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Отмена
                    </button>
                    <button onclick="confirmSendSearch(${searchId})" class="px-4 py-2 bg-[#0088cc] text-white rounded-md hover:bg-[#0077bb]">
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load clients into select
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        const select = document.getElementById('client-select');
        if (data.success && data.clients.length > 0) {
            select.innerHTML = '<option value="">Выберите клиента...</option>' + 
                data.clients.map(client => `<option value="${client.id}">${client.full_name} (${client.email})</option>`).join('');
        } else {
            select.innerHTML = '<option value="">Клиенты не найдены</option>';
        }
    } catch (error) {
        console.error('Error loading clients:', error);
    }
};

window.closeSendSearchModal = function() {
    const modal = document.getElementById('send-search-modal');
    if (modal) modal.remove();
};

window.confirmSendSearch = async function(searchId) {
    const clientId = document.getElementById('client-select').value;
    const message = document.getElementById('search-message').value.trim();
    
    if (!clientId) {
        alert('Выберите клиента');
        return;
    }
    
    try {
        const response = await fetch('/api/manager/send-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                search_id: searchId,
                client_id: clientId,
                message: message
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Поиск успешно отправлен клиенту!');
            closeSendSearchModal();
            loadManagerSavedSearches(); // Refresh list
        } else {
            alert('Ошибка отправки: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending search:', error);
        alert('Ошибка отправки поиска');
    }
};

window.deleteManagerSearch = async function(searchId) {
    if (!confirm('Удалить сохранённый поиск?')) return;
    
    try {
        const response = await fetch(`/api/manager/saved-search/${searchId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            loadManagerSavedSearches(); // Refresh list
        } else {
            alert('Ошибка удаления: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting search:', error);
        alert('Ошибка удаления поиска');
    }
};

function formatSearchFilters(filters) {
    const tags = [];
    if (filters.rooms && filters.rooms.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">${filters.rooms.join(', ')}</span>`);
    }
    if (filters.districts && filters.districts.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-green-800 text-xs rounded-full">${filters.districts.join(', ')}</span>`);
    }
    if (filters.priceTo || filters.priceFrom) {
        const priceText = `${filters.priceFrom || '0'}-${filters.priceTo || '∞'} млн`;
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-yellow-800 text-xs rounded-full">${priceText}</span>`);
    }
    if (filters.developers && filters.developers.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-purple-800 text-xs rounded-full">${filters.developers[0]}${filters.developers.length > 1 ? '...' : ''}</span>`);
    }
    return tags.join('');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('ru-RU');
}

// Recommendations functionality - using global window.loadRecommendations

function updateRecommendationStats(recommendations) {
    const stats = {
        sent: recommendations.length,
        viewed: recommendations.filter(r => r.viewed_at).length,
        interested: recommendations.filter(r => r.client_response === 'interested').length,
        scheduled: recommendations.filter(r => r.viewing_scheduled_at).length
    };
    
    document.getElementById('recommendations-sent').textContent = stats.sent;
    document.getElementById('recommendations-viewed').textContent = stats.viewed;
    document.getElementById('recommendations-interested').textContent = stats.interested;
    document.getElementById('recommendations-scheduled').textContent = stats.scheduled;
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-paper-plane text-4xl mb-4"></i>
                <p>Рекомендации не найдены</p>
                <p class="text-sm">Перейдите на страницу недвижимости, чтобы отправить первую рекомендацию</p>
            </div>
        `;
        return;
    }
    
    const html = recommendations.map(rec => {
        const statusClass = getStatusClass(rec.status);
        const priorityClass = getPriorityClass(rec.priority_level);
        const createdAt = new Date(rec.created_at).toLocaleDateString('ru-RU');
        const viewedAt = rec.viewed_at ? new Date(rec.viewed_at).toLocaleDateString('ru-RU') : null;
        
        return `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg text-gray-800 mb-1">${rec.title}</h4>
                        <p class="text-gray-600 text-sm mb-2">
                            <i class="fas ${rec.recommendation_type === 'property' ? 'fa-home' : 'fa-building'} mr-1"></i>
                            ${rec.recommendation_type === 'property' ? 'Квартира' : 'ЖК'}: ${rec.item_name}
                        </p>
                        <p class="text-gray-700 text-sm">
                            <i class="fas fa-user mr-1"></i>
                            Клиент: ${rec.client_name} (${rec.client_email})
                        </p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                            ${getStatusText(rec.status)}
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full ${priorityClass}">
                            ${getPriorityText(rec.priority_level)}
                        </span>
                    </div>
                </div>
                
                ${rec.description ? '<p class="text-gray-600 mb-3">' + rec.description + '</p>' : ''}
                ${rec.manager_notes ? '<p class="text-sm text-gray-500 bg-gray-50 p-2 rounded mb-3"><strong>Ваши заметки:</strong> ' + rec.manager_notes + '</p>' : ''}
                
                <div class="flex justify-between items-center text-sm text-gray-500">
                    <div>
                        <span>Отправлено: ${createdAt}</span>
                        ${viewedAt ? ' • <span class="text-green-600">Просмотрено: ' + viewedAt + '</span>' : ''}
                    </div>
                    <div class="flex gap-2">
                        ${rec.recommendation_type === 'property' ? 
                            `<a href="/object/${rec.item_id}" target="_blank" class="text-[#0088cc] hover:underline">Посмотреть объект</a>` :
                            `<a href="/complex/${rec.item_id}" target="_blank" class="text-[#0088cc] hover:underline">Посмотреть ЖК</a>`
                        }
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function getStatusClass(status) {
    const classes = {
        'sent': 'bg-gray-100 text-gray-700',
        'viewed': 'bg-gray-100 text-green-800', 
        'interested': 'bg-gray-100 text-purple-800',
        'not_interested': 'bg-gray-100 text-red-800',
        'scheduled_viewing': 'bg-gray-100 text-orange-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getPriorityClass(priority) {
    const classes = {
        'urgent': 'bg-gray-100 text-red-800',
        'high': 'bg-gray-100 text-orange-800',
        'normal': 'bg-gray-100 text-gray-800',
        'low': 'bg-gray-100 text-green-800'
    };
    return classes[priority] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'sent': 'Отправлено',
        'viewed': 'Просмотрено',
        'interested': 'Заинтересованы',
        'not_interested': 'Не заинтересованы',
        'scheduled_viewing': 'Просмотр назначен'
    };
    return texts[status] || 'Неизвестно';
}

function getPriorityText(priority) {
    const texts = {
        'urgent': 'Срочно',
        'high': 'Высокий',
        'normal': 'Обычный',
        'low': 'Низкий'
    };
    return texts[priority] || 'Обычный';
}

// Adaptive welcome message function
window.loadWelcomeMessage = function() {
    console.log('🌟 Loading adaptive welcome message...');
    fetch('/api/manager/welcome-message')
        .then(response => {
            console.log('📡 Welcome message response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Welcome message data received:', data);
            if (data.success) {
                const container = document.getElementById('welcome-messages');
                const iconContainer = document.getElementById('welcome-icon');
                
                if (!container) {
                    console.error('❌ welcome-messages container not found');
                    return;
                }
                
                // Create messages HTML
                const messagesHtml = data.messages.map((message, index) => {
                    if (index === 0) {
                        // First message is the title
                        document.getElementById('welcome-title').textContent = message;
                        return '';
                    } else {
                        // Subsequent messages
                        const className = index === 1 ? 'text-lg text-gray-600' : 'text-base text-gray-500';
                        return `<p class="${className}">${message}</p>`;
                    }
                }).filter(html => html).join('');
                
                container.innerHTML = messagesHtml;
                
                // Update icon based on activity context
                if (data.context && iconContainer) {
                    const icon = iconContainer.querySelector('svg');
                    if (data.context.high_activity) {
                        // High activity - star icon
                        icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-green-500 to-green-600');
                    } else if (data.context.needs_attention) {
                        // Needs attention - notification icon
                        icon.innerHTML = '<path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-orange-500 to-orange-600');
                    } else if (data.context.new_day) {
                        // New day - sun icon
                        icon.innerHTML = '<path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-yellow-500 to-yellow-600');
                    }
                }
                
                console.log('✅ Welcome message loaded successfully');
            } else {
                console.error('❌ API returned error:', data.error);
            }
        })
        .catch(error => {
            console.error('💥 Error loading welcome message:', error);
        });
};

window.loadRecentRecommendations = function() {
    console.log('🔄 Loading recent recommendations...');
    fetch('/api/manager/recommendations')
        .then(response => {
            console.log('📡 Recent recommendations response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Recent recommendations data received:', data);
            if (data.success) {
                const recentRecs = data.recommendations.slice(0, 3);
                const container = document.getElementById('recent-recommendations');
                
                if (!container) {
                    console.error('❌ recent-recommendations container not found');
                    return;
                }
                
                if (recentRecs.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm">Рекомендаций пока нет</div>';
                    return;
                }
                
                const html = recentRecs.map(rec => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-medium text-sm">${rec.title || rec.item_name || 'Рекомендация'}</p>
                            <p class="text-xs text-gray-500">${rec.client_name}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(rec.status)}">
                            ${getStatusText(rec.status)}
                        </span>
                    </div>
                `).join('');
                
                container.innerHTML = html;
                console.log('✅ Recent recommendations loaded successfully');
            } else {
                console.error('❌ API returned error:', data.error);
                const container = document.getElementById('recent-recommendations');
                if (container) {
                    container.innerHTML = '<div class="text-red-500 text-sm">Ошибка загрузки</div>';
                }
            }
        })
        .catch(error => {
            console.error('💥 Error loading recent recommendations:', error);
            const container = document.getElementById('recent-recommendations');
            if (container) {
                container.innerHTML = '<div class="text-red-500 text-sm">Ошибка загрузки</div>';
            }
        });
};

// Load recommendations function
function loadRecommendations() {
    // Get filter values
    const clientFilter = document.getElementById('rec-filter-client').value;
    const statusFilter = document.getElementById('rec-filter-status').value;
    const typeFilter = document.getElementById('rec-filter-type').value;
    const priorityFilter = document.getElementById('rec-filter-priority').value;
    
    // Build query params
    const params = new URLSearchParams();
    if (clientFilter) params.append('client_id', clientFilter);
    if (statusFilter) params.append('status', statusFilter);
    if (typeFilter) params.append('type', typeFilter);
    if (priorityFilter) params.append('priority', priorityFilter);
    
    const url = '/api/manager/recommendations' + (params.toString() ? '?' + params.toString() : '');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const recommendations = data.recommendations;
                const stats = data.stats;
                
                // Update stats
                document.getElementById('recommendations-sent').textContent = stats.sent || 0;
                document.getElementById('recommendations-viewed').textContent = stats.viewed || 0;
                document.getElementById('recommendations-interested').textContent = stats.interested || 0;
                document.getElementById('recommendations-scheduled').textContent = stats.scheduled || 0;
                document.getElementById('sidebar-recommendations-count').textContent = stats.sent || 0;
                
                // Update recommendations list
                const container = document.getElementById('recommendations-container');
                if (recommendations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-paper-plane text-4xl mb-4"></i>
                            <p>Рекомендации не найдены</p>
                            <p class="text-sm mt-2">Отправьте первые рекомендации клиентам через страницу "Недвижимость"</p>
                        </div>
                    `;
                    return;
                }
                
                const html = recommendations.map(rec => {
                    const statusClass = {
                        'sent': 'bg-gray-100 text-gray-700',
                        'viewed': 'bg-gray-100 text-green-800',
                        'interested': 'bg-gray-100 text-purple-800',
                        'not_interested': 'bg-gray-100 text-gray-800',
                        'scheduled_viewing': 'bg-gray-100 text-orange-800'
                    }[rec.status] || 'bg-gray-100 text-gray-800';
                    
                    const statusText = {
                        'sent': 'Отправлено',
                        'viewed': 'Просмотрено',
                        'interested': 'Заинтересованы',
                        'not_interested': 'Не заинтересованы',
                        'scheduled_viewing': 'Просмотр назначен'
                    }[rec.status] || rec.status;
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800 mb-1">${rec.title}</h3>
                                    <p class="text-sm text-gray-600">для ${rec.client_name} (${rec.client_email})</p>
                                    <p class="text-xs text-gray-500 mt-1">${rec.item_name}</p>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                            
                            ${rec.description ? '<p class="text-sm text-gray-700 mb-3">' + rec.description + '</p>' : ''}
                            
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>Отправлено: ${new Date(rec.sent_at).toLocaleDateString('ru-RU')}</span>
                                <div class="flex items-center gap-2">
                                    ${rec.viewed_at ? '<span>Просмотрено: ' + new Date(rec.viewed_at).toLocaleDateString('ru-RU') + '</span>' : ''}
                                    <button onclick="deleteRecommendation(${rec.id}, '${rec.title}')" 
                                            class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" 
                                            title="Удалить рекомендацию">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = 
                '<div class="text-red-500 text-center py-8">Ошибка загрузки рекомендаций</div>';
        });
}

// Delete recommendation function
function deleteRecommendation(recommendationId, title) {
    if (!confirm(`Вы уверены, что хотите удалить рекомендацию "${title}"?`)) {
        return;
    }
    
    fetch(`/api/manager/recommendations/${recommendationId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Рекомендация успешно удалена');
            loadRecommendations(); // Reload the list
        } else {
            alert(data.error || 'Ошибка при удалении рекомендации');
        }
    })
    .catch(error => {
        console.error('Error deleting recommendation:', error);
        alert('Ошибка при удалении рекомендации');
    });
}

// Load clients for filter
function loadClientsForFilter() {
    fetch('/api/manager/clients-list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('rec-filter-client');
                select.innerHTML = '<option value="">Все клиенты</option>' + 
                    data.clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading clients for filter:', error));
}

// Load collections function
function loadCollections() {
    console.log('Loading collections...');
    const container = document.getElementById('collections-grid');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">Загрузка подборок...</p></div>';
    
    fetch('/api/manager/collections')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const collections = data.collections || [];
                
                if (collections.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 col-span-full">
                            <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 mb-2">У вас пока нет подборок</p>
                            <button onclick="showSection('create-collection')" class="text-[#0088cc] hover:text-[#006699] font-medium">
                                Создать первую подборку
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const html = collections.map(collection => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-gray-800">${collection.name}</h3>
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(collection.status)}">
                                ${collection.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Клиент: ${collection.client_name || 'Не указан'}</p>
                        <p class="text-sm text-gray-500 mb-3">Объектов: ${collection.properties_count || 0}</p>
                        <p class="text-xs text-gray-500">Создано: ${new Date(collection.created_at).toLocaleDateString('ru-RU')}</p>
                        <div class="mt-3 flex gap-2">
                            <button onclick="viewCollection(${collection.id})" class="text-[#0088cc] hover:text-[#006699] text-sm">
                                Просмотр
                            </button>
                            <button onclick="editCollection(${collection.id})" class="text-gray-600 hover:text-gray-800 text-sm">
                                Редактировать
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">Ошибка загрузки подборок</div>';
            }
        })
        .catch(error => {
            console.error('Error loading collections:', error);
            container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">Ошибка загрузки подборок</div>';
        });
}

// Load applications function
function loadApplications() {
    console.log('Loading applications...');
    // For now, show a message that this section is under development
    const container = document.querySelector('#applications .overflow-x-auto table tbody');
    if (!container) {
        // If table body doesn't exist, find the applications section
        const appsSection = document.getElementById('applications');
        if (appsSection) {
            const tableContainer = appsSection.querySelector('.overflow-x-auto');
            if (tableContainer) {
                tableContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500 mb-2">Заявки на кешбек</p>
                        <p class="text-sm text-gray-400">Эта функция находится в разработке</p>
                    </div>
                `;
            }
        }
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
                Загрузка заявок...
            </td>
        </tr>
    `;
    
    // For demo, show empty state after a delay
    setTimeout(() => {
        container.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-8 text-gray-500">
                    <i class="fas fa-file-alt text-2xl mb-2"></i>
                    <p>Заявки на кешбек пока отсутствуют</p>
                    <p class="text-sm mt-1">Клиенты смогут подавать заявки после покупки недвижимости</p>
                </td>
            </tr>
        `;
    }, 1000);
}

// Helper function for status classes
function getStatusClass(status) {
    const statusClasses = {
        'Черновик': 'bg-gray-100 text-gray-800',
        'Отправлена': 'bg-blue-100 text-blue-800',
        'Просмотрена': 'bg-green-100 text-green-800',
        'Архив': 'bg-red-100 text-red-800'
    };
    return statusClasses[status] || 'bg-gray-100 text-gray-800';
}

// Collection management functions
function viewCollection(collectionId) {
    // Redirect to collection view page
    window.location.href = `/manager/collection/${collectionId}`;
}

function editCollection(collectionId) {
    // For now, redirect to collection view
    viewCollection(collectionId);
}

// Ensure functions are available globally before initialization
window.showAddClientModal = function() {
    console.log('showAddClientModal called');
    const modal = document.getElementById('client-modal');
    if (modal) {
        modal.classList.remove('hidden');
    } else {
        console.error('Client modal not found');
    }
};

// Removed fallback functions - using main functions above

// Initialize on page load  
document.addEventListener('DOMContentLoaded', function() {
    console.log('Manager dashboard DOMContentLoaded - initializing...');
    
    // Check URL for presentation_id parameter
    const urlParams = new URLSearchParams(window.location.search);
    const hash = window.location.hash.substring(1); // Remove # from hash
    const presentationId = urlParams.get('presentation_id');
    
    // Setup initial view - check if we need to show presentations
    if (hash === 'presentations' && presentationId) {
        console.log('🎯 Auto-opening presentation:', presentationId);
        showSection('presentations');
        
        // Store the presentation ID for later use
        window.autoOpenPresentationId = presentationId;
    } else if (hash && hash.includes('presentations')) {
        console.log('🎯 Auto-opening presentations section');
        showSection('presentations');
    } else {
        showSection('dashboard');
    }
    
    // Load data with delay to ensure DOM is ready
    setTimeout(() => {
        console.log('Starting data load...');
        if (typeof window.loadClients === 'function') {
            window.loadClients();
        } else {
            console.error('loadClients function not available');
        }
        
        if (typeof window.loadRecommendations === 'function') {
            window.loadRecommendations();
        } else {
            console.error('loadRecommendations function not available');
        }
        
        // Load recent recommendations for main dashboard
        if (typeof window.loadRecentRecommendations === 'function') {
            window.loadRecentRecommendations();
        } else {
            console.error('loadRecentRecommendations function not available');
        }
        
        // Load adaptive welcome message
        if (typeof window.loadWelcomeMessage === 'function') {
            window.loadWelcomeMessage();
        } else {
            console.error('loadWelcomeMessage function not available');
        }
        
        if (typeof loadClientsForFilter === 'function') {
            loadClientsForFilter();
        }
    }, 500);
});

// Removed duplicate - now defined at top

// Presentation functions
function createPresentation() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Создать презентацию</h3>
            <form id="presentation-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Название презентации</label>
                    <input type="text" id="presentation-title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Например: Подборка для семьи Ивановых" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Имя клиента</label>
                    <input type="text" id="client-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Иван Петров">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Телефон клиента</label>
                    <input type="tel" id="client-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="+7 900 123 45 67">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                    <textarea id="presentation-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" rows="3" placeholder="Краткое описание презентации"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all">Создать</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('presentation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('presentation-title').value;
        const clientName = document.getElementById('client-name').value;
        const clientPhone = document.getElementById('client-phone').value;
        const description = document.getElementById('presentation-description').value;
        
        try {
            const response = await fetch('/api/manager/presentation/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    client_name: clientName,
                    client_phone: clientPhone,
                    description: description
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                loadPresentations();
                showNotification('Презентация создана успешно!', 'success');
            } else {
                showNotification('Ошибка: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('Ошибка при создании презентации', 'error');
        }
    });
}

function closeModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

// Show create presentation modal
function showCreatePresentationModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Создать презентацию</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="create-presentation-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Название презентации</label>
                    <input type="text" id="presentation-title" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="Например: Лучшие предложения для Иванова">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Для клиента (необязательно)</label>
                    <input type="text" id="presentation-client" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="Имя клиента">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                    <textarea id="presentation-description-modal" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="Краткое описание презентации"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Отмена
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg transition-colors">
                        Создать
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Handle form submission
    document.getElementById('create-presentation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('presentation-title').value.trim();
        const client = document.getElementById('presentation-client').value.trim();
        const description = document.getElementById('presentation-description').value.trim();
        
        if (!title) {
            alert('Введите название презентации');
            return;
        }
        
        try {
            const response = await fetch('/api/manager/presentation/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    title: title,
                    client_name: client || null,
                    description: description || null
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                showNotification('Презентация создана успешно!', 'success');
                loadPresentations(); // Refresh the list
            } else {
                showNotification(`Ошибка: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error creating presentation:', error);
            showNotification('Ошибка при создании презентации', 'error');
        }
    });
}

function closeCreatePresentationModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

function loadPresentations() {
    fetch('/api/manager/presentations', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('Response status:', response.status);
            return response.text();
        })
        .then(text => {
            console.log('Raw response:', text);
            // Извлекаем JSON из ответа, игнорируя HTML редирект
            const jsonStart = text.indexOf('{');
            if (jsonStart !== -1) {
                const jsonText = text.substring(jsonStart);
                const data = JSON.parse(jsonText);
                if (data.success) {
                    displayPresentations(data.presentations);
                } else {
                    console.error('Error loading presentations:', data.error);
                }
            } else {
                console.error('No JSON found in response:', text);
            }
        })
        .catch(error => {
            console.error('Error loading presentations:', error);
        });
}

function displayPresentations(presentations) {
    const section = document.querySelector('#presentations.content-section');
    const container = section && section.querySelector('#presentations-container');
    
    if (!container) {
        console.error('Container #presentations-container not found inside #presentations section');
        return;
    }
    
    // Count total properties across all presentations
    let totalProperties = 0;
    presentations.forEach(presentation => {
        if (presentation.properties && presentation.properties.length > 0) {
            totalProperties += presentation.properties.length;
        }
    });
    
    if (presentations.length === 0) {
        // Clear container safely
        container.textContent = '';
        
        // Create empty state
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'text-center py-12 col-span-full';
        
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('class', 'mx-auto h-12 w-12 text-gray-400');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('stroke', 'currentColor');
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z');
        svg.appendChild(path);
        
        const title = document.createElement('h3');
        title.className = 'mt-2 text-sm font-medium text-gray-900';
        title.textContent = 'Нет презентаций';
        
        const subtitle = document.createElement('p');
        subtitle.className = 'mt-1 text-sm text-gray-500';
        subtitle.textContent = 'Создайте первую презентацию для клиентов';
        
        emptyDiv.appendChild(svg);
        emptyDiv.appendChild(title);
        emptyDiv.appendChild(subtitle);
        
        container.appendChild(emptyDiv);
        return;
    }
    
    // Clear container
    container.textContent = '';
    
    // Create compact header - Dashboard style
    const header = document.createElement('div');
    header.className = 'flex justify-between items-center mb-6';
    
    const headerLeft = document.createElement('div');
    
    const headerTitle = document.createElement('h2');
    headerTitle.className = 'text-2xl font-bold text-gray-900';
    headerTitle.textContent = 'Презентации';
    
    const headerSubtitle = document.createElement('p');
    headerSubtitle.className = 'text-sm text-gray-500 mt-1';
    headerSubtitle.textContent = `${presentations.length} презентаций • ${totalProperties} объектов`;
    
    headerLeft.appendChild(headerTitle);
    headerLeft.appendChild(headerSubtitle);
    
    // Create presentation button
    const createButton = document.createElement('button');
    createButton.className = 'bg-gradient-to-br from-[#0088CC] to-[#006699] text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-300 font-medium';
    createButton.textContent = 'Создать презентацию';
    createButton.onclick = () => showSection('create-collection');
    
    header.appendChild(headerLeft);
    header.appendChild(createButton);
    container.appendChild(header);
    
    // Create presentations grid - Beautiful dashboard style
    const presentationsGrid = document.createElement('div');
    presentationsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    presentationsGrid.id = 'presentationsGrid';
    
    // Display presentation cards
    presentations.forEach(presentation => {
        const presentationCard = createPresentationCard(presentation);
        if (presentationCard) {
            presentationsGrid.appendChild(presentationCard);
        }
    });
    
    container.appendChild(presentationsGrid);
    
    // Check if we need to auto-open a specific presentation
    if (window.autoOpenPresentationId) {
        const presentationId = window.autoOpenPresentationId;
        console.log('🎯 Auto-opening presentation with ID:', presentationId);
        
        const targetPresentation = presentations.find(p => p.id == presentationId);
        if (targetPresentation) {
            console.log('✅ Found target presentation, redirecting to view');
            window.autoOpenPresentationId = null;
            
            setTimeout(() => {
                window.location.href = `/manager/presentation/${presentationId}`;
            }, 500);
        } else {
            console.log('❌ Target presentation not found in loaded data');
            window.autoOpenPresentationId = null;
        }
    }
}

function createPresentationCard(presentation) {
    // 🎯 КВАДРАТНАЯ КАРТОЧКА В СТИЛЕ ДАШБОРДА
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden group cursor-pointer';
    
    // Главный контейнер с квадратным соотношением
    const mainContainer = document.createElement('div');
    mainContainer.className = 'aspect-square flex flex-col';
    
    // Верхняя часть с градиентом и иконкой (60% высоты)
    const topSection = document.createElement('div');
    topSection.className = 'flex-[3] bg-gradient-to-br from-[#0088CC] to-[#006699] p-6 flex flex-col justify-between relative overflow-hidden';
    
    // Декоративные элементы
    const decorativeCircle = document.createElement('div');
    decorativeCircle.className = 'absolute -top-6 -right-6 w-24 h-24 bg-white bg-opacity-10 rounded-full';
    
    const decorativeCircle2 = document.createElement('div');
    decorativeCircle2.className = 'absolute -bottom-4 -left-4 w-16 h-16 bg-white bg-opacity-5 rounded-full';
    
    topSection.appendChild(decorativeCircle);
    topSection.appendChild(decorativeCircle2);
    
    // Иконка презентации
    const iconContainer = document.createElement('div');
    iconContainer.className = 'w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mb-4';
    iconContainer.innerHTML = `
        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 2h6v4H7V5zm8 8v2h1v-2h-1zm-2-2H7v4h6v-4z" clip-rule="evenodd"/>
        </svg>
    `;
    
    // Название и клиент
    const titleText = document.createElement('h3');
    titleText.className = 'text-white font-bold text-lg mb-2 line-clamp-2';
    titleText.textContent = presentation.title || 'Презентация';
    
    const clientText = document.createElement('p');
    clientText.className = 'text-white text-opacity-90 text-sm';
    clientText.textContent = presentation.client_name ? `Для: ${presentation.client_name}` : 'Без клиента';
    
    topSection.appendChild(iconContainer);
    topSection.appendChild(titleText);
    topSection.appendChild(clientText);
    
    // Нижняя часть с информацией (40% высоты)
    const bottomSection = document.createElement('div');
    bottomSection.className = 'flex-[2] p-4 flex flex-col justify-between bg-white';
    
    // Статистика и дата
    const infoSection = document.createElement('div');
    
    const statsRow = document.createElement('div');
    statsRow.className = 'flex items-center justify-between mb-3';
    
    const objectsCount = document.createElement('div');
    objectsCount.className = 'flex items-center text-sm text-gray-600';
    const objectsIcon = document.createElement('div');
    objectsIcon.className = 'w-4 h-4 bg-blue-100 rounded mr-2 flex items-center justify-center';
    objectsIcon.innerHTML = '<svg class="w-2.5 h-2.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>';
    const objectsText = document.createElement('span');
    objectsText.textContent = `${presentation.properties ? presentation.properties.length : 0} объектов`;
    objectsCount.appendChild(objectsIcon);
    objectsCount.appendChild(objectsText);
    
    const dateInfo = document.createElement('div');
    dateInfo.className = 'text-xs text-gray-400';
    const createdDate = new Date(presentation.created_at);
    dateInfo.textContent = createdDate.toLocaleDateString('ru-RU');
    
    statsRow.appendChild(objectsCount);
    statsRow.appendChild(dateInfo);
    
    infoSection.appendChild(statsRow);
    
    // Кнопки действий
    const actionsRow = document.createElement('div');
    actionsRow.className = 'flex items-center gap-2';
    
    // Главная кнопка - Смотреть
    const viewButton = document.createElement('button');
    viewButton.className = 'flex-1 bg-[#0088CC] hover:bg-[#006699] text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:scale-105';
    viewButton.textContent = 'Смотреть';
    viewButton.onclick = () => showPresentationObjects(presentation);
    
    // Кнопка меню
    const menuButton = document.createElement('button');
    menuButton.className = 'p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors';
    menuButton.innerHTML = `
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
        </svg>
    `;
    menuButton.onclick = (e) => {
        e.stopPropagation();
        showPresentationMenu(presentation, e.target);
    };
    
    actionsRow.appendChild(viewButton);
    actionsRow.appendChild(menuButton);
    
    bottomSection.appendChild(infoSection);
    bottomSection.appendChild(actionsRow);
    
    // Собираем карточку
    mainContainer.appendChild(topSection);
    mainContainer.appendChild(bottomSection);
    card.appendChild(mainContainer);
    
    // Обработчик клика по всей карточке
    card.onclick = () => showPresentationObjects(presentation);
    
    return card;
}

// Функция меню для презентаций
function showPresentationMenu(presentation, buttonElement) {
    // Удаляем существующие меню
    document.querySelectorAll('.presentation-menu').forEach(menu => menu.remove());
    
    const menu = document.createElement('div');
    menu.className = 'presentation-menu absolute z-50 bg-white rounded-lg shadow-lg border border-gray-200 py-2 min-w-[160px]';
    
    // Позиционируем меню относительно кнопки
    const rect = buttonElement.getBoundingClientRect();
    menu.style.top = `${rect.bottom + 8}px`;
    menu.style.right = `${window.innerWidth - rect.right}px`;
    
    const menuItems = [
        {
            icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/></svg>',
            text: 'Отправить на почту',
            action: () => sendPresentationToEmail(presentation.id),
            color: 'text-green-600 hover:bg-green-50'
        },
        {
            icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>',
            text: 'Скачать PDF',
            action: () => downloadPresentationAll(presentation.id),
            color: 'text-purple-600 hover:bg-purple-50'
        },
        {
            icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg>',
            text: 'Поделиться ссылкой',
            action: () => sharePresentationLink(presentation.id),
            color: 'text-blue-600 hover:bg-blue-50'
        },
        {
            icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
            text: 'Удалить',
            action: () => deletePresentationConfirm(presentation.id),
            color: 'text-red-600 hover:bg-red-50'
        }
    ];
    
    menuItems.forEach(item => {
        const menuItem = document.createElement('button');
        menuItem.className = `w-full flex items-center px-4 py-2 text-sm ${item.color} hover:text-current transition-colors`;
        menuItem.innerHTML = `${item.icon}<span class="ml-3">${item.text}</span>`;
        menuItem.onclick = () => {
            item.action();
            menu.remove();
        };
        menu.appendChild(menuItem);
    });
    
    document.body.appendChild(menu);
    
    // Закрытие меню при клике вне
    document.addEventListener('click', function closeMenu(e) {
        if (!menu.contains(e.target) && e.target !== buttonElement) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        }
    });
}

// Функция для показа объектов презентации в том же дашборде
function showPresentationObjects(presentation) {
    console.log('🎯 Showing presentation objects:', presentation);
    
    const container = document.getElementById('presentations-container');
    if (!container) return;
    
    // Очищаем контейнер
    container.innerHTML = '';
    
    // ПОЛНОШИРИННЫЙ HEADER СВЕРХУ (как требует пользователь)
    const headerSection = document.createElement('div');
    headerSection.className = 'w-full mb-8';
    
    // Navigation row с кнопкой назад и actions
    const navigationRow = document.createElement('div');
    navigationRow.className = 'flex items-center justify-between mb-6';
    
    // Кнопка "Назад"
    const backButton = document.createElement('button');
    backButton.className = 'flex items-center text-blue-600 hover:text-blue-700 font-medium transition-colors';
    backButton.innerHTML = `
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
        </svg>
        Назад к презентациям
    `;
    backButton.onclick = () => loadPresentations();
    
    // Presentation Action Buttons (from /manager/presentation/4)
    const actionButtons = document.createElement('div');
    actionButtons.className = 'flex items-center space-x-3';
    
    // Generate Link Button
    const linkButton = document.createElement('button');
    linkButton.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center text-sm font-medium transition-colors';
    linkButton.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
        </svg>
        Ссылка
    `;
    linkButton.onclick = () => generatePresentationLink(presentation.id);
    
    // Share Button  
    const shareBtn2 = document.createElement('button');
    shareBtn2.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center text-sm font-medium transition-colors';
    shareBtn2.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
        </svg>
        Поделиться
    `;
    shareBtn2.onclick = () => sharePresentation(presentation.id);
    
    // Print Button
    const printButton = document.createElement('button');
    printButton.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center text-sm font-medium transition-colors';
    printButton.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"/>
        </svg>
        Печать
    `;
    printButton.onclick = () => printPresentation(presentation.id);
    
    // PDF Download Button
    const pdfButton = document.createElement('button');
    pdfButton.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center text-sm font-medium transition-colors';
    pdfButton.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
        PDF
    `;
    pdfButton.onclick = () => downloadPresentationPDF(presentation.id);
    
    actionButtons.appendChild(linkButton);
    actionButtons.appendChild(shareBtn2);
    actionButtons.appendChild(printButton);
    actionButtons.appendChild(pdfButton);
    
    navigationRow.appendChild(backButton);
    navigationRow.appendChild(actionButtons);
    
    // Title and presentation info row - ПОЛНАЯ ШИРИНА
    const titleRow = document.createElement('div');
    titleRow.className = 'w-full bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-6 mb-6';
    
    const titleContent = document.createElement('div');
    titleContent.className = 'flex items-center justify-between';
    
    const leftInfo = document.createElement('div');
    leftInfo.className = 'flex-1';
    
    const title = document.createElement('h1');
    title.className = 'text-3xl font-bold text-gray-900 mb-2';
    title.textContent = presentation.title || `Презентация для ${presentation.client_name}`;
    
    const subtitle = document.createElement('p');
    subtitle.className = 'text-lg text-gray-600 mb-3';
    subtitle.textContent = `${presentation.properties?.length || 0} объектов`;
    
    leftInfo.appendChild(title);
    leftInfo.appendChild(subtitle);
    
    // Client info в строку (не блоком)
    if (presentation.client_name) {
        const clientRow = document.createElement('div');
        clientRow.className = 'flex items-center space-x-6 text-sm text-blue-700';
        
        const clientInfo = document.createElement('div');
        clientInfo.className = 'flex items-center';
        clientInfo.innerHTML = `
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
            </svg>
            <strong>Клиент:</strong> ${presentation.client_name}
        `;
        
        clientRow.appendChild(clientInfo);
        
        if (presentation.client_phone) {
            const phoneInfo = document.createElement('div');
            phoneInfo.textContent = `📞 ${presentation.client_phone}`;
            clientRow.appendChild(phoneInfo);
        }
        
        if (presentation.description) {
            const descInfo = document.createElement('div');
            descInfo.textContent = `📝 ${presentation.description}`;
            clientRow.appendChild(descInfo);
        }
        
        leftInfo.appendChild(clientRow);
    }
    
    titleContent.appendChild(leftInfo);
    titleRow.appendChild(titleContent);
    
    headerSection.appendChild(navigationRow);
    headerSection.appendChild(titleRow);
    container.appendChild(headerSection);
    
    // КНОПКИ ДЕЙСТВИЙ КАК НА ОРИГИНАЛЬНОЙ СТРАНИЦЕ
    const actionsSection = document.createElement('div');
    actionsSection.className = 'bg-gradient-to-r from-gray-50 to-blue-50 border border-gray-200 rounded-xl p-6 mb-8 mx-6';
    
    const actionsRow = document.createElement('div');
    actionsRow.className = 'flex flex-wrap items-center justify-between gap-4';
    
    // Левая группа - основные действия
    const leftActions = document.createElement('div');
    leftActions.className = 'flex flex-wrap items-center gap-3';
    
    // Кнопка "На почту"
    const emailButton = document.createElement('button');
    emailButton.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition-all hover:scale-105 hover:shadow-lg';
    emailButton.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
        </svg>
        На почту
    `;
    emailButton.onclick = () => sendToEmail(presentation.id);
    
    // Кнопка "Скачать все"
    const downloadAllButton = document.createElement('button');
    downloadAllButton.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-all hover:scale-105 hover:shadow-lg';
    downloadAllButton.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
        Скачать все
    `;
    downloadAllButton.onclick = () => downloadAll(presentation.id);
    
    // Кнопка "Ссылка"
    const linkBtn2 = document.createElement('button');
    linkBtn2.className = 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center transition-all hover:scale-105 hover:shadow-lg';
    linkBtn2.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
        </svg>
        Ссылка
    `;
    linkBtn2.onclick = () => sharePresentation(presentation.id);
    
    leftActions.appendChild(emailButton);
    leftActions.appendChild(downloadAllButton);
    leftActions.appendChild(linkBtn2);
    
    // Правая группа - управление
    const rightActions = document.createElement('div');
    rightActions.className = 'flex items-center gap-3';
    
    // Кнопка "Очистить всё"
    const clearButton = document.createElement('button');
    clearButton.className = 'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center transition-all hover:scale-105 hover:shadow-lg';
    clearButton.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        Очистить всё
    `;
    clearButton.onclick = () => clearAll(presentation.id);
    
    // Кнопка "Добавить объект"
    const addButton = document.createElement('button');
    addButton.className = 'bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg flex items-center transition-all hover:scale-105 hover:shadow-lg';
    addButton.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
        </svg>
        Добавить объект
    `;
    addButton.onclick = () => addProperty(presentation.id);
    
    rightActions.appendChild(clearButton);
    rightActions.appendChild(addButton);
    
    actionsRow.appendChild(leftActions);
    actionsRow.appendChild(rightActions);
    actionsSection.appendChild(actionsRow);
    container.appendChild(actionsSection);
    
    // ОБЪЕКТЫ С ПРОФЕССИОНАЛЬНЫМ ДИЗАЙНОМ
    if (presentation.properties && presentation.properties.length > 0) {
        // Заголовок секции
        const sectionTitle = document.createElement('div');
        sectionTitle.className = 'px-6 mb-6';
        sectionTitle.innerHTML = `
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Объекты недвижимости</h2>
            <p class="text-gray-600">Подобранные варианты для клиента</p>
        `;
        container.appendChild(sectionTitle);
        
        // Адаптивная сетка объектов (КАК НА ОРИГИНАЛЬНОЙ СТРАНИЦЕ)
        const objectsGrid = document.createElement('div');
        objectsGrid.className = 'px-6 grid grid-cols-1 xl:grid-cols-2 gap-8 pb-8';
        
        presentation.properties.forEach((property, index) => {
            const propertyCard = createOriginalStylePropertyCard(property, index + 1, presentation.id);
            objectsGrid.appendChild(propertyCard);
        });
        
        container.appendChild(objectsGrid);
    } else {
        // Пустое состояние
        const emptyState = document.createElement('div');
        emptyState.className = 'text-center py-16 px-6';
        emptyState.innerHTML = `
            <div class="max-w-md mx-auto">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-12 h-12 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Нет объектов</h3>
                <p class="text-gray-600">В этой презентации пока нет добавленных объектов недвижимости.</p>
            </div>
        `;
        container.appendChild(emptyState);
    }
}

function createDetailedPropertyCard(property, orderNumber) {
    // 🎯 СУПЕР КОМПАКТНАЯ карточка для dashboard
    const card = document.createElement('div');
    card.className = 'bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-all duration-200 h-80 flex flex-col';
    
    // 📷 Мини-изображение
    const imageSection = document.createElement('div');
    imageSection.className = 'relative h-32 bg-gray-100';
    
    const hasImage = property.layout_image || property.main_image;
    
    if (hasImage) {
        const image = document.createElement('img');
        image.src = property.layout_image || property.main_image;
        image.alt = `Объект ${property.property_id || property.id}`;
        image.className = 'w-full h-full object-cover';
        imageSection.appendChild(image);
    } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'w-full h-full flex items-center justify-center text-gray-400';
        placeholder.innerHTML = `
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
            </svg>
        `;
        imageSection.appendChild(placeholder);
    }
    
    // 🏷️ Компактные мини-badges
    const orderBadge = document.createElement('div');
    orderBadge.className = 'absolute top-1 left-1 bg-blue-600 text-white text-xs px-1.5 py-0.5 rounded';
    orderBadge.textContent = `#${orderNumber}`;
    imageSection.appendChild(orderBadge);
    
    const priceBadge = document.createElement('div');
    priceBadge.className = 'absolute top-1 right-1 bg-green-600 text-white text-xs px-1.5 py-0.5 rounded';
    priceBadge.textContent = `${property.price ? (property.price / 1000000).toFixed(1) + ' млн' : 'Цена?'}`;
    imageSection.appendChild(priceBadge);
    
    // 📝 Содержимое - МИНИМУМ текста
    const content = document.createElement('div');
    content.className = 'p-3 flex-1 flex flex-col';
    
    // Тип и площадь - ОДНОЙ строкой
    const header = document.createElement('div');
    header.className = 'font-semibold text-gray-900 text-sm mb-1 truncate';
    header.textContent = property.rooms == 0 ? `Студия, ${property.area} м²` : `${property.rooms}-к, ${property.area} м²`;
    
    // Цена - крупно
    const price = document.createElement('div');
    price.className = 'font-bold text-blue-600 text-lg mb-1';
    price.textContent = `${(property.price / 1000000).toFixed(1)} млн ₽`;
    
    // ЖК - одной строкой
    const complex = document.createElement('div');
    complex.className = 'text-sm text-gray-600 mb-1 truncate';
    complex.textContent = property.complex_name || 'ЖК не указан';
    
    // Мини-детали в одну строку
    const details = document.createElement('div');
    details.className = 'text-xs text-gray-500 flex justify-between mb-2';
    details.innerHTML = `
        <span>${property.floor}/${property.total_floors} эт.</span>
        <span>${(property.price_per_sqm / 1000).toFixed(0)} тыс/м²</span>
    `;
    
    // 🔘 Одна компактная кнопка
    const actionButton = document.createElement('button');
    actionButton.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-medium transition-colors mt-auto';
    actionButton.textContent = 'Подробнее';
    actionButton.onclick = () => {
        window.open(`/property/${property.property_id}`, '_blank');
    };
    
    // Собираем карточку
    content.appendChild(header);
    content.appendChild(price);
    content.appendChild(complex);
    content.appendChild(details);
    content.appendChild(actionButton);
    
    card.appendChild(imageSection);
    card.appendChild(content);
    
    return card;
}

// ============== КАРТОЧКИ ОБЪЕКТОВ В СТИЛЕ ОРИГИНАЛЬНОЙ СТРАНИЦЫ ===============

function createOriginalStylePropertyCard(property, orderNumber, presentationId) {
    // 🏡 ПОЛНАЯ карточка недвижимости КАК НА /manager/presentation/4
    const card = document.createElement('div');
    card.className = 'bg-white border border-gray-200 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden group property-card';
    card.setAttribute('data-property-id', property.property_id || property.id);
    
    // ================== ГАЛЕРЕЯ ИЗОБРАЖЕНИЙ С SWIPER ==================
    const imageContainer = document.createElement('div');
    imageContainer.className = 'relative h-80 bg-gradient-to-br from-gray-100 to-gray-200';
    
    // Собираем все изображения
    const allImages = [];
    if (property.images && property.images.length > 0) {
        allImages.push(...property.images);
    }
    if (property.layout_image) {
        allImages.push(property.layout_image);
    }
    if (property.main_image && !allImages.includes(property.main_image)) {
        allImages.push(property.main_image);
    }
    
    if (allImages.length > 1) {
        // Swiper галерея
        const galleryId = `gallery-${property.property_id || property.id}`;
        const swiperContainer = document.createElement('div');
        swiperContainer.className = 'swiper property-gallery h-full';
        swiperContainer.id = galleryId;
        
        const swiperWrapper = document.createElement('div');
        swiperWrapper.className = 'swiper-wrapper';
        
        allImages.forEach((image, index) => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            slide.innerHTML = `<img src="${image}" alt="Объект ${property.property_id || property.id}" class="w-full h-full object-cover">`;
            swiperWrapper.appendChild(slide);
        });
        
        const prevButton = document.createElement('div');
        prevButton.className = 'swiper-button-prev';
        
        const nextButton = document.createElement('div');
        nextButton.className = 'swiper-button-next';
        
        const pagination = document.createElement('div');
        pagination.className = 'swiper-pagination';
        
        swiperContainer.appendChild(swiperWrapper);
        swiperContainer.appendChild(prevButton);
        swiperContainer.appendChild(nextButton);
        swiperContainer.appendChild(pagination);
        
        imageContainer.appendChild(swiperContainer);
        
        // Инициализация Swiper после добавления в DOM
        setTimeout(() => {
            if (window.Swiper) {
                new Swiper(`#${galleryId}`, {
                    loop: true,
                    autoplay: {
                        delay: 4000,
                        disableOnInteraction: false,
                        pauseOnMouseEnter: true
                    },
                    speed: 600,
                    effect: 'fade',
                    fadeEffect: {
                        crossFade: true
                    },
                    navigation: {
                        nextEl: `#${galleryId} .swiper-button-next`,
                        prevEl: `#${galleryId} .swiper-button-prev`,
                    },
                    pagination: {
                        el: `#${galleryId} .swiper-pagination`,
                        clickable: true,
                        dynamicBullets: true,
                    }
                });
            }
        }, 100);
        
    } else if (allImages.length === 1) {
        // Одно изображение
        const image = document.createElement('img');
        image.src = allImages[0];
        image.alt = `Объект ${property.property_id || property.id}`;
        image.className = 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-500';
        imageContainer.appendChild(image);
    } else {
        // Плейсхолдер
        const placeholder = document.createElement('div');
        placeholder.className = 'w-full h-full flex flex-col items-center justify-center text-gray-400 bg-gradient-to-br from-gray-50 to-gray-100';
        placeholder.innerHTML = `
            <svg class="w-20 h-20 mb-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
            </svg>
            <p class="text-sm font-medium">Фото отсутствует</p>
        `;
        imageContainer.appendChild(placeholder);
    }
    
    // Цена (правый верхний угол)
    const priceBadge = document.createElement('div');
    priceBadge.className = 'absolute top-4 right-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2 rounded-lg shadow-lg font-bold text-lg';
    priceBadge.textContent = `${property.price ? (property.price / 1000000).toFixed(1) + ' млн ₽' : 'Цена не указана'}`;
    imageContainer.appendChild(priceBadge);
    
    // Тип недвижимости (левый верхний угол)
    const typeBadge = document.createElement('div');
    typeBadge.className = 'absolute top-4 left-4 bg-white bg-opacity-90 text-gray-800 px-3 py-1 rounded-full text-sm font-semibold backdrop-blur-sm';
    typeBadge.innerHTML = `
        ${property.rooms === 0 ? '🏠 Студия' : '🏠 ' + property.rooms + '-комн'}
    `;
    imageContainer.appendChild(typeBadge);
    
    // Кэшбек (если есть)
    if (property.cashback && property.cashback > 0) {
        const cashbackBadge = document.createElement('div');
        cashbackBadge.className = 'absolute bottom-4 left-4 bg-green-500 text-white px-3 py-1 rounded-lg shadow-lg text-sm font-semibold';
        cashbackBadge.innerHTML = `
            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
            </svg>
            Кэшбек ${(property.cashback / 1000).toFixed(0)}к ₽
        `;
        imageContainer.appendChild(cashbackBadge);
    }
    
    // Overlay с быстрыми действиями
    const overlay = document.createElement('div');
    overlay.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100';
    
    const quickActions = document.createElement('div');
    quickActions.className = 'flex space-x-3';
    
    // Кнопка просмотра
    const viewButton = document.createElement('button');
    viewButton.className = 'bg-white text-gray-800 p-3 rounded-full hover:bg-blue-50 transition-colors shadow-lg';
    viewButton.innerHTML = `
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
        </svg>
    `;
    viewButton.onclick = () => viewFullPropertyManager(presentationId, property.property_id || property.id);
    
    // Кнопка PDF
    const pdfButton = document.createElement('button');
    pdfButton.className = 'bg-white text-gray-800 p-3 rounded-full hover:bg-red-50 transition-colors shadow-lg';
    pdfButton.innerHTML = `
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
    `;
    pdfButton.onclick = () => downloadPropertyPDF(presentationId, property.property_id || property.id);
    
    // Кнопка удаления
    const deleteButton = document.createElement('button');
    deleteButton.className = 'bg-white text-gray-800 p-3 rounded-full hover:bg-red-50 transition-colors shadow-lg';
    deleteButton.innerHTML = `
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
    `;
    deleteButton.onclick = () => removePropertyFromPresentation(presentationId, property.property_id || property.id);
    
    quickActions.appendChild(viewButton);
    quickActions.appendChild(pdfButton);
    quickActions.appendChild(deleteButton);
    overlay.appendChild(quickActions);
    imageContainer.appendChild(overlay);
    
    // ================== СОДЕРЖИМОЕ КАРТОЧКИ ==================
    const contentContainer = document.createElement('div');
    contentContainer.className = 'p-6';
    
    // Заголовок
    const title = document.createElement('h3');
    title.className = 'text-xl font-bold text-gray-900 mb-3';
    title.textContent = property.title || (property.rooms === 0 ? `Студия, ${property.area} м²` : `${property.rooms}-комнатная квартира, ${property.area} м²`);
    
    // ЖК
    const complex = document.createElement('div');
    complex.className = 'text-blue-600 font-semibold mb-4 text-lg';
    complex.textContent = property.complex_name || 'ЖК не указан';
    
    // Детали в сетке
    const detailsGrid = document.createElement('div');
    detailsGrid.className = 'grid grid-cols-2 gap-4 mb-4 text-sm';
    
    detailsGrid.innerHTML = `
        <div class="flex items-center">
            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
            <span class="text-gray-600">Площадь:</span>
            <span class="font-semibold ml-1">${property.area} м²</span>
        </div>
        <div class="flex items-center">
            <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
            <span class="text-gray-600">Этаж:</span>
            <span class="font-semibold ml-1">${property.floor}/${property.total_floors}</span>
        </div>
        <div class="flex items-center">
            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
            <span class="text-gray-600">Цена/м²:</span>
            <span class="font-semibold ml-1">${(property.price_per_sqm / 1000).toFixed(0)} тыс ₽</span>
        </div>
        <div class="flex items-center">
            <span class="w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
            <span class="text-gray-600">Статус:</span>
            <span class="font-semibold ml-1 text-green-600">Доступен</span>
        </div>
    `;
    
    // Адрес
    const address = document.createElement('div');
    address.className = 'bg-gray-50 rounded-lg p-3 mb-4';
    address.innerHTML = `
        <div class="flex items-start">
            <svg class="w-4 h-4 text-gray-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-gray-700 text-sm">${property.address || 'Адрес не указан'}</span>
        </div>
    `;
    
    // Кнопки действий
    const actionsContainer = document.createElement('div');
    actionsContainer.className = 'flex gap-2';
    
    // Основная кнопка просмотра
    const mainViewButton = document.createElement('button');
    mainViewButton.className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all hover:scale-105';
    mainViewButton.innerHTML = `
        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
        </svg>
        Просмотр
    `;
    mainViewButton.onclick = () => viewFullPropertyManager(presentationId, property.property_id || property.id);
    
    // Кнопка PDF
    const mainPdfButton = document.createElement('button');
    mainPdfButton.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all hover:scale-105';
    mainPdfButton.innerHTML = `
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
    `;
    mainPdfButton.onclick = () => downloadPropertyPDF(presentationId, property.property_id || property.id);
    
    // Кнопка комментария
    const commentButton = document.createElement('button');
    commentButton.className = 'bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-all hover:scale-105';
    commentButton.innerHTML = `
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
        </svg>
    `;
    commentButton.onclick = () => addComment(presentationId, property.property_id || property.id);
    
    // Кнопка удаления
    const mainDeleteButton = document.createElement('button');
    mainDeleteButton.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-all hover:scale-105';
    mainDeleteButton.innerHTML = `
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
    `;
    mainDeleteButton.onclick = () => removePropertyFromPresentation(presentationId, property.property_id || property.id);
    
    actionsContainer.appendChild(mainViewButton);
    actionsContainer.appendChild(mainPdfButton);
    actionsContainer.appendChild(commentButton);
    actionsContainer.appendChild(mainDeleteButton);
    
    // Сборка карточки
    contentContainer.appendChild(title);
    contentContainer.appendChild(complex);
    contentContainer.appendChild(detailsGrid);
    contentContainer.appendChild(address);
    contentContainer.appendChild(actionsContainer);
    
    card.appendChild(imageContainer);
    card.appendChild(contentContainer);
    
    return card;
}

// ============== ПРОФЕССИОНАЛЬНЫЕ КАРТОЧКИ ОБЪЕКТОВ ===============

function createProfessionalPropertyCard(property, orderNumber) {
    // 🏢 ПОЛНОЦЕННАЯ карточка недвижимости в стиле dashboard
    const card = document.createElement('div');
    card.className = 'bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden group';
    
    // ================== ИЗОБРАЖЕНИЕ И БЕЙДЖИ ==================
    const imageContainer = document.createElement('div');
    imageContainer.className = 'relative h-64 bg-gradient-to-br from-gray-100 to-gray-200';
    
    const hasImage = property.layout_image || property.main_image;
    
    if (hasImage) {
        const image = document.createElement('img');
        image.src = property.layout_image || property.main_image;
        image.alt = `Объект ${property.property_id || property.id}`;
        image.className = 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-300';
        imageContainer.appendChild(image);
    } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'w-full h-full flex flex-col items-center justify-center text-gray-400';
        placeholder.innerHTML = `
            <svg class="w-16 h-16 mb-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
            </svg>
            <p class="text-sm font-medium">Фото отсутствует</p>
        `;
        imageContainer.appendChild(placeholder);
    }
    
    // Градиентный оверлей
    const overlay = document.createElement('div');
    overlay.className = 'absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300';
    imageContainer.appendChild(overlay);
    
    // Номер объекта (левый верхний угол)
    const orderBadge = document.createElement('div');
    orderBadge.className = 'absolute top-4 left-4 bg-blue-600 text-white text-sm font-bold px-3 py-1 rounded-full shadow-lg';
    orderBadge.textContent = `#${orderNumber}`;
    imageContainer.appendChild(orderBadge);
    
    // Цена (правый верхний угол)
    const priceBadge = document.createElement('div');
    priceBadge.className = 'absolute top-4 right-4 bg-white text-gray-900 px-3 py-2 rounded-lg shadow-lg font-bold';
    priceBadge.textContent = `${property.price ? (property.price / 1000000).toFixed(1) + ' млн ₽' : 'Цена не указана'}`;
    imageContainer.appendChild(priceBadge);
    
    // Кэшбек (если есть)
    if (property.cashback && property.cashback > 0) {
        const cashbackBadge = document.createElement('div');
        cashbackBadge.className = 'absolute bottom-4 left-4 bg-green-500 text-white px-3 py-1 rounded-lg shadow-lg text-sm font-semibold';
        cashbackBadge.innerHTML = `
            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
            </svg>
            Кэшбек ${(property.cashback / 1000).toFixed(0)}к ₽
        `;
        imageContainer.appendChild(cashbackBadge);
    }
    
    // ================== ОСНОВНОЕ СОДЕРЖИМОЕ ==================
    const contentContainer = document.createElement('div');
    contentContainer.className = 'p-6';
    
    // Заголовок
    const title = document.createElement('h3');
    title.className = 'text-xl font-bold text-gray-900 mb-3 line-clamp-2';
    title.textContent = property.title || (property.rooms === 0 ? `Студия, ${property.area} м²` : `${property.rooms}-комнатная квартира, ${property.area} м²`);
    
    // ЖК
    const complex = document.createElement('div');
    complex.className = 'text-blue-600 font-semibold mb-4 text-lg';
    complex.textContent = property.complex_name || 'ЖК не указан';
    
    // Сетка основных характеристик  
    const characteristicsGrid = document.createElement('div');
    characteristicsGrid.className = 'grid grid-cols-2 gap-4 mb-4';
    
    // Площадь
    const areaItem = document.createElement('div');
    areaItem.className = 'flex items-center';
    areaItem.innerHTML = `
        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd"/>
            </svg>
        </div>
        <div>
            <div class="text-sm text-gray-500">Площадь</div>
            <div class="font-semibold">${property.area} м²</div>
        </div>
    `;
    
    // Этаж
    const floorItem = document.createElement('div');
    floorItem.className = 'flex items-center';
    floorItem.innerHTML = `
        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
            </svg>
        </div>
        <div>
            <div class="text-sm text-gray-500">Этаж</div>
            <div class="font-semibold">${property.floor}/${property.total_floors}</div>
        </div>
    `;
    
    characteristicsGrid.appendChild(areaItem);
    characteristicsGrid.appendChild(floorItem);
    
    // Цена за м²
    const pricePerSqm = document.createElement('div');
    pricePerSqm.className = 'bg-gray-50 rounded-lg p-4 mb-4';
    pricePerSqm.innerHTML = `
        <div class="flex items-center justify-between">
            <span class="text-gray-600">Цена за м²:</span>
            <span class="font-bold text-lg text-gray-900">${(property.price_per_sqm / 1000).toFixed(0)} тыс ₽</span>
        </div>
    `;
    
    // Адрес
    const address = document.createElement('div');
    address.className = 'flex items-start mb-4';
    address.innerHTML = `
        <svg class="w-5 h-5 text-gray-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
        </svg>
        <span class="text-gray-600 text-sm line-clamp-2">${property.address || 'Адрес не указан'}</span>
    `;
    
    // ================== КНОПКИ ДЕЙСТВИЙ ==================
    const actionsContainer = document.createElement('div');
    actionsContainer.className = 'flex gap-3 mt-6';
    
    // Основная кнопка "Подробнее"
    const detailsButton = document.createElement('button');
    detailsButton.className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center';
    detailsButton.innerHTML = `
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
        </svg>
        Подробнее
    `;
    detailsButton.onclick = () => {
        window.open(`/property/${property.property_id}`, '_blank');
    };
    
    // Кнопка PDF
    const pdfButton = document.createElement('button');
    pdfButton.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg transition-colors';
    pdfButton.innerHTML = `
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
    `;
    pdfButton.title = 'Скачать PDF';
    pdfButton.onclick = () => downloadPropertyPDF(property);
    
    // Кнопка избранное
    const favoriteButton = document.createElement('button');
    favoriteButton.className = 'border border-gray-300 hover:border-red-300 hover:bg-red-50 text-gray-600 hover:text-red-600 px-4 py-3 rounded-lg transition-colors';
    favoriteButton.innerHTML = `
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
        </svg>
    `;
    favoriteButton.title = 'В избранное';
    
    actionsContainer.appendChild(detailsButton);
    actionsContainer.appendChild(pdfButton);
    actionsContainer.appendChild(favoriteButton);
    
    // ================== СБОРКА КАРТОЧКИ ==================
    contentContainer.appendChild(title);
    contentContainer.appendChild(complex);
    contentContainer.appendChild(characteristicsGrid);
    contentContainer.appendChild(pricePerSqm);
    contentContainer.appendChild(address);
    contentContainer.appendChild(actionsContainer);
    
    card.appendChild(imageContainer);
    card.appendChild(contentContainer);
    
    return card;
}

// ============== ВСЕ ФУНКЦИИ ИЗ /manager/presentation/4 ===============

// Отправка презентации на email
async function sendToEmail(presentationId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/></svg>Отправляем...';
    button.disabled = true;
    
    try {
        const email = prompt('Введите email для отправки презентации:');
        if (!email) {
            button.innerHTML = originalText;
            button.disabled = false;
            return;
        }
        
        const response = await fetch(`/api/manager/presentation/${presentationId}/send-email`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('✅ Презентация отправлена на email!', 'success');
        } else {
            throw new Error(data.error || 'Не удалось отправить презентацию');
        }
        
    } catch (error) {
        console.error('Error sending email:', error);
        showNotification('Ошибка при отправке: ' + error.message, 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Скачать всю презентацию как ZIP
async function downloadAll(presentationId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/></svg>Генерируем...';
    button.disabled = true;
    
    try {
        const downloadUrl = `/api/manager/presentation/${presentationId}/download-all`;
        
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `presentation_${presentationId}_all_properties.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('✅ Скачивание началось!', 'success');
        
    } catch (error) {
        console.error('Error downloading all:', error);
        showNotification('Ошибка при скачивании: ' + error.message, 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Очистить всю презентацию
async function clearAll(presentationId) {
    if (!confirm('Вы уверены, что хотите удалить ВСЕ объекты из презентации? Это действие нельзя отменить.')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/></svg>Очищаем...';
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/manager/presentation/${presentationId}/clear-all`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('✅ Презентация очищена!', 'success');
            // Перезагрузить презентации
            selectSection('presentations');
        } else {
            throw new Error(data.error || 'Не удалось очистить презентацию');
        }
        
    } catch (error) {
        console.error('Error clearing all:', error);
        showNotification('Ошибка при очистке: ' + error.message, 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Добавить объект в презентацию
function addProperty(presentationId) {
    window.location.href = `/manager/properties?add_to_presentation=${presentationId}`;
}

// Скачать PDF объекта
function downloadPropertyPDF(presentationId, propertyId) {
    const downloadUrl = `/api/presentation/${presentationId}/property/${propertyId}/download`;
    
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `property_${propertyId}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('✅ Скачивание PDF началось!', 'success');
}

// Добавить комментарий к объекту
async function addComment(presentationId, propertyId) {
    const existingComment = document.querySelector(`[data-property-id="${propertyId}"] .manager-note`)?.textContent.replace('Комментарий: ', '') || '';
    
    const comment = prompt('Введите комментарий к объекту:', existingComment);
    if (comment === null) return;
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/></svg>';
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/comment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ comment: comment })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('Комментарий сохранен', 'success');
            button.innerHTML = comment.trim() ? 'Изменить комментарий' : 'Добавить комментарий';
        } else {
            throw new Error(data.error || 'Не удалось сохранить комментарий');
        }
        
    } catch (error) {
        console.error('Error adding comment:', error);
        showNotification('Ошибка при сохранении комментария: ' + error.message, 'error');
        button.innerHTML = originalText;
    } finally {
        button.disabled = false;
    }
}

// Удалить объект из презентации
async function removePropertyFromPresentation(presentationId, propertyId) {
    if (!confirm('Удалить этот объект из презентации?')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/></svg>';
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('✅ Объект удален из презентации!', 'success');
            // Удалить карточку из DOM
            const propertyCard = document.querySelector(`[data-property-id="${propertyId}"]`);
            if (propertyCard) {
                propertyCard.remove();
            }
        } else {
            throw new Error(data.error || 'Не удалось удалить объект');
        }
        
    } catch (error) {
        console.error('Error removing property:', error);
        showNotification('Ошибка при удалении: ' + error.message, 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Просмотр объекта
function viewFullPropertyManager(presentationId, propertyId) {
    window.open(`/property/${propertyId}`, '_blank');
}

// Функции социальных сетей
function shareToTelegram(link) {
    const text = encodeURIComponent(`Презентация недвижимости: ${link}`);
    window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${text}`, '_blank');
}

function shareToWhatsApp(link) {
    const text = encodeURIComponent(`Презентация недвижимости: ${link}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function shareToVK(link) {
    const url = encodeURIComponent(link);
    const title = encodeURIComponent('Презентация недвижимости');
    window.open(`https://vk.com/share.php?url=${url}&title=${title}`, '_blank');
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    showNotification('Скопировано в буфер обмена', 'success');
}

function viewPresentation(uniqueUrl) {
    window.open(`/presentation/view/${uniqueUrl}`, '_blank');
}

// ============== ПОЛНЫЙ ФУНКЦИОНАЛ ИЗ /manager/presentation/4 ===============

// Генерация ссылки на презентацию
function generatePresentationLink(presentationId) {
    console.log('🔗 Generating link for presentation:', presentationId);
    const linkUrl = `${window.location.origin}/manager/presentation/${presentationId}`;
    
    // Копируем в буфер обмена
    navigator.clipboard.writeText(linkUrl).then(() => {
        showNotification('✅ Ссылка скопирована в буфер обмена!', 'success');
    }).catch(() => {
        // Fallback для старых браузеров
        const textArea = document.createElement('textarea');
        textArea.value = linkUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('✅ Ссылка скопирована!', 'success');
    });
}

// Поделиться презентацией
function sharePresentation(presentationId) {
    console.log('📤 Sharing presentation:', presentationId);
    const shareUrl = `${window.location.origin}/manager/presentation/${presentationId}`;
    const shareText = 'Посмотрите эту подборку недвижимости от InBack';
    
    if (navigator.share) {
        // Нативное API поделиться (мобильные)
        navigator.share({
            title: shareText,
            url: shareUrl
        }).then(() => {
            showNotification('✅ Презентация отправлена!', 'success');
        }).catch(console.error);
    } else {
        // Кнопки социальных сетей
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 w-96 max-w-full mx-4">
                <h3 class="text-xl font-bold mb-4 text-center">Поделиться презентацией</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <a href="https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}" 
                       target="_blank" 
                       class="flex items-center justify-center bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                        </svg>
                        Telegram
                    </a>
                    <a href="https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}" 
                       target="_blank"
                       class="flex items-center justify-center bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                        </svg>
                        WhatsApp
                    </a>
                </div>
                <div class="border-t pt-4">
                    <label class="text-sm text-gray-600 block mb-2">Или скопируйте ссылку:</label>
                    <div class="flex">
                        <input type="text" value="${shareUrl}" readonly 
                               class="flex-1 px-3 py-2 border rounded-l-lg text-sm bg-gray-50">
                        <button onclick="copyShareLink('${shareUrl}')" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 transition-colors">
                            Копировать
                        </button>
                    </div>
                </div>
                <button onclick="this.closest('.fixed').remove()" 
                        class="w-full mt-4 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    Закрыть
                </button>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Закрытие по клику мимо
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }
}

// Копирование ссылки из модального окна
function copyShareLink(url) {
    navigator.clipboard.writeText(url).then(() => {
        showNotification('✅ Ссылка скопирована!', 'success');
    });
}

// Печать презентации
function printPresentation(presentationId) {
    console.log('🖨️ Printing presentation:', presentationId);
    const printUrl = `/manager/presentation/${presentationId}?print=true`;
    const printWindow = window.open(printUrl, '_blank');
    
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 1000);
    };
}

// Скачивание PDF презентации
function downloadPresentationPDF(presentationId) {
    console.log('📄 Downloading PDF for presentation:', presentationId);
    
    showNotification('⏳ Генерация PDF...', 'info');
    
    // Создаем ссылку для скачивания
    const downloadUrl = `/manager/presentation/${presentationId}/pdf`;
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `presentation_${presentationId}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => {
        showNotification('✅ PDF готов к скачиванию!', 'success');
    }, 2000);
}

// Скачивание PDF одного объекта
function downloadPropertyPDF(property) {
    console.log('📄 Downloading PDF for property:', property.property_id);
    
    showNotification('⏳ Генерация PDF...', 'info');
    
    const downloadUrl = `/property/${property.property_id}/pdf`;
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `property_${property.property_id}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => {
        showNotification('✅ PDF готов!', 'success');
    }, 1500);
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Функции для презентаций
async function sendPresentationToEmail(presentationId) {
    try {
        const email = prompt('Введите email для отправки презентации:');
        if (!email) return;
        
        showNotification('Отправляем презентацию на email...', 'info');
        
        const response = await fetch(`/api/manager/presentation/${presentationId}/send-email`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ email: email })
        });
        
        if (response.ok) {
            showNotification('Презентация отправлена на email!', 'success');
        } else {
            showNotification('Ошибка отправки на email', 'error');
        }
    } catch (error) {
        console.error('Error sending email:', error);
        showNotification('Ошибка отправки на email', 'error');
    }
}

async function downloadPresentationAll(presentationId) {
    try {
        showNotification('Генерируем файлы для скачивания...', 'info');
        
        const downloadUrl = `/api/manager/presentation/${presentationId}/download-all`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `presentation_${presentationId}_all.zip`;
        link.click();
        
        showNotification('Скачивание началось!', 'success');
    } catch (error) {
        console.error('Error downloading all:', error);
        showNotification('Ошибка скачивания файлов', 'error');
    }
}

async function sharePresentationLink(presentationId) {
    try {
        showNotification('Генерируем ссылку для презентации...', 'info');
        
        const response = await fetch(`/api/manager/presentation/${presentationId}/share-link`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.share_url) {
                // Копируем ссылку в буфер обмена
                navigator.clipboard.writeText(data.share_url).then(() => {
                    showNotification('Ссылка скопирована в буфер обмена!', 'success');
                }).catch(() => {
                    // Fallback для старых браузеров
                    prompt('Скопируйте ссылку:', data.share_url);
                });
            }
        } else {
            showNotification('Ошибка генерации ссылки', 'error');
        }
    } catch (error) {
        console.error('Error sharing link:', error);
        showNotification('Ошибка генерации ссылки', 'error');
    }
}

</script>


{% endblock %}